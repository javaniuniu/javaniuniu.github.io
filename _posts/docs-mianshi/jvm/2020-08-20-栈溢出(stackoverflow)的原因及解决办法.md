---
title: 栈溢出(stackoverflow)的原因及解决办法
permalink: /jvm/stackoverflow
tags: jvm
key: jvm-2020-08-20-01
---
__栈溢出(stackoverflow)__ 的原因及解决办法：程序功能大概有网络通信、数据库、绘图等。测试的时候程序一运行到某个函数就出现此错误，查了很多地方，试了很多解决办法，终于把问题解决了。
大家都知道,Windows程序的内存机制大概是这样的:
全局变量(局部的静态变量本质也属于此范围)存储于堆内存,该段内存较大,一般不会溢出;
函数地址、函数参数、局部变量等信息存储于栈内存;
程序中栈内存默认大小为1M,对于当前日益扩大的程序规模而言,稍有不慎就可能出问题。(动态申请的内存即new出来的内存不在栈中)即如果函数这样写

```java
voidtest_stack_overflow(){
  char\*chdata=new[2\*1024\*1024];
  delete[]chdata;
}
```
是不会出现这个错误的，而这样写则不行：
```java
voidtest_stack_overflow(){
  charchdata[2\*1024\*1024];
}
```
大多数情况下都会出现内存溢出的错误。出现__栈内存溢出的常见原因有2个__：

1. 函数调用层次过深,每调用一次,函数的参数、局部变量等信息就压一次栈。
2. 局部静态变量体积太大

第一种情况不太常见,因为很多情况下我们都用其他方法来代替递归调用(反正我是这么做的),所以只要不出现无限制的调用都应该是没有问题的,起码深度几十层我想是没问题的,这个我没试过但我想没有谁会把调用深度作那么多。

检查是否是此原因的方法为，在引起溢出的那个函数处设一个断点,然后执行程序使其停在断点处,然后按下快捷键Alt+7调出callstack窗口,在窗口中可以看到函数调用的层次关系。

第二种情况比较常见了,我就是犯了这个错误,我在函数里定义了一个局部变量,是一个类对象,该类中有一个大数组,大概是1.5M。

__解决办法大致说来也有两种__：

1. 增加栈内存的数目
2. 使用堆内存增加栈内存方法如下,在程序中依次选择Project->Setting->Link,在Category中选择output,在Reserve中输入16进制的栈内存大小如:0x10000000，然后点ok就可以了。

其他编译器也有类似的设置,个人认为这不是一个好办法,有一个致命原因,不知道有没有人遇到过,我把栈内存改大后,与数据库建立不了连接了(ADO方式,Acess数据库),把栈内存还原,问题立刻消失。不知道究竟是什么原因，有知道的可以告诉我。

第二种解决办法是比较可行的,具体实现由很多种方法可以直接把数组定义改成指针,然后动态申请内存;也可以把局部变量变成全局变量,一个偷懒的办法是直接在定义前边加个static,呵呵,直接变成静态变量(实质就是全局变量)。即可以把上例中的函数这么写：

```java
voidtest_stack_overflow(){
  staticcharchdata[2\*1024\*1024];
}
```

当然,除非万不得已,尽量不要使用这么大的数组，出现这种情况多半说明程序结构有问题。
