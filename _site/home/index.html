<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Home - JAVA 牛牛</title>

<meta name="description" content="">
<link rel="canonical" href="http://localhost:4000/home/"><link rel="alternate" type="application/rss+xml" title="JAVA 牛牛" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://use.fontawesome.com/releases/v5.0.13/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3,h4,h5,h6'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="256px" height="256px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve">  <image id="image0" width="256" height="256" x="0" y="0"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAABGdBTUEAALGPC/xhBQAAACBjSFJN
AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABklBMVEX///99Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxf///9O0pOeAAAAhHRS
TlMAAAQjKwgXLxOD7/efFFPXuzPDGHf7S4uvN/Mko3MwXN+rQGu/LH+nII8MsyiX6+NMx1hjtzhg
R8+Te1Bn518nb0PbHzuHENPLPDRo2IRXxT+bZEhUGz1ExCL60NwVoU9bHA/JYmyu6fFyaaLUrH2V
gAH1Ei1RQloHgakFtNUDduLohQ2rommNAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAALEwAACxMBAJqc
GAAAAAd0SU1FB+QFDgsyHesd3D4AABK2SURBVHja7V35V9tIEkbOOATbYMfYAQxMbHB8cNgh8YA5
TAgB48AsC4Fs9gZm7/u+71394WtzuD/JLanVXZLIG9UPeS9G6q761Ed1XT00FFJIIYUUUkghfWlJ
k6XIg0+i0i+T08PhR3IvygIQHYnpejwxGrTgNzSW1HU99dhHAKJp/ZqS40HL3qPMDTPZJ/4BMKHf
0mTQwndp6o6ZmMSAlAMgmrvrU58OWnxNm+kzM+sXAJ/2u9SfBi2+puX7zBT8AmCOATAftPiaFu8z
U/QLgGcMgFLQ4msaY6bsFwAV1mc1aPG1BcZMwi8ARlmfi0HLry0xZpb9AkCr9fusBy2/9pwBkPEN
gBXWaSVoADKMlxe+AbDMOn0ZNAANxstnvgGwyjqV2HpIKcKUsuyCbwCMMwCC1gXXGCdNiddlT4NJ
pb2HksqMk3UfAdhg3WaXgpR/nOmB+qaPAIAqpKeCBGCE8RGXMdBIW4RSgMBWcPLjAJA6mksDAOqH
Hh8ODICCrjYD5AHQmtB1K6idYBuYyEf8BQCHgJ58FYj8UzngQUIPVgJAm0QEWo8DkP9VCzmQ0ILU
AKjEEYHsju/yv44hA5KWGQUAtC3dQCuPfRU/OpI1TEKpFUANAFTCbvYh/yCIjO0aus5KnIPUAVhI
mhDQkxtTrr7Emy49dN/x3kjd1PGErAxKAGjjLX2A4s1CYqLkRNXJdJ5N4Vq+WN53fOea9hMzzfhA
pynJCaAKgLbEQSAASralJVAEQFuqq7OvTC2F45gqANr4QdDi67sqx1FlALSFRMDyd5QctOoAaNpq
TF0KeUqoRSlQAKCNz6jLIUl1qSMgNQCa9rYYiPjxCfnlnxYATTssxNUFcke5KkF4BhkAmjZ6VPQR
g3jqKUmIEiEAXYrOlcrNnJgEtYNiOdHVGauJxGQxKfjSjezNQmmOKkCLFoBbWqhUKmOfWwpQn/zK
8TPz6X30cHti0Xo7+epJ5ZaI47I8AaB7WCtl+YLkT1/YOROXVss1/ou5bW849QaABytcIZobIjrb
ZyO73LcLnsTkeQLAMW9Gt/bFLaeHy7zJUJ/6OACIVDnMFzfdHVij7zhnjKwHAUn0ALSLg5xPfirR
0BmnoYT0ud83AF4lacTv0dwgBEVl1c9jAPYGFvEVWWtdj84H1kPq4FxiAPbMy19NMZAykjFrl3Va
H4waAO+HT55sb2+/zHT/2X5y8mbVzG1CfcRWzPOg9bWpk+PtW1o7GZYwqioDEB0+HimvONoDa8+V
xe/RvJOeXF8pjxwPyynH7gEYnj8VtII1qDSXpaZQfweJefduancAvNmaFLb+ZAmDaKPCZrfY5NYb
rwAYHkmKstGl3Ac6+bu0lRXvOjniYiCIAvBmY1ecgy7lqQOHPrg5MOu7JdFxIARAZKzhSvrudKRP
pXHrgymOCWmNAgC0M67dP2k5X70DAu7GYHe/zAhswo4APKy6N3p/3Qv5Ne0b33TLSK7qqCQ4ANCu
Spj5vuWN/Jo2656XeNVhL7YFIJqRcXl8+zseyW8IChSmWMZWQ7IDYM1+0mXzxXI1s7r6Yu67+HPL
y1TCNcNesHG+urqzn3AyqeYvpAB4v2jTZKF0/qy/yBqChXLPPJTfFJuW78+1yvPZso1+uvjePQDz
VqM/uWw2axbxz+eeyq9pJezMGB3d3qx2LJjOWdqSLAAYb/BHfXpn0LB3iU+MeCy/puHAzD42/3X0
XYO/bDcsBgEfgDWubbpzxFtR26glpMlNVoP9YUhGmvPAwtMij/vamjAAkX3O+7H1Qz5D+HDMjwSi
t3gsuOQ+Utnn6W77vK/DAaDNGf6tHau9/QpH3KoP8kPmdpd2Lfa4yCpnC0txNMNBADhWzd131lsp
HlR9yiGMIoeWAaqRzUErAiekeQCAvYHBE5u3mdjTMB5zV/4AoL3FsWmj5jwdiOBq7TkBcGHWKRxi
EHAAyIVryxBGpNjFKEc3zJt5bswegDGz3WHF/lyPCRu7/pUUuYLPZJ8mcGVW57ImBIwAmOXPzTts
a7geqUbruCFUhy7tHzWHcJkQMABglr/jtKtFoXGZpD1pakPHHYdnR1N2CCAAeyb5q45aDWas+DkA
NG0Hej50eNYcrJDFlRAAGDaufzkBiSAMwNcBYBwCzknzH4xbWw6MpgyAceOeURewakIhCd9riYAC
mnNefaeNyk2dHdn7AESNBymh+FOwT9S9PwQYaRyG9YXz46Npo3h9zPoAGF0PYlZN0Db9LyUCGYMi
GZORgkHAfsLzHQDbEvJDMZ3sle8AnLHe4yLsmhC4i7m6BWDJsAAWxKyasBkHkT4Ma5aQE9aIQG4a
AYgYzg1pQZUO9oB3AQAAoUinQi9EGihlMwIAGOxMSUGnLpSSyQZRVQ6ORIKVXBYMZsMSA2AJFQXh
PODzYGeApsHmLuiJNCR53dQ9uAagiD+/Fe0fhqBEETMCgo1LNIz0ED918Q6AYxwY4mfapusPQEwv
OLuaE6EKrR/fABDNw2/iRp0FBmYtEPmxksuB8EuY8t07wA8ZQamJr2aH7C07ReTR5fJKPpZPTm64
CHSNvN5v7NZb+VT1wm5HAkVM2BZhMGLv9ACI4i8uSjFtGdqxoGHMI9ndEWPzYQms8rn1B5YPgmHI
6UTICNbunj1tyDAA3Fg119lrVtEwo+ZkqvqYc7uRHbMFY8QKN2DdRT0r1Id2tKEIKFRxN2b9BnvP
Yt5McbJKl50OTeOpwZeaFoPgA3tkX5xxNOTXI0O4BbhKwWYHzBb/gTGuj6por2aPcwOxWvyoJ1gF
Cy44Ryf78RAcE2OuwjrZJrDC/ftri7iuht0YGLUIRGvx42PZCcbJLobUhiUmPQS91AQXqWu6Yu/N
8P5esYytsKtB2bB66YA7cJhq29KEKbKNU3PI0E1LHAKwBnE9wkXdkvYsG92xfokLG9i8hcU/NjqM
hkz91PbfizUEhWV5u+CltSjWWkvbJiIny0s6AGVYTIGJbptdhkODPRX2RJoCPZTnErWN7rUyYZXs
XuJNNDAMimxgDzcGncZDvPAakThLKKnIUQPeGtqrFzuGFdHi8BgxsJdLFw0DgnfkBsSc0zJOypxt
KTZkMe2K8w5TAQCYG/wrlNzUm72/tw1Fb/jjFWaVntvqrkaRc4SEo+tkbJlAelDK6zzaGdKsUhz1
zoZdzPGWbd+wm93ZF8+h6WNuk2jpvp3xaKvnVE22/wpM+g2L2KFsqXcYesbPcrweIJM7ViCU7PqO
sj8y7fKU/cjX22BN78c0gekzKQXAwtqEZZD7yuGtQWTVrhJKLr3+cvgLU7PDW9+z6xtqHRf6P4IR
mas5wOEOXB3sx6wtAFsc/er9xUTaOsy+9a73yo1NMFpyCgmNHSz2qgNtzZZK64sHxpVzEACYzWBg
YbzwK9GyWbrCfoTz1KCIGeAiXtx/+frN9cr16M3e2Oxy0SIL+fbx0o3ee+cXaDtCYE2iADhVgecC
AFv9IAAlEfa44vdrLzDfYLskWxTp+wOMgZrIRvs0+5FfBR6mAJMVDLmDb0gCEK9yfIOaRb6uAP1g
gDEo+B7r9wVGVP6xs8Ee6Bs5p9hvu4NvnDryxqHYCPo9TSEyc2WJ8HiOXxA23cXbr3kCyxHflQzh
Jq1bCwCWa+MY3srOzJnp4Mh43BmIEhud77htk/M98dOkesJEtnDh5LueYcvTW9fq8h7uYJxw36JL
TuPlgfWKFyk6XXKXnMKZ0WeGBzqJScOKzAtw7VLU8FC9UDZs4Dz/q5s0tm63R0KBkte0lEm7aHjw
/YgthFYBpVW7l3imZxfzNZ3hH5es8wXa58uCAPM8c6s2z+9a2YTG7QTi2H1HdTHKLb67sujSIWdo
dHMiJaAfcASK2Kwk1sFHG9Yv8ZTHT3VnyqXsS+4IpM1dne2sLzYRh1qzUNr8Ifs/zzP2zDKNxcaN
ZQ1bnXeAPGd/T6UG+2s1qu8c81dcpM6OV5bmujRdiZi/FveTnluIsmJnFq5YKGM57nEfWHje5e/D
6sZE4pomSqvPn4lFecjXDwAB+c7hee45pGkffcXPD83xXdagBki7Z+UBgAl4yn9ikzMLGk7fpcIx
puUtzD1swmQDKKoK6q6VUX7a7OWJCZSfju6bR86Mlb+CbRpJ53bJAQB1N275zCYaW2ITYimF0wnY
DrPWNWjgyCV/6x9NcXWbtXY6s9hDKtdZ3hR3u7RXEwddELLJwpENZmCYlk9WUwAAXGwSFxwREBye
5LMVFQCAbSCYG9dghZG/4EEBADBwrAQCANtkcvKNqNQRYsqh1P0uqgT7sMJtVyoAgBlbpVyWLIFn
Qrq2vBoAYJHz/3oJg7lUIVtFBQBIZQ/i9l0wu10FA0AbdBz/5Ye7rvIKzSgVUwO1XbZkoDxBhoPK
dW9KAFSDXARgCVAJ1lcCYJPx0PAdAPBnBna/ACwCvmsCcBJyESBFDAD6rWhrpzkT1BSaUWlHDQAI
aVDQRaQIDgJKZRvUAIBYVXmThBQtgMkgwCs2osCGvzfujbGO1ZJ2FavKNhgf/qbNQNyEizhpegCO
GB9ptZbcUQTciMJJTl4AABHDvqbOQQhKTS1rWbWwMmjDft7BDTqo0iaoDkBA6bOgBioWL1MF4NNA
5gBE4golTnsIAGZu+TcHYAaoWiKUAQDjuG/30GNUtWrlCmUA0Ed/5RMAa3QzgKC8PsyBDZ8AmKGb
AQQAwBzw6TyA5wDl2i3qAGApGfH8TRUCY1hOuYIvwQ0ToAutq7cmQBDApqgF0QAAOScxP+xCEItP
YIYhAAAr+nh0H5aBwClMUL2I4pIVOBP7oArgQZDADEUBwDmMSW/LKvcITCEUlSsoAEDFzPtlME07
3kjuGcJ0L+qboMyEmidFEVsSAHBd9uA+NANBRiLJnkNz0xTYqD3WBttx4ulGAwD4yERq2ylQhnYJ
pAIA63B4uhNixRcadyTRZWv4Ybz0lNMXMSUCYBSmZlm9OUsCZ2SepoYl1XV7kCWV9c5HdAEDgCgi
gQoA3AlVAjbsCQ6eMaKrbMguXJz0YQiAKUzRIeYBAFj9wKvI2SKATHWXDd2Vm5DuE7/yRP4TL6YZ
HQCbXrBnoI4Xs4zw0tWmF/wBXXiCMCEAOAS80AUwmYhO2aK8dheT7+mLbKIhhDAylxIAHAI/ylPT
j73RtkkvXha7HFadKNdYUgDO1GUTIdIllvbq7aIvAJxSskwLwGcuLseVphjphYbEl6//xAcAfkrK
MTEAEreCuqYV0sssaAEYl6/G5IJI/W+0AFTVpROgXcohQArAgqvrseVJoDxzMABAJp9+UJSnA44i
iIUVKHPUSAEogvzU1+7g/RiU6SmUALRBCxC69sQVYY0dwvQUjw5D4vX+xQmquROG5lMCAE5iLwLm
wOp4ej8BAMOwF94hKFRKmKRHCQA7DRvy+SOXi7udqnOlYiNN/eznn//izPAT22QJ/Y+UALBsZkzj
Wbjxnefcbd6/vGnoV/z27z0AyOBdtaO4m/Ch79+19OuPHgAW0lIQb+k3fXf7b3/3sQOQYeqLeEu/
Z+vdHz52ACCmR9yQ8Uf20tbHDgBkuYtf4RICEAIQAhACEAIQAhACEAIQAhACEAIQAhACEAIQAhAC
EAIQAhACEALwsQIAlZbEW3rMXvrTxw4AKznootran1mw1QOH9u89ACzNwU3MxF/uXvor/Oh0X+E9
AgA/9vStm8tVltPf/n7z0j+gPBeUcC3cTwAsrmMfXc7pesdlnuc///VvXf/Pf/8HP0EoNmFWFiUA
kENu8oJdyST5PTQ1AkGIR/cTAG8LTWOC9j1NmHjKOPQgSApypnKEMXiUAEB9TYurlVUI0lEoU7JI
AyWhvkmLurriS0BXsYikdwDgPeYp2lDRVxCGXKOsV0UKQBuj5VOEY2BhG0OFqfKm6QHA0nrdD1Xd
o5H+ctJwE2X8HqfMjJoSJurV14oz4ZFJel3lWi3vAeBcNVqbufxCtrUHs8XBLKw8UeUEbwDAwmp9
yqYzU64HwsKTdf7NtWduW/IXgPE8l2s9NrkzLC7869KKVQIe6QroAQDaknXaTC61f/He6f1PLtc7
NtmHi9SJGOQAaG9ruh3F0uvzT15xdvKFTy5mEx2HrKM07QLgCQDaksjF3a2DYvm0dEMjiZlisibw
kj5D/f09AUAbLYgI455iW+q8+QKApj2vq4trpt0NUgXIWwC0yIdToTEtLP2IVxXKPAKAFIPmBn1B
Dh8A6GHwdl/wAntLiqfmr7xk0VsAejQ934jLSp9f3iTf9nwHoEvROWvFzpJi5SNfbi7yA4AeLZxt
LArn1idnjjyc9cEAcE1LLyYW7TfIbLM8+8HryrzBAXBN7cPz2eVGJ280cuTThYmd50v0mt79A6BP
kUqX5uYOK5Wr4JjQhkIKKaSQQgoppC8t/R/dov80OkxKRAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAy
MC0wNS0xNFQxMTo1MDoyOSswMDowMIfyupMAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMDUtMTRU
MTE6NTA6MjkrMDA6MDD2rwIvAAAAAElFTkSuQmCC" />
</svg>
<a title="主要是想看下自己还能在多做些什么
" href="/">JAVA 牛牛</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item navigation__item--active"><a href="/home/">Home</a></li><li class="navigation__item"><a href="/module.html">模块</a></li><li class="navigation__item"><a href="/leetcode/all">leetcode(力扣)</a></li><li class="navigation__item"><a href="/algo/all">algo(算法)</a></li><li class="navigation__item"><a href="/docker/about">Docker</a></li><li class="navigation__item"><a href="/todo">TODO</a></li><li class="navigation__item"><a href="/pm">PM</a></li><li class="navigation__item"><a href="/archive.html">Archive</a></li><li class="navigation__item"><a href="/about.html">About</a></li><li class="navigation__item"><a href="https://github.com/javaniuniu">GitHub</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/WebPage"><header style="display:none;"><h1>Home</h1></header><meta itemprop="headline" content="Home"><meta itemprop="author" content="java牛牛"/><div class="js-article-content"><div class="layout--articles"><div class="article-list items items--divided"><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/002"><h2 itemprop="headline" class="item__header">MYSQL调优----如何设置合理的数据库连接池的大小</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h2 id="一前言">一、前言</h2>

<p>基本上来说，大部分项目都需要跟数据库做交互，那么，数据库连接池的大小设置成多大合适呢？</p>

<p>一些开发老鸟可能还会告诉你：<strong>没关系，尽量设置的大些，比如设置成 200，这样数据库性能会高些，吞吐量也会大些！</strong></p>

<p>你也许会点头称是，真的是这样吗？看完这篇文章，也许会颠覆你的认知哦！</p>

<h2 id="二正菜开始">二、正菜开始</h2>

<p>可以很直接的说，关于数据库连接池大小的设置，每个开发者都可能在一环节掉进坑里，事实上呢，大部分程序员可能都会依靠自己的直觉去设置它的大小，设置成 100 ？思量许久后，自顾自想，应该差不多吧？</p>

<h2 id="三假设你的服务有1万并发的访问">三、假设你的服务有1万并发的访问</h2>

<p>不妨意淫一下，你手里有个网站，并发压力虽然还没到 Facebook 那个级别，但是呢？也有个1万上下的并发量！也就是说差不多2万左右的 TPS。</p>

<p>那么问题来了！<strong>这个网站的数据库连接池应该设置成多大合适呢？</strong></p>

<p>其实这个问法本身就是有问题的，我们需要反过来问，正确问法应该是：</p>

<p><strong>“这个网站的数据库连接池应该设置成多小合适呢？”</strong></p>

<blockquote>
  <p>PS: 这里有一个 Oracle 性能小组发布的简短视频，链接地址为 https://www.youtube.com/watch?v=xNDnVOCdvQ0，友情提示，需要科学上网才能访问哦！</p>
</blockquote>

<p>口述一下，视频中对 Oracle 数据库进行了压力测试，模拟 9600 个并发线程来操作数据库，每两次数据库操作之间 sleep 550ms，注意，视频中刚开始设置的线程池大小为 2048。</p>

<p>让我们来看看数据库连接池的大小为 2048 性能测试结果的鬼样子：</p>

<p><strong>每个请求要在连接池队列里等待 33ms，获得连接之后，执行SQL需要耗时77ms, CPU 消耗维持在 95% 左右；</strong></p>

<p>接下来，我们将连接池的大小改小点，设置成 1024，其他测试参数不变，结果咋样？</p>

<p><strong>“这里，获取连接等待时长基本不变，但是 SQL 的执行耗时降低了！”</strong></p>

<p>哎呦，有长进哦！</p>

<p>接下来，我们再设置小些，连接池的大小降低到 96，并发数等其他参数不变，看看结果如何：</p>

<p><strong>每个请求在连接池队列中的平均等待时间为 1ms, SQL 执行耗时为 2ms</strong>.</p>

<p>我去！什么鬼？</p>

<p><strong>我们没调整任何东西，仅仅只是将数据库连接池的大小降低了，这样，就能把之前平均 100ms 响应时间缩短到了 3ms。吞吐量指数级上升啊！</strong></p>

<p>你这也太溜了！</p>

<h2 id="四为啥有这种效果">四、为啥有这种效果?</h2>

<p>我们不妨想一下，为啥 Nginx 内部仅仅使用了 4 个线程，其性能就大大超越了 100 个进程的 Apache HTTPD 呢？追究其原因的话，回想一下计算机科学的基础知识，答案其实非常明显。</p>

<p>要知道，即使是单核 CPU 的计算机也能“同时”运行着数百个线程。但我们其实都知道，这只不过是操作系统快速切换时间片，跟我们玩的一个小把戏罢了。</p>

<p>一核 CPU同一时刻只能执行一个线程，然后操作系统切换上下文，CPU 核心快速调度，执行另一个线程的代码，不停反复，给我们造成了所有进程同时运行假象。</p>

<p>其实，在一核 CPU 的机器上，顺序执行<strong>A</strong>和<strong>B</strong>永远比通过时间分片切换“同时”执行<strong>A</strong>和<strong>B</strong>要快，其中原因，学过操作系统这门课程的童鞋应该很清楚。一旦线程的数量超过了 CPU 核心的数量，再增加线程数系统就只会更慢，而不是更快，因为这里涉及到上下文切换耗费的额外的性能。</p>

<p>说到这里，你应该恍然大悟了 ……</p>

<h2 id="五其他应该考虑到的因素">五、其他应该考虑到的因素</h2>

<p>上小节中说到了主要原因，但其实没有这么简单，我们还需要考虑到一些其他的因素。</p>

<p>当我们在寻找数据库的性能瓶颈时，大致可归为三类：</p>

<ul>
  <li><strong>CPU</strong></li>
  <li><strong>磁盘 IO</strong></li>
  <li><strong>网络 IO</strong></li>
</ul>

<p>也许你会说，还有内存这一因素？内存的确是需要考虑的，但是比起<strong>磁盘IO</strong>和<strong>网络IO</strong>，稍显微不足道，这里就不加了。</p>

<p>假设我们不考虑磁盘 IO 和网络 IO，就很好定论了，在一个 8 核的服务器上，数据库连接数/线程数设置为 8 能够提供最优的性能，如果再增加连接数，反而会因为上下文切换导致性能下降。</p>

<p>大家都知道，数据库通常把数据存储在磁盘上，而磁盘呢，通常是由一些旋转着的金属碟片和一个装在步进马达上的读写头组成的。读/写头同一时刻只能出现在一个位置，当它需要再次执行读写操作时，它必须“寻址”到另外一个位置才能完成任务。所以呢？这里就有了<strong>寻址的耗时</strong>，此外还有<strong>旋转耗时</strong>，读写头需要等待磁盘碟片上的目标数据“旋转到位”才能进行读写操作。使用缓存当然是能够提升性能的，但上述原理仍然适用。</p>

<p>在这段（”I/O等待”）时间内，线程是处于“阻塞”等待状态，也就是说没干啥正事！此时操作系统可以将这个空闲的CPU 核心用于服务其他线程。</p>

<p>这里我们可以总结一下，当你的线程处理的是 I/O 密集型业务时，便可以让线程/连接数设置的比 CPU核心大一些，这样就能够在同样的时间内，完成更多的工作，提升吞吐量。</p>

<p>那么问题又来了？</p>

<p>大小设置成多少合适呢？</p>

<p>这要取决于<strong>磁盘</strong>，如果你使用的是 SSD 固态硬盘，它不需要寻址，也不需要旋转碟片。打住打住！！！你千万可别理所当然的认为：“<strong>既然SSD速度更快，我们把线程数的大小设置的大些吧！！</strong>”</p>

<p>结论正好相反！无需寻址和没有旋回耗时的确意味着<strong>更少的阻塞</strong>，所以更少的线程（更接近于CPU核心数）会发挥出更高的性能。只有当阻塞密集时，更多的线程数才能发挥出更好的性能。</p>

<p>上面我们已经说过了磁盘 IO, 接下来我们谈谈网络 IO！</p>

<p>网络 IO 其实也是非常相似的。通过以太网接口读写数据时也会造成阻塞，10G带宽会比1G带宽的阻塞耗时少一些，而 1G 带宽又会比 100M 带宽的阻塞少一些。通常情况下，我们把网络 IO 放在第三顺位来考虑，然而有些人会在性能计算中忽略网络 IO 带来的影响。</p>

<p>上图是 PostgreSQL 的基准性能测试数据，从图中我们可以看到，TPS 在连接数达到 50 时开始变缓。回过头来想下，在上面 Oracle 的性能测试视频中，测试人员们将连接数从 2048 降到了 96，实际上 96 还是太高了，除非你的服务器 CPU 核心数有 16 或 32。</p>

<h2 id="六连接数计算公式">六、连接数计算公式</h2>

<p>下面公式由 PostgreSQL 提供，不过底层原理是不变的，它适用于市面上绝大部分数据库产品。还有，你应该模拟预期的访问量，并通过下面的公式先设置一个偏合理的值，然后在实际的测试中，通过微调，来寻找最合适的连接数大小。</p>

<p><strong>连接数 = ((核心数 * 2) + 有效磁盘数)</strong></p>

<blockquote>
  <p>核心数不应包含超线程(hyper thread)，即使打开了超线程也是如此，如果热点数据全被缓存了，那么有效磁盘数实际是0，随着缓存命中率的下降，有效磁盘数也逐渐趋近于实际的磁盘数。另外需要注意，这一公式作用于SSD 的效果如何，尚未明了。</p>
</blockquote>

<p>好了，按照这个公式，如果说你的服务器 CPU 是 4核 i7 的，连接池大小应该为 <code class="language-plaintext highlighter-rouge">((4*2)+1)=9</code>。</p>

<p>取个整, 我们就设置为 10 吧。你这个行不行啊？10 也太小了吧！</p>

<p>你要是觉得不太行的话，可以跑个性能测试看看，我们可以保证，它能轻松支撑 3000 用户以 6000 TPS 的速率并发执行简单查询的场景。你还可以将连接池大小超过 10，那时，你会看到响应时长开始增加，TPS 开始下降。</p>

<h2 id="七结论你需要的是一个小连接池和一个等待连接的线程队列">七、结论：你需要的是一个小连接池，和一个等待连接的线程队列</h2>

<p>假设说你有 10000 个并发访问，而你设置了连接池大小为 10000，你怕是石乐志哦。</p>

<p>改成 1000，太高？改成 100？还是太多了。</p>

<p>你仅仅需要一个大小为 10 数据库连接池，然后让剩下的业务线程都在队列里等待就可以了。</p>

<blockquote>
  <p>连接池中的连接数量大小应该设置成：数据库能够有效同时进行的查询任务数（通常情况下来说不会高于 2*CPU核心数）。</p>
</blockquote>

<p>你应该经常会看到一些用户量不是很大的 web 应用中，为应付大约十来个的并发，却将数据库连接池设置成 100， 200 的情况。请不要过度配置您的数据库连接池的大小。</p>

<h2 id="八额外需要注意的点">八、额外需要注意的点</h2>

<p>实际上，连接池的大小的设置还是要结合实际的业务场景来说事。</p>

<p>比如说，你的系统同时混合了<strong>长事务</strong>和<strong>短事务</strong>，这时，根据上面的公式来计算就很难办了。正确的做法应该是创建两个连接池，一个服务于长事务，一个服务于”实时”查询，也就是短事务。</p>

<p>还有一种情况，比方说一个系统执行一个任务队列，业务上要求同一时间内只允许执行一定数量的任务，这时，我们就应该让并发任务数去适配连接池连接数，而不是连接数大小去适配并发任务数。</p>

<h2 id="ref">Ref</h2>

<p>https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing</p>
</div><p><a href="/mysql/002">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E8%B0%83%E4%BC%98">调优</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=MYSQL%E8%B0%83%E4%BC%98">MYSQL调优</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jul 02, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-07-02-001">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-07-02T00:00:00+08:00">
    <meta itemprop="keywords" content="调优,MYSQL调优"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mianshi/ArrayList/01"><h2 itemprop="headline" class="item__header">ArrayList循环遍历并删除元素的常见陷阱</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><p>在工作和学习中，经常碰到删除ArrayList里面的某个元素，看似一个很简单的问题，却很容易出bug。不妨把这个问题当做一道面试题目，我想一定能难道不少的人。今天就给大家说一下在ArrayList循环遍历并删除元素的问题。首先请看下面的例子：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListRemove</span>
<span class="o">{</span>
<span class="err">　　</span><span class="n">publicstaticvoidmain</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span><span class="n">args</span><span class="o">)</span>
<span class="err">　　</span><span class="o">{</span>
<span class="err">　　　　</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span><span class="n">list</span><span class="o">=</span><span class="n">newArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
<span class="err">　　　　</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
<span class="err">　　　　</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"b"</span><span class="o">);</span>
<span class="err">　　　　</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"b"</span><span class="o">);</span>
<span class="err">　　　　</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
<span class="err">　　　　</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
<span class="err">　　　　</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"c"</span><span class="o">);</span>
<span class="err">　　　　</span><span class="n">remove</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
<span class="err">　　　　</span><span class="k">for</span><span class="o">(</span><span class="nl">Strings:</span><span class="n">list</span><span class="o">)</span>
<span class="err">　　　　</span><span class="o">{</span>
<span class="err">　　　　　　</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"element : "</span><span class="o">+</span><span class="n">s</span><span class="o">);</span>
<span class="err">　　　　</span><span class="o">}</span>
<span class="err">　　</span><span class="o">}</span>
<span class="err">　　</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span>
<span class="err">　　</span><span class="o">{</span>
<span class="err">　　</span><span class="c1">// TODO:</span>
<span class="err">　　</span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>如果要想删除list的b字符，有下面两种常见的错误例子：</p>

<h5 id="错误写法实例一">错误写法实例一：</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="n">inti</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++)</span>
    <span class="o">{</span>
        <span class="nc">Strings</span><span class="o">=</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span>
        <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>错误的原因：这种最普通的循环写法执行后会发现第二个“b”的字符串没有删掉</strong>。</p>

<h5 id="错误写法实例二">错误写法实例二：</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="nl">Strings:</span><span class="n">list</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span>
        <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>错误的原因：这种for-each写法会报出著名的并发修改异常：java.util.ConcurrentModificationException。</strong></p>

<p>先解释一下实例一的错误原因。翻开JDK的ArrayList源码，先看下ArrayList中的remove方法（注意ArrayList中的remove有两个同名方法，只是入参不同，这里看的是入参为Object的remove方法）是怎么实现的：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Objecto</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">o</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
        <span class="k">for</span><span class="o">(</span><span class="n">intindex</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">index</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">index</span><span class="o">++)</span>
            <span class="k">if</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]==</span><span class="kc">null</span><span class="o">){</span>
                <span class="n">fastRemove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="n">intindex</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">index</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">index</span><span class="o">++)</span>
                <span class="k">if</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">])){</span>
                <span class="n">fastRemove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>            
</code></pre></div></div>

<p>一般情况下程序的执行路径会走到else路径下最终调用faseRemove方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">fastRemove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">){</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="n">intnumMoved</span><span class="o">=</span><span class="n">size</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="k">if</span><span class="o">(</span><span class="n">numMoved</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span>             
        <span class="err">　　</span><span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">elementData</span><span class="o">,</span><span class="n">index</span><span class="o">,</span><span class="n">numMoved</span><span class="o">);</span>
        <span class="n">elementData</span><span class="o">[--</span><span class="n">size</span><span class="o">]=</span><span class="kc">null</span><span class="o">;</span><span class="c1">// Let gc do its work</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>可以看到会执行System.arraycopy方法，导致删除元素时涉及到数组元素的移动</strong>。针对错误写法一，在遍历第一个字符串b时因为符合删除条件，所以将该元素从数组中删除，并且将后一个元素移动（也就是第二个字符串b）至当前位置，导致下一次循环遍历时后一个字符串b并没有遍历到，所以无法删除。针对这种情况可以倒序删除的方式来避免：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="n">inti</span><span class="o">=</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span><span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">--)</span>
    <span class="o">{</span>
        <span class="nc">Strings</span><span class="o">=</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span>
        <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>因为数组倒序遍历时即使发生元素删除也不影响后序元素遍历。</p>

<p><strong>接着解释一下实例二的错误原因。错误二产生的原因却是foreach写法是对实际的Iterable、hasNext、next方法的简写，问题同样处在上文的fastRemove方法中，可以看到第一行把modCount变量的值加一，但在ArrayList返回的迭代器（该代码在其父类AbstractList中）</strong>：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Itr</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里返回的是AbstractList类内部的迭代器实现private class Itr implements Iterator，看这个类的next方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">checkForComodification</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="no">E</span> <span class="n">next</span> <span class="o">=</span> <span class="n">get</span><span class="o">(</span><span class="n">cursor</span><span class="o">);</span>
            <span class="n">lastRet</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">++;</span>
            <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>第一行checkForComodification方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这里会做迭代器内部修改次数检查，因为上面的remove(Object)方法修改了modCount的值，所以才会报出并发修改异常。要避免这种情况的出现则在使用迭代器迭代时（显示或for-each的隐式）不要使用ArrayList的remove，<strong>改为用Iterator的remove即可</strong>。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> 
    <span class="o">{</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> 
        <span class="o">{</span>
            <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"b"</span><span class="o">))</span> 
            <span class="o">{</span>
                <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
</div><p><a href="/mianshi/ArrayList/01">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E9%9D%A2%E8%AF%95%E9%A2%98">面试题</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jul 02, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mianshi-2020-07-02">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-07-02T00:00:00+08:00">
    <meta itemprop="keywords" content="面试题"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/java/map"><h2 itemprop="headline" class="item__header">Map</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody">
</div><p><a href="/java/map">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=map">map</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="java-map-2020-06-30-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-30T00:00:00+08:00">
    <meta itemprop="keywords" content="map"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/java/nio/bio"><h2 itemprop="headline" class="item__header">怎样理解阻塞非阻塞与同步异步的区别</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><p><strong>同步异步关注的是消息通信机制</strong><br />
<strong>阻塞非阻塞关注的是等待信息是的状态</strong></p>

<hr />

<p>老张爱喝茶，废话不说，煮开水。 <br />
出场人物：老张，水壶两把（普通水壶，简称水壶；会响的水壶，简称响水壶）。  <br />
1 老张把水壶放到火上，立等水开。<strong>（同步阻塞）</strong> <br />
老张觉得自己有点傻 <br />
2 老张把水壶放到火上，去客厅看电视，时不时去厨房看看水开没有。<strong>（同步非阻塞）</strong>   <br />
老张还是觉得自己有点傻，于是变高端了，买了把会响笛的那种水壶。水开之后，能大声发出嘀~~~~的噪音。  <br />
3 老张把响水壶放到火上，立等水开。<strong>（异步阻塞）</strong>  <br />
老张觉得这样傻等意义不大  <br />
4 老张把响水壶放到火上，去客厅看电视，水壶响之前不再去看它了，响了再去拿壶。<strong>（异步非阻塞）</strong>  <br />
老张觉得自己聪明了。</p>

<p>所谓同步异步，只是对于水壶而言。  <br />
普通水壶，同步；响水壶，异步。 <br />
虽然都能干活，但响水壶可以在自己完工之后，提示老张水开了。这是普通水壶所不能及的。 <br />
同步只能让调用者去轮询自己（情况2中），造成老张效率的低下。</p>

<p>所谓阻塞非阻塞，仅仅对于老张而言。 <br />
立等的老张，阻塞；看电视的老张，非阻塞。  <br />
情况1和情况3中老张就是阻塞的，媳妇喊他都不知道。虽然3中响水壶是异步的，可对于立等的老张没有太大的意义。所以一般异步是配合非阻塞使用的，这样才能发挥异步的效用。</p>
</div><p><a href="/java/nio/bio">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E9%98%BB%E5%A1%9E%E9%9D%9E%E9%98%BB%E5%A1%9E%E4%B8%8E%E5%90%8C%E6%AD%A5%E5%BC%82%E6%AD%A5%E7%9A%84%E5%8C%BA%E5%88%AB">阻塞非阻塞与同步异步的区别</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="java-io-2020-06-29-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-29T00:00:00+08:00">
    <meta itemprop="keywords" content="阻塞非阻塞与同步异步的区别"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/Index"><h2 itemprop="headline" class="item__header">索引简介</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="索引定义">索引定义</h3>
<p>官方定义：索引（Index） 是帮助MySQL高效获取数据的数据结构。
大家一定很好奇，索引为什么是一种数据结构，它又是怎么提高查询的速度？我们拿最常用的二叉树来分析索引的工作原理。看下面的图片：</p>

<p><img src="/assets/images/mysql/0622/806956-20180103215956799-1078068423.png" alt="1" /></p>

<p><strong>创建索引的优势</strong></p>
<ol>
  <li>提高数据的检索速度，降低数据库IO成本：使用索引的意义就是通过缩小表中需要查询的记录的数目从而加快搜索的速度。</li>
  <li>降低数据排序的成本，降低CPU消耗：索引之所以查的快，是因为先将数据排好序，若该字段正好需要排序，则真好降低了排序的成本。</li>
</ol>

<p><strong>创建索引的劣势</strong></p>
<ol>
  <li>占用存储空间：索引实际上也是一张表，记录了主键与索引字段，一般以索引文件的形式存储在磁盘上。</li>
  <li>降低更新表的速度：表的数据发生了变化，对应的索引也需要一起变更，从而减低的更新速度。否则索引指向的物理数据可能不对，这也是索引失效的原因之一。</li>
  <li>优质索引创建难：索引的创建并非一日之功，也并非一直不变。需要频繁根据用户的行为和具体的业务逻辑去创建最佳的索引。</li>
</ol>

<h3 id="索引分类">索引分类</h3>
<p>我们常说的索引一般指的是BTree（多路搜索树）结构组织的索引。其中还有聚合索引，次要索引，复合索引，前缀索引，唯一索引，统称索引，当然除了B+树外，还有哈希索引（hash index）等。</p>

<ul>
  <li><strong>单值索引</strong>：一个索引只包含单个列，一个表可以有多个单列索引</li>
  <li><strong>唯一索引</strong>：索引列的值必须唯一，但允许有空值</li>
  <li><strong>复合索引</strong>：一个索引包含多个列，实际开发中推荐使用</li>
</ul>

<p>实际开发中推荐使用复合索引，并且单表创建的索引个数建议不要超过五个</p>

<h4 id="基本语法">基本语法：</h4>
<p><strong>创建：</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">create</span><span class="w"> </span><span class="p">[</span><span class="kt">unique</span><span class="p">]</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">indexName</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">tableName</span><span class="w"> </span><span class="p">(</span><span class="nf">columnName...</span><span class="p">)</span><span class="w">
</span><span class="nf">alter</span><span class="w"> </span><span class="nx">tableName</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="p">[</span><span class="kt">unique</span><span class="p">]</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">[</span><span class="kt">indexName</span><span class="p">]</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="p">(</span><span class="nf">columnName...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>删除：</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">drop</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">[</span><span class="kt">indexName</span><span class="p">]</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">tableName</span><span class="w">
</span></code></pre></div></div>
<p><strong>查看：</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">show</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">tableName</span><span class="w">
</span></code></pre></div></div>

<h4 id="哪些情况需要建索引">哪些情况需要建索引：</h4>
<ol>
  <li>主键，唯一索引</li>
  <li>经常用作查询条件的字段需要创建索引</li>
  <li>经常需要排序、分组和统计的字段需要建立索引</li>
  <li>查询中与其他表关联的字段，外键关系建立索引</li>
</ol>

<h4 id="哪些情况不要建索引">哪些情况不要建索引：</h4>
<ol>
  <li>表的记录太少，百万级以下的数据不需要创建索引</li>
  <li>经常增删改的表不需要创建索引</li>
  <li>数据重复且分布平均的字段不需要创建索引，如 true,false 之类。</li>
  <li>频发更新的字段不适合创建索引</li>
  <li>where条件里用不到的字段不需要创建索引</li>
</ol>

<h3 id="性能分析">性能分析</h3>
<h4 id="mysql-自身瓶颈">MySQL 自身瓶颈</h4>

<p>MySQL自身参见的性能问题有磁盘空间不足，磁盘I/O太大，服务器硬件性能低。</p>
<ol>
  <li>CPU：CPU 在饱和的时候一般发生在数据装入内存或从磁盘上读取数据时候</li>
  <li>IO：磁盘I/O 瓶颈发生在装入数据远大于内存容量的时候</li>
  <li>服务器硬件的性能瓶颈：top,free,iostat 和 vmstat来查看系统的性能状态</li>
</ol>

<h4 id="explain-分析sql语句">explain 分析sql语句</h4>

<p>使用explain关键字可以模拟优化器执行sql查询语句，从而得知MySQL 是如何处理sql语句。</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">-----</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">-----</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p><strong>id</strong></p>

<p>select 查询的序列号，包含一组可以重复的数字，表示查询中执行sql语句的顺序。一般有三种情况：  <br />
第一种：id全部相同，sql的执行顺序是由上至下； <br />
第二种：id全部不同，sql的执行顺序是根据id大的优先执行； <br />
第三种：id既存在相同，又存在不同的。先根据id大的优先执行，再根据相同id从上至下的执行。</p>

<p><strong>select_type</strong></p>

<p>select 查询的类型，主要是用于区别普通查询，联合查询，嵌套的复杂查询</p>
<ul>
  <li><strong>simple</strong>：简单的select 查询，查询中不包含子查询或者union</li>
  <li><strong>primary</strong>：查询中若包含任何复杂的子查询，最外层查询则被标记为primary</li>
  <li><strong>subquery</strong>：在select或where 列表中包含了子查询</li>
  <li><strong>derived</strong>：在from列表中包含的子查询被标记为derived（衍生）MySQL会递归执行这些子查询，把结果放在临时表里。</li>
  <li><strong>union</strong>：若第二个select出现在union之后，则被标记为union，若union包含在from子句的子查询中，外层select将被标记为：derived</li>
  <li><strong>union result</strong>：从union表获取结果的select</li>
</ul>

<p><strong>partitions</strong></p>

<p>表所使用的分区，如果要统计十年公司订单的金额，可以把数据分为十个区，每一年代表一个区。这样可以大大的提高查询效率。</p>

<p><strong>type</strong></p>

<p>这是一个非常重要的参数，连接类型，常见的有：all , index , range , ref , eq_ref , const , system , null 八个级别。
性能从最优到最差的排序：<strong>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all</strong>
对java程序员来说，若保证查询至少达到range级别或者最好能达到ref则算是一个优秀而又负责的程序员。</p>
<ul>
  <li><strong>all</strong>：（full table scan）全表扫描无疑是最差，若是百万千万级数据量，全表扫描会非常慢。</li>
  <li><strong>index</strong>：（full index scan）全索引文件扫描比all好很多，毕竟从索引树中找数据，比从全表中找数据要快。</li>
  <li><strong>range</strong>：只检索给定范围的行，使用索引来匹配行。范围缩小了，当然比全表扫描和全索引文件扫描要快。sql语句中一般会有between，in，&gt;，&lt; 等查询。</li>
  <li><strong>ref</strong>：非唯一性索引扫描，本质上也是一种索引访问，返回所有匹配某个单独值的行。比如查询公司所有属于研发团队的同事，匹配的结果是多个并非唯一值。</li>
  <li><strong>eq_ref</strong>：唯一性索引扫描，对于每个索引键，表中有一条记录与之匹配。比如查询公司的CEO，匹配的结果只可能是一条记录，</li>
  <li><strong>const</strong>：表示通过索引一次就可以找到，const用于比较primary key 或者unique索引。因为只匹配一行数据，所以很快，若将主键至于where列表中，MySQL就能将该查询转换为一个常量。</li>
  <li><strong>system</strong>：表只有一条记录（等于系统表），这是const类型的特列，平时不会出现，了解即可</li>
</ul>

<p><strong>possible_keys</strong></p>

<p>显示查询语句可能用到的索引(一个或多个或为null)，不一定被查询实际使用。仅供参考使用。</p>

<p><strong>key</strong></p>

<p>显示查询语句实际使用的索引。若为null，则表示没有使用索引。</p>

<p><strong>key_len</strong></p>

<p>显示索引中使用的字节数，可通过key_len计算查询中使用的索引长度。在不损失精确性的情况下索引长度越短越好。key_len 显示的值为索引字段的最可能长度，并非实际使用长度，即key_len是根据表定义计算而得，并不是通过表内检索出的。</p>

<p><strong>ref</strong></p>

<p>显示索引的哪一列或常量被用于查找索引列上的值。</p>

<p><strong>rows</strong></p>

<p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数，值越大越不好。</p>

<p><strong>extra</strong></p>

<ul>
  <li><strong>Using filesort</strong>： 说明MySQL会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为“文件排序” 。出现这个就要立刻优化sql。</li>
  <li><strong>Using temporary</strong>： 使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于排序 order by 和 分组查询 group by。 出现这个更要立刻优化sql。</li>
  <li><strong>Using index</strong>： 表示相应的select 操作中使用了覆盖索引（Covering index），避免访问了表的数据行，效果不错！如果同时出现Using where，表明索引被用来执行索引键值的查找。如果没有同时出现Using where，表示索引用来读取数据而非执行查找动作。</li>
  <li><strong>覆盖索引（Covering Index）</strong> ：也叫索引覆盖，就是select 的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select 列表中的字段，而不必根据索引再次读取数据文件。</li>
  <li><strong>Using index condition</strong>： 在5.6版本后加入的新特性，优化器会在索引存在的情况下，通过符合RANGE范围的条数 和 总数的比例来选择是使用索引还是进行全表遍历。</li>
  <li><strong>Using where</strong>： 表明使用了where 过滤</li>
  <li><strong>Using join buffer</strong>： 表明使用了连接缓存</li>
  <li><strong>impossible where</strong>： where 语句的值总是false，不可用，不能用来获取任何元素</li>
  <li><strong>distinct</strong>： 优化distinct操作，在找到第一匹配的元组后即停止找同样值的动作。</li>
</ul>

<p><strong>filtered</strong></p>

<p>一个百分比的值，和rows 列的值一起使用，可以估计出查询执行计划(QEP)中的前一个表的结果集，从而确定join操作的循环次数。小表驱动大表，减轻连接的次数。</p>

<p>通过explain的参数介绍，我们可以得知:</p>
<ol>
  <li>表的读取顺序(id)</li>
  <li>数据读取操作的操作类型(type)</li>
  <li>哪些索引被实际使用(key)</li>
  <li>表之间的引用(ref)</li>
  <li>每张表有多少行被优化器查询(rows)</li>
</ol>

<h3 id="性能下降的原因">性能下降的原因</h3>
<p><strong>从程序员的角度</strong></p>
<ol>
  <li>查询语句写的不好</li>
  <li>没建索引，索引建的不合理或索引失效</li>
  <li>关联查询有太多的join
<strong>从服务器的角度</strong></li>
  <li>服务器磁盘空间不足</li>
  <li>服务器调优配置参数设置不合理</li>
</ol>

<h3 id="总结">总结</h3>
<ol>
  <li>索引是排好序且快速查找的数据结构。其目的是为了提高查询的效率。</li>
  <li>创建索引后，查询数据变快，但更新数据变慢。</li>
  <li>性能下降的原因很可能是索引失效导致。</li>
  <li>索引创建的原则，经常查询的字段适合创建索引，频繁需要更新的数据不适合创建索引。</li>
  <li>索引字段频繁更新，或者表数据物理删除容易造成索引失效。</li>
  <li>擅用 explain 分析sql语句</li>
  <li>除了优化sql语句外，还可以优化表的设计。如尽量做成单表查询，减少表之间的关联。设计归档表等。</li>
</ol>

<p>到这里，MySQL的索引优化分析就结束了，有什么不对的地方，大家可以提出来。如果觉得不错可以点一下推荐。</p>
</div><p><a href="/mysql/Index">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=mysql">mysql</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E7%B4%A2%E5%BC%95">索引</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 22, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-06-22-02">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-22T00:00:00+08:00">
    <meta itemprop="keywords" content="mysql,索引"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/possible-keys"><h2 itemprop="headline" class="item__header">Mysql 索引优化分析</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="为什么你写的sql查询慢">为什么你写的sql查询慢？</h3>
<p>为什么你写的sql查询慢？为什么你建的索引常失效？通过本章内容，你将学会MySQL性能下降的原因，索引的简介，索引创建的原则，explain命令的使用，以及explain输出字段的意义。助你了解索引，分析索引，使用索引，从而写出更高性能的sql语句。还在等啥子？撸起袖子就是干！</p>

<h3 id="案例分析">案例分析</h3>
<p>我们先简单了解一下非 <strong>关系型数据库</strong> 和 <strong>关系型数据库</strong> 的区别。</p>
<ul>
  <li>
    <p>MongoDB是NoSQL中的一种。NoSQL的全称是Not only SQL，非关系型数据库。它的特点是 <strong>性能高，扩张性强，模式灵活</strong>，在高并发场景表现得尤为突出。<strong>但目前它还只是关系型数据库的补充，它在数据的一致性，数据的安全性，查询的复杂性问题上和关系型数据库还存在一定差距</strong> 。</p>
  </li>
  <li>
    <p>MySQL是关系性数据库中的一种，<strong>查询功能强，数据一致性高，数据安全性高，支持二级索引</strong>。但性能方面稍逊与MongoDB，特别是百万级别以上的数据，很容易出现查询慢的现象。这时候需要分析查询慢的原因，一般情况下是程序员sql写的烂，或者是没有键索引，或者是索引失效等原因导致的。</p>
  </li>
  <li>
    <p>公司ERP系统数据库主要是MongoDB（最接近关系型数据的NoSQL），其次是Redis，MySQL只占很少的部分。现在又重新使用MySQL，归功于阿里巴巴的奇门系统和聚石塔系统。考虑到订单数量已经是百万级以上，对MySQL的性能分析也就显得格外重要。</p>
  </li>
</ul>

<p>我们先通过两个简单的例子来入门。后面会详细介绍各个参数的作用和意义。
说明：需要用到的sql已经放在了github上了，喜欢的同学可以点一下star，哈哈。https://github.com/ITDragonBlog/daydayup/tree/master/MySQL/</p>

<h4 id="场景一订单导入通过交易号避免重复导单">场景一：订单导入，通过交易号避免重复导单</h4>

<p>业务逻辑：订单导入时，为了避免重复导单，一般会通过交易号去数据库中查询，判断该订单是否已经存在。</p>

<p><strong>最基础的sql语句</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">--------------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">------------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">gross</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">net</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">stock_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">order_status</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">descript</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">finance_descript</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">create_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">order_level</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">input_user</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">input_date</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">--------------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">------------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">10000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">81X97310V32236260E</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="nx">6.6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">6.13</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="nx">10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ok</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ok</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">auto</span><span class="w">        </span><span class="o">|</span><span class="w">           </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">itdragon</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2017</span><span class="nt">-08-18</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">49</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">--------------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">------------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="w">

</span><span class="nx">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">33.33</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>查询的本身没有任何问题，在线下的测试环境也没有任何问题。可是，功能一旦上线，查询慢的问题就迎面而来。几百上千万的订单，用全表扫描？啊？哼!</p>

<p>怎么知道该sql是全表扫描呢？通过explain命令可以清楚MySQL是如何处理sql语句的。打印的内容分别表示：</p>

<ul>
  <li><strong>id</strong> : 查询序列号为1。</li>
  <li><strong>select_type</strong> : 查询类型是简单查询，简单的select语句没有union和子查询。</li>
  <li><strong>table</strong> : 表是 itdragon_order_list。</li>
  <li><strong>partitions</strong> : 没有分区。</li>
  <li><strong>type</strong> : 连接类型，all表示采用全表扫描的方式。</li>
  <li><strong>possible_keys</strong> : 可能用到索引为null。</li>
  <li><strong>key</strong> : 实际用到索引是null。</li>
  <li><strong>key_len</strong> : 索引长度当然也是null。</li>
  <li><strong>ref</strong> : 没有哪个列或者参数和key一起被使用。</li>
  <li><strong>Extra</strong> : 使用了where查询。 <br />
因为数据库中只有三条数据，所以rows和filtered的信息作用不大。这里需要重点了解的是type为ALL，全表扫描的性能是最差的，假设数据库中有几百万条数据，在没有索引的帮助下会异常卡顿。</li>
</ul>

<p><strong>初步优化：为transaction_id创建索引</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="p">(</span><span class="nf">transaction_id</span><span class="p">);</span><span class="w">
</span><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">453</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p>这里创建的索引是唯一索引，而非普通索引。  <br />
唯一索引打印的type值是const。表示通过索引一次就可以找到。即找到值就结束扫描返回查询结果。 <br />
普通索引打印的type值是ref。表示非唯一性索引扫描。找到值还要继续扫描，直到将索引文件扫描完为止。(这里没有贴出代码) <br />
显而易见，const的性能要远高于ref。并且根据业务逻辑来判断，创建唯一索引是合情合理的。</p>

<p><strong>再次优化：覆盖索引</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">453</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>这里将 <code class="language-plaintext highlighter-rouge">select * from</code> 改为了 <code class="language-plaintext highlighter-rouge">select transaction_id from</code> 后</p>

<p>Extra 显示 Using index，表示该查询使用了覆盖索引，这是一个非常好的消息，说明该sql语句的性能很好。若提示的是Using filesort(使用内部排序)和Using temporary(使用临时表)则表明该sql需要立即优化了。</p>

<p>根据业务逻辑来的，查询结构返回transaction_id 是可以满足业务逻辑要求的。</p>

<h4 id="场景二订单管理页面通过订单级别和订单录入时间排序">场景二，订单管理页面，通过订单级别和订单录入时间排序</h4>

<p>业务逻辑：优先处理订单级别高，录入时间长的订单。
既然是排序，首先想到的应该是order by， 还有一个可怕的 Using filesort 等着你。</p>

<p><strong>最基础的sql语句</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">filesort</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>首先，采用全表扫描就不合理，还使用了文件排序Using filesort，更加拖慢了性能。 <br />
MySQL在4.1版本之前文件排序是采用双路排序的算法，由于两次扫描磁盘，I/O耗时太长。后优化成单路排序算法。其本质就是用空间换时间，但如果数据量太大，buffer的空间不足，会导致多次I/O的情况。其效果反而更差。与其找运维同事修改MySQL配置，还不如自己乖乖地建索引。</p>

<p><strong>初步优化：为order_level,input_date 创建复合索引</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="p">(</span><span class="nf">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">);</span><span class="w">
</span><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">filesort</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>创建复合索引后你会惊奇的发现，和没创建索引一样？？？都是全表扫描，都用到了文件排序。是索引失效？还是索引创建失败？我们试着看看下面打印情况</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">68</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p>将 <code class="language-plaintext highlighter-rouge">select * from</code> 换成了 <code class="language-plaintext highlighter-rouge">select order_level,input_date from</code> 后。type从all升级为index，表示（full index scan）全索引文件扫描，Extra也显示使用了覆盖索引。可是不对啊！！！！检索虽然快了，但返回的内容只有order_level和input_date 两个字段，让业务同事怎么用？难道把每个字段都建一个复合索引？
MySQL没有这么笨，可以使用force index 强制指定索引。在原来的sql语句上修改 <code class="language-plaintext highlighter-rouge">force index(idx_order_levelDate)</code> 即可。</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">force</span><span class="w"> </span><span class="nx">index</span><span class="p">(</span><span class="nf">idx_order_levelDate</span><span class="p">)</span><span class="w"> </span><span class="nf">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">68</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p><strong>再次优化：订单级别真的要排序么？</strong></p>

<p>其实给订单级别排序意义并不大，给订单级别添加索引意义也不大。因为order_level的值可能只有，低，中，高，加急，这四种。对于这种重复且分布平均的字段，排序和加索引的作用不大。</p>

<p>我们能否先固定 order_level 的值，然后再给 input_date 排序？如果查询效果明显，是可以推荐业务同事使用该查询方式。</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">order_level</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="nf">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-----------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">                 </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-----------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">5</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">index</span><span class="w"> </span><span class="nx">condition</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-----------------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>和之前的sql比起来，type从index 升级为 ref(非唯一性索引扫描)。索引的长度从68变成了5，说明只用了一个索引。ref也是一个常量。Extra 为Using index condition 表示自动根据临界值，选择索引扫描还是全表扫描。总的来说性能远胜于之前的sql。</p>

<p>上面两个案例只是快速入门，我们需严记一点：优化是基于业务逻辑来的。绝对不能为了优化而擅自修改业务逻辑。如果能修改当然是最好的。</p>
</div><p><a href="/mysql/possible-keys">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=mysql">mysql</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E7%B4%A2%E5%BC%95">索引</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 22, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-06-22-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-22T00:00:00+08:00">
    <meta itemprop="keywords" content="mysql,索引"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/spring/thread/security"><h2 itemprop="headline" class="item__header">Spring 中的bean 是线程安全的吗</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="结论-不是线程安全的"><strong>结论： 不是线程安全的</strong></h3>
<h3 id="概要">概要</h3>
<p>Spring容器中的Bean是否线程安全，容器本身并没有提供Bean的线程安全策略，因此可以说 <strong>Spring容器中的Bean本身不具备线程安全的特性，但是具体还是要结合具体scope的Bean去研究</strong>。</p>

<h4 id="spring-的-bean-作用域scope类型">Spring 的 bean 作用域（scope）类型</h4>
<ol>
  <li>singleton:单例，默认作用域。</li>
  <li>prototype:原型，每次创建一个新对象。</li>
  <li>request:请求，每次Http请求创建一个新对象，适用于WebApplicationContext环境下。</li>
  <li>session:会话，同一个会话共享一个实例，不同会话使用不用的实例。</li>
  <li>global-session:全局会话，所有会话共享一个实例。</li>
</ol>

<p><strong>线程安全这个问题，要从单例与原型Bean分别进行说明。</strong></p>

<h4 id="原型bean">原型Bean</h4>
<p>对于原型Bean,每次创建一个新对象，也就是线程之间并不存在Bean共享，自然是不会有线程安全的问题。</p>

<h4 id="单例bean">单例Bean</h4>
<p>对于单例Bean,所有线程都共享一个单例实例Bean,因此是存在资源的竞争。</p>

<p>如果单例Bean,是一个 <strong>无状态Bean</strong>，也就是线程中的操作不会对Bean的成员执行 <strong>查询</strong> 以外的操作，那么这个单例Bean是线程安全的。比如Spring mvc 的 Controller、Service、Dao等，这些Bean大多是无状态的，只关注于方法本身。</p>

<h3 id="spring单例为什么controllerservice和dao确能保证线程安全">spring单例，为什么controller、service和dao确能保证线程安全？</h3>
<ul>
  <li>Spring中的Bean默认是单例模式的，框架并没有对bean进行多线程的封装处理。</li>
  <li>实际上大部分时间Bean是无状态的（比如Dao） 所以说在某种程度上来说Bean其实是安全的。</li>
  <li>但是 <em>如果Bean是有状态的 那就需要开发人员自己来进行线程安全的保证</em> ，最简单的办法就是改变bean的作用域 把 “singleton”改为’‘protopyte’ 这样每次请求Bean就相当于是 new Bean() 这样就可以保证线程的安全了。</li>
</ul>

<p><strong>有状态就是有数据存储功能</strong><br />
<strong>无状态就是不会保存数据</strong></p>

<ul>
  <li>controller、service和dao层本身并不是线程安全的，只是如果只是调用里面的方法，而且多线程调用一个实例的方法，会在内存中复制变量，这是自己的线程的工作内存，是安全的。</li>
</ul>

<p>想理解原理可以看看《深入理解JVM虚拟机》，2.2.2节：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Java虚拟机栈是线程私有的，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。
</code></pre></div></div>

<p>《Java并发编程实战》第3.2.2节：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>局部变量的固有属性之一就是封闭在执行线程中。
它们位于执行线程的栈中，其他线程无法访问这个栈。
</code></pre></div></div>

<p><strong>所以其实任何无状态单例都是线程安全的。</strong> <br />
Spring的根本就是通过大量这种单例构建起系统，以事务脚本的方式提供服务</p>

<h3 id="关于spring的controller-service等的线程安全问题">关于Spring的@Controller @Service等的线程安全问题</h3>

<p>首先问@Controller @Service是不是线程安全的？</p>

<p>答：默认配置下不是的。为啥呢？因为默认情况下@Controller没有加上@Scope，没有加@Scope就是默认值singleton，单例的。意思就是系统只会初始化一次Controller容器，所以每次请求的都是同一个Controller容器，当然是非线程安全的。举个栗子：</p>

<h4 id="默认单例模式-线程不安全">默认单例模式 (线程不安全)</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">));</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>在postman里面发三次请求，结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>普通变量var:1
普通变量var:2
普通变量var:3
</code></pre></div></div>
<p>说明他不是线程安全的。怎么办呢？可以给他加上上面说的@Scope注解，如下：　　</p>

<h4 id="使用scope注解-使用多例模式线程安全">使用@Scope注解 使用多例模式，(线程安全)</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"prototype"</span><span class="o">)</span> <span class="c1">// 加上@Scope注解，他有2个取值：单例-singleton 多实例-prototype</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">));</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>这样一来，每个请求都单独创建一个Controller容器，所以各个请求之间是线程安全的，三次请求结果：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>普通变量var:1
普通变量var:1
普通变量var:1
</code></pre></div></div>

<p>加了@Scope注解多的实例prototype是不是一定就是线程安全的呢？　　</p>

<h4 id="scope注解也不一定能保证controller-100的线程安全有static静态变量">Scope注解也不一定能保证Controller 100%的线程安全(有static静态变量)</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"prototype"</span><span class="o">)</span> <span class="c1">// 加上@Scope注解，他有2个取值：单例-singleton 多实例-prototype</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticVar</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">)+</span> <span class="s">"---静态变量staticVar:"</span> <span class="o">+</span> <span class="o">(++</span><span class="n">staticVar</span><span class="o">));</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">+</span> <span class="s">"静态变量staticVar:"</span> <span class="o">+</span> <span class="n">staticVar</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>看三次请求结果：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>普通变量var:1---静态变量staticVar:1
普通变量var:1---静态变量staticVar:2
普通变量var:1---静态变量staticVar:3
</code></pre></div></div>

<p>虽然每次都是单独创建一个Controller但是扛不住他变量本身是static的呀，所以说呢，即便是加上@Scope注解也不一定能保证Controller 100%的线程安全。<strong>所以是否线程安全在于怎样去定义变量以及Controller的配置</strong>。所以来个全乎一点的实验，代码如下：　　</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"singleton"</span><span class="o">)</span> <span class="c1">// prototype singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// 定义一个普通变量</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticVar</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// 定义一个静态变量</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${test-int}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">testInt</span><span class="o">;</span> <span class="c1">// 从配置文件中读取变量</span>

    <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">tl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span> <span class="c1">// 用ThreadLocal来封装变量</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span> <span class="c1">// 注入一个对象来封装变量</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">tl</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"先取一下user对象中的值："</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">()+</span><span class="s">"===再取一下hashCode:"</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">)</span> <span class="o">+</span> <span class="s">"===静态变量staticVar:"</span> <span class="o">+</span> <span class="o">(++</span><span class="n">staticVar</span><span class="o">)</span> <span class="o">+</span> <span class="s">"===配置变量testInt:"</span> <span class="o">+</span> <span class="o">(++</span><span class="n">testInt</span><span class="o">)</span>
                <span class="o">+</span> <span class="s">"===ThreadLocal变量tl:"</span> <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="na">get</span><span class="o">()+</span><span class="s">"===注入变量user:"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">+</span> <span class="s">",静态变量staticVar:"</span> <span class="o">+</span> <span class="n">staticVar</span> <span class="o">+</span> <span class="s">",配置读取变量testInt:"</span> <span class="o">+</span> <span class="n">testInt</span> <span class="o">+</span> <span class="s">",ThreadLocal变量tl:"</span>
                <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">"注入变量user:"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>补充Controller以外的代码：
config里面自己定义的Bean:User</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">user</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>我暂时能想到的定义变量的方法就这么多了，三次http请求结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>先取一下user对象中的值：0===再取一下hashCode:241165852
普通变量var:1===静态变量staticVar:1===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:241165852
普通变量var:2===静态变量staticVar:2===配置变量testInt:2===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:241165852
普通变量var:3===静态变量staticVar:3===配置变量testInt:3===ThreadLocal变量tl:1===注入变量user:1
</code></pre></div></div>

<p>可以看到，在单例模式下Controller中只有用ThreadLocal封装的变量是线程安全的。为什么这样说呢？我们可以看到3次请求结果里面只有ThreadLocal变量值每次都是从0+1=1的，其他的几个都是累加的，而user对象呢，默认值是0，第二交取值的时候就已经是1了，关键他的hashCode是一样的，说明每次请求调用的都是同一个user对象。
下面将TestController 上的@Scope注解的属性改一下改成多实例的：@Scope(value = “prototype”)，其他都不变，再次请求，结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>先取一下user对象中的值：0===再取一下hashCode:853315860
普通变量var:1===静态变量staticVar:1===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:853315860
普通变量var:1===静态变量staticVar:2===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:853315860
普通变量var:1===静态变量staticVar:3===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
</code></pre></div></div>

<p>分析这个结果发现，多实例模式下普通变量，取配置的变量还有ThreadLocal变量都是线程安全的，而静态变量和user（看他的hashCode都是一样的）对象中的变量都是非线程安全的。也就是说尽管TestController 是每次请求的时候都初始化了一个对象，但是静态变量始终是只有一份的，而且这个注入的user对象也是只有一份的。静态变量只有一份这是当然的咯，那么有没有办法让user对象可以每次都new一个新的呢？当然可以：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"prototype"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">user</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">();</span>
    <span class="o">}</span>    
<span class="o">}</span>
</code></pre></div></div>

<p>在config里面给这个注入的Bean加上一个相同的注解@Scope(value = “prototype”)就可以了，再来请求一下看看：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>先取一下user对象中的值：0===再取一下hashCode:1612967699
普通变量var:1===静态变量staticVar:1===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：0===再取一下hashCode:985418837
普通变量var:1===静态变量staticVar:2===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：0===再取一下hashCode:1958952789
普通变量var:1===静态变量staticVar:3===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
</code></pre></div></div>

<p>可以看到每次请求的user对象的hashCode都不是一样的，每次赋值前取user中的变量值也都是默认值0。</p>
<h3 id="总结">总结</h3>

<ol>
  <li>在@Controller/@Service等容器中，默认情况下，scope值是单例-singleton的，也是线程不安全的。</li>
  <li>尽量不要在@Controller/@Service等容器中定义静态变量，不论是单例(singleton)还是多实例(prototype)他都是线程不安全的。</li>
  <li>默认注入的Bean对象，在不设置scope的时候他也是线程不安全的。</li>
  <li>一定要定义变量的话，用ThreadLocal来封装，这个是线程安全的</li>
</ol>
</div><p><a href="/spring/thread/security">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=spring">spring</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%F0%9F%8C%9F%F0%9F%8C%9F%F0%9F%8C%9F%F0%9F%8C%9F%F0%9F%8C%9F">🌟🌟🌟🌟🌟</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 21, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="spring-2020-06-21-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-21T00:00:00+08:00">
    <meta itemprop="keywords" content="spring,🌟🌟🌟🌟🌟"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/partition"><h2 itemprop="headline" class="item__header">Mysql 分区表-分区操作</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="视频参考链接">视频参考链接</h3>
<p><a href="https://www.bilibili.com/video/BV1E7411q7Nx?p=1">MySQL分区</a></p>

<h3 id="一查看mysql是否支持分区">一、查看MySQL是否支持分区</h3>
<h4 id="1mysql56以及之前版本">1、MySQL5.6以及之前版本</h4>

<p>show variables like ‘%partition%’;</p>

<p><img src="/assets/images/mysql/0620/1530782-20181221101618516-1766491003.png" alt="1" /></p>

<h4 id="2mysql57">2、MySQL5.7</h4>

<p>show plugins;</p>

<p><img src="/assets/images/mysql/0620/1530782-20181221101735004-398510033.png" alt="2" /></p>

<h3 id="二分区表的分类与限制">二、分区表的分类与限制</h3>
<h4 id="1分区表分类">1、分区表分类</h4>

<p><strong>RANGE分区</strong>：基于属于一个给定连续区间的列值，把多行分配给分区。</p>

<p><strong>LIST分区</strong>：类似于按RANGE分区，区别在于LIST分区是基于列值匹配一个离散值集合中的某个值来进行选择。</p>

<p><strong>HASH分区</strong>：基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含MySQL 中有效的、产生非负整数值的任何表达式。</p>

<p><strong>KEY分区</strong>：类似于按HASH分区，区别在于KEY分区只支持计算一列或多列，且MySQL服务器提供其自身的哈希函数。必须有一列或多列包含整数值。</p>

<p><strong>复合分区</strong>：在MySQL 5.6版本中，只支持RANGE和LIST的子分区，且子分区的类型只能为HASH和KEY。</p>

<h4 id="2分区表限制">2、分区表限制</h4>

<p>1）分区键必须包含在表的所有主键、唯一键中。</p>

<p>2）MYSQL只能在使用分区函数的列本身进行比较时才能过滤分区，而不能根据表达式的值去过滤分区，即使这个表达式就是分区函数也不行。</p>

<p>3）最大分区数： 不使用NDB存储引擎的给定表的最大可能分区数为8192（包括子分区）。如果当分区数很大，但是未达到8192时提示 Got error … from storage engine: Out of resources when opening file,可以通过增加open_files_limit系统变量的值来解决问题，当然同时打开文件的数量也可能由操作系统限制。</p>

<p>4）不支持查询缓存： 分区表不支持查询缓存，对于涉及分区表的查询，它自动禁用。 查询缓存无法启用此类查询。</p>

<p>5）分区的innodb表不支持外键。</p>

<p>6）服务器SQL_mode影响分区表的同步复制。 主机和从机上的不同SQL_mode可能会导致sql语句; 这可能导致分区之间的数据分配给定主从位置不同，甚至可能导致插入主机上成功的分区表在从库上失败。 为了获得最佳效果，您应该始终在主机和从机上使用相同的服务器SQL模式。</p>

<p>7）ALTER TABLE … ORDER BY： 对分区表运行的ALTER TABLE … ORDER BY列语句只会导致每个分区中的行排序。</p>

<p>8）全文索引。 分区表不支持全文索引，即使是使用InnoDB或MyISAM存储引擎的分区表。  <br />
9）分区表无法使用外键约束。  <br />
10）Spatial columns： 具有空间数据类型（如POINT或GEOMETRY）的列不能在分区表中使用。 <br />
11）临时表： 临时表不能分区。  <br />
12）subpartition问题： subpartition必须使用HASH或KEY分区。 只有RANGE和LIST分区可能被分区; HASH和KEY分区不能被子分区。 <br />
13）分区表不支持mysqlcheck，myisamchk和myisampack。</p>

<h3 id="三创建分区表">三、创建分区表</h3>
<h4 id="1range分区">1、range分区</h4>

<p>1）行数据基于一个给定的连续区间的列值放入分区。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`test_11`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`t`</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span><span class="nv">`t`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>
 <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">to_days</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="p">(</span><span class="n">PARTITION</span> <span class="n">p20170801</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">736907</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">,</span>
 <span class="n">PARTITION</span> <span class="n">p20170901</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">736938</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">,</span>
 <span class="n">PARTITION</span> <span class="n">pmax</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="k">maxvalue</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span><span class="mi">123456789</span>
</code></pre></div></div>

<p>2）然后插入4条数据：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">test_11</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">"20170722"</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="nv">"20170822"</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="nv">"20170823"</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="nv">"20170824"</span><span class="p">);</span><span class="mi">1</span>
</code></pre></div></div>
<p>3）然后查看information下partitions对分区别信息的统计：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">PARTITION_NAME</span> <span class="k">as</span> <span class="nv">"分区"</span><span class="p">,</span><span class="n">TABLE_ROWS</span> <span class="k">as</span> <span class="nv">"行数"</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">partitions</span> <span class="k">where</span> <span class="n">table_schema</span><span class="o">=</span><span class="nv">"mysql_test"</span> <span class="k">and</span> <span class="k">table_name</span><span class="o">=</span><span class="nv">"test_11"</span><span class="p">;</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-----------+--------+
| 分区      | 行数   |
+-----------+--------+
| p20170801 |      1 |
| p20170901 |      3 |
+-----------+--------+
2 rows in set (0.00 sec)12345678
</code></pre></div></div>
<p>可以看出分区p20170801插入1行数据，p20170901插入的3行数据。
可以是用year、to_days、unix_timestamp等函数对相应的时间字段进行转换，然后分区。</p>
<h3 id="2list分区">2、list分区</h3>

<p>和range分区一样，只是list分区面向的是离散的值</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">h2</span> <span class="p">(</span>
    <span class="o">-&gt;</span>   <span class="n">c1</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="o">-&gt;</span>   <span class="n">c2</span> <span class="nb">INT</span>
    <span class="o">-&gt;</span> <span class="p">)</span>
    <span class="o">-&gt;</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">LIST</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="p">(</span>
    <span class="o">-&gt;</span>   <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="o">-&gt;</span>   <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span> <span class="n">sec</span><span class="p">)</span><span class="mi">123456789</span>
</code></pre></div></div>
<p>与RANGE分区的情况不同，没有“catch-all”，如MAXVALUE; 分区表达式的所有预期值应在PARTITION … VALUES IN（…）子句中涵盖。 包含不匹配的分区列值的INSERT语句失败并显示错误，如此示例所示：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">h2</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">ERROR</span> <span class="mi">1525</span> <span class="p">(</span><span class="n">HY000</span><span class="p">):</span> <span class="k">Table</span> <span class="n">has</span> <span class="k">no</span> <span class="n">partition</span> <span class="k">for</span> <span class="n">value</span> <span class="mi">312</span>
</code></pre></div></div>
<h4 id="3hash分区">3、hash分区</h4>

<p>根据用户自定义表达式的返回值来进行分区，返回值不能为负数</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="p">(</span><span class="n">col1</span> <span class="nb">INT</span><span class="p">,</span> <span class="n">col2</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">col3</span> <span class="nb">DATE</span><span class="p">)</span>
    <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span> <span class="nb">YEAR</span><span class="p">(</span><span class="n">col3</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">PARTITIONS</span> <span class="mi">4</span><span class="p">;</span><span class="mi">123</span>
</code></pre></div></div>
<p>如果你插入col3的数值为’2005-09-15’，那么根据以下计算来选择插入的分区：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">MOD</span><span class="p">(</span><span class="nb">YEAR</span><span class="p">(</span><span class="s1">'2005-09-01'</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">=</span>  <span class="k">MOD</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">=</span>  <span class="mi">1123</span>
</code></pre></div></div>
<h4 id="4key分区">4、key分区</h4>

<p>根据MySQL数据库提供的散列函数进行分区</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">k1</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">KEY</span><span class="p">()</span>
<span class="n">PARTITIONS</span> <span class="mi">2</span><span class="p">;</span><span class="mi">1234567</span>
</code></pre></div></div>
<p>KEY仅列出零个或多个列名称。 用作分区键的任何列必须包含表的主键的一部分或全部，如果该表具有一个。 如果没有列名称作为分区键，则使用表的主键（如果有）。如果没有主键，但是有一个唯一的键，那么唯一键用于分区键。但是，如果唯一键列未定义为NOT NULL，则上一条语句将失败。
与其他分区类型不同，KEY使用的分区不限于整数或空值。 例如，以下CREATE TABLE语句是有效的：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tm1</span> <span class="p">(</span>
    <span class="n">s1</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="n">PARTITIONS</span> <span class="mi">10</span><span class="p">;</span><span class="mi">12345</span>
</code></pre></div></div>
<p>注意：对于key分区表，不能执行ALTER TABLE DROP PRIMARY KEY，因为这样做会生成错误 ERROR 1466 (HY000): Field in list of fields for partition function not found in table.</p>
<h4 id="5column分区">5、Column分区</h4>

<p>COLUMN分区是5.5开始引入的分区功能，只有RANGE COLUMN和LIST COLUMN这两种分区；支持整形、日期、字符串；RANGE和LIST的分区方式非常的相似。
COLUMNS和RANGE和LIST分区的区别
1）针对日期字段的分区就不需要再使用函数进行转换了，例如针对date字段进行分区不需要再使用YEAR()表达式进行转换。  <br />
2）COLUMN分区支持多个字段作为分区键但是不支持表达式作为分区键。</p>

<h5 id="column支持的数据类型">column支持的数据类型：</h5>

<p>1）所有的整型，float和decimal不支持  <br />
2）日期类型：date和datetime，其他不支持  <br />
3）字符类型：CHAR, VARCHAR, BINARY和VARBINARY，blob和text不支持 <br />
单列的column range分区mysql&gt; show create table list_c;</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`list_c`</span> <span class="p">(</span>
  <span class="nv">`c1`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c2`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(c1)
(PARTITION p0 VALUES LESS THAN (5) ENGINE = InnoDB,
 PARTITION p1 VALUES LESS THAN (10) ENGINE = InnoDB) */</span>
</code></pre></div></div>
<p>多列的column range分区mysql&gt; show create table list_c;</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`list_c`</span> <span class="p">(</span>
  <span class="nv">`c1`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c2`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c3`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(c1,c3)
(PARTITION p0 VALUES LESS THAN (5,'aaa') ENGINE = InnoDB,
 PARTITION p1 VALUES LESS THAN (10,'bbb') ENGINE = InnoDB) */</span>
<span class="err">单列的</span><span class="k">column</span> <span class="n">list</span><span class="err">分区</span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="k">create</span> <span class="k">table</span> <span class="n">list_c</span><span class="p">;</span>
 <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`list_c`</span> <span class="p">(</span>
  <span class="nv">`c1`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c2`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c3`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
<span class="cm">/*!50500 PARTITION BY LIST  COLUMNS(c3)
(PARTITION p0 VALUES IN ('aaa') ENGINE = InnoDB,
 PARTITION p1 VALUES IN ('bbb') ENGINE = InnoDB) */</span>
</code></pre></div></div>
<h4 id="6子分区组合分区">6、子分区（组合分区）</h4>

<p>在分区的基础上再进一步分区，有时成为复合分区;
MySQL数据库允许在range和list的分区上进行HASH和KEY的子分区。例如：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">ts</span> <span class="p">(</span><span class="n">id</span> <span class="nb">INT</span><span class="p">,</span> <span class="n">purchased</span> <span class="nb">DATE</span><span class="p">)</span>
    <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span><span class="p">(</span> <span class="nb">YEAR</span><span class="p">(</span><span class="n">purchased</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">SUBPARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span> <span class="n">TO_DAYS</span><span class="p">(</span><span class="n">purchased</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">SUBPARTITIONS</span> <span class="mi">2</span> <span class="p">(</span>
        <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1990</span><span class="p">),</span>
        <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2000</span><span class="p">),</span>
        <span class="n">PARTITION</span> <span class="n">p2</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="k">MAXVALUE</span>
    <span class="p">);</span>
</code></pre></div></div>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@mycat-3 ~]# ll /data/mysql_data_3306/mysql_test/ts*
-rw-r----- 1 mysql mysql  8596 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts.frm
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p0#SP#p0sp0.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p0#SP#p0sp1.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p1#SP#p1sp0.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p1#SP#p1sp1.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p2#SP#p2sp0.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p2#SP#p2sp1.ibd
1234567891011121314151617
</code></pre></div></div>
<p>ts表根据purchased进行range分区，然后又进行了一次hash分区，最后形成了3*2个分区，可以从物理文件证实此分区方式。可以通过subpartition语法来显示指定子分区名称。
注意：每个子分区的数量必须相同；如果一个分区表的任何子分区已经使用subpartition，那么必须表明所有的子分区名称；每个subpartition子句必须包括子分区的一个名字；子分区的名字必须是一致的
另外，对于MyISAM表可以使用index directory和data direactory来指定各个分区的数据和索引目录，但是对于innodb表来说，因为该存储引擎使用表空间自动的进行数据和索引的管理，因此会忽略指定index和data的语法。</p>

<h3 id="四普通表转换为分区表">四、普通表转换为分区表</h3>
<p>1、用alter table table_name partition by命令重建分区表</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="n">jxfp_data_bak</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">SH</span><span class="p">)</span> <span class="n">PARTITIONS</span> <span class="mi">8</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="五分区表操作">五、分区表操作</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="n">year_col</span> <span class="nb">INT</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">year_col</span><span class="p">)</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1991</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1995</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">p2</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>
<h4 id="1add-partition-新增分区">1、ADD PARTITION （新增分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ADD</span> <span class="n">PARTITION</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p3</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2002</span><span class="p">));</span>
</code></pre></div></div>
<h4 id="2drop-partition-删除分区">2、DROP PARTITION （删除分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">DROP</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="3truncate-partition截取分区">3、TRUNCATE PARTITION（截取分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">TRUNCATE</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">TRUNCATE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p3</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="4coalesce-partition合并分区">4、COALESCE PARTITION（合并分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t2</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span> <span class="p">(</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">started</span> <span class="nb">DATE</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span> <span class="nb">YEAR</span><span class="p">(</span><span class="n">started</span><span class="p">)</span> <span class="p">)</span>
<span class="n">PARTITIONS</span> <span class="mi">6</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t2</span> <span class="n">COALESCE</span> <span class="n">PARTITION</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="5reorganize-partition拆分重组分区">5、REORGANIZE PARTITION（拆分/重组分区）</h4>

<h5 id="1拆分分区">1）拆分分区</h5>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">table</span> <span class="n">ALGORITHM</span><span class="o">=</span><span class="n">INPLACE</span><span class="p">,</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">employees</span> <span class="k">ADD</span> <span class="n">PARTITION</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p5</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2010</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">p6</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="k">MAXVALUE</span>
<span class="p">);</span>
</code></pre></div></div>
<h5 id="2重组分区">2）重组分区</h5>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">members</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">s0</span><span class="p">,</span><span class="n">s1</span> <span class="k">INTO</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1970</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tbl_name</span>
    <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">partition_list</span>
    <span class="k">INTO</span> <span class="p">(</span><span class="n">partition_definitions</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">members</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span> <span class="k">INTO</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">m0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1980</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">m1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tt</span> <span class="k">ADD</span> <span class="n">PARTITION</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">np</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tt</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span><span class="n">np</span> <span class="k">INTO</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">np</span> <span class="k">VALUES</span> <span class="k">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>
<h4 id="6analyze-check-partition分析与检查分区">6、ANALYZE 、CHECK PARTITION（分析与检查分区）</h4>

<p>1）ANALYZE 读取和存储分区中值的分布情况</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
</code></pre></div></div>
<p>2）CHECK 检查分区是否存在错误</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="k">CHECK</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="7repair分区">7、REPAIR分区</h4>

<p>修复被破坏的分区</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">REPAIR</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="8optimize">8、OPTIMIZE</h4>

<p>该命令主要是用于回收空闲空间和分区的碎片整理。对分区执行该命令,相当于依次对分区执行 CHECK PARTITION, ANALYZE PARTITION,REPAIR PARTITION命令。</p>

<p>譬如:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">OPTIMIZE</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="9rebuild分区">9、REBUILD分区</h4>

<p>重建分区,它相当于先删除分区中的数据,然后重新插入。这个主要是用于分区的碎片整理。</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">REBUILD</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="10exchange-partition分区交换">10、EXCHANGE PARTITION（分区交换）</h4>

<p>分区交换的语法如下:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">pt</span> <span class="n">EXCHANGE</span> <span class="n">PARTITION</span> <span class="n">p</span> <span class="k">WITH</span> <span class="k">TABLE</span> <span class="n">nt</span>
</code></pre></div></div>
<p>其中,pt是分区表,p是pt的分区(注:也可以是子分区),nt是目标表。</p>

<p>其实,分区交换的限制还是蛮多的:</p>

<p>1） nt不能为分区表</p>

<p>2）nt不能为临时表</p>

<p>3）nt和pt的结构必须一致</p>

<p>4）nt不存在任何外键约束,即既不能是主键,也不能是外键。</p>

<p>5）nt中的数据不能位于p分区的范围之外。</p>

<p>具体可参考MySQL的官方文档</p>

<h4 id="11迁移分区discard-import-">11、迁移分区（DISCARD 、IMPORT ）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">DISCARD</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="n">TABLESPACE</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">IMPORT</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="n">TABLESPACE</span><span class="p">;</span>
</code></pre></div></div>
<p>实验环境：（都是mysql5.7）
源库：192.168.2.200      mysql5.7.16    zhangdb下的emp_2分区表的
目标库：192.168.2.100    mysql5.7.18    test下  （将zhangdb的emp表，导入到目标库的test schema下）
–：在源数据库中创建测试分区表emp_2，然后导入数据</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MySQL</span> <span class="p">[</span><span class="n">zhangdb</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">emp_2</span><span class="p">(</span>
<span class="n">id</span> <span class="nb">BIGINT</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">x</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">y</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="n">COLUMNS</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">(</span>
<span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1000</span><span class="p">),</span>  
<span class="n">PARTITION</span> <span class="n">p2</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2000</span><span class="p">),</span>  
<span class="n">PARTITION</span> <span class="n">p3</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">3000</span><span class="p">)</span>     
<span class="p">);</span>  
</code></pre></div></div>
<p>（接着创建存储过程，导入测试数据）</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">insert_batch</span><span class="p">()</span>
<span class="k">begin</span>
<span class="k">DECLARE</span> <span class="n">num</span> <span class="nb">INT</span><span class="p">;</span>
<span class="k">SET</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">WHILE</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">3000</span> <span class="k">DO</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">num</span><span class="o">%</span><span class="mi">10000</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">COMMIT</span><span class="p">;</span>
<span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">emp_2</span> <span class="k">VALUES</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="n">REPEAT</span><span class="p">(</span><span class="s1">'X'</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">REPEAT</span><span class="p">(</span><span class="s1">'Y'</span><span class="p">,</span> <span class="mi">500</span><span class="p">));</span>
<span class="k">SET</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="k">END</span> <span class="n">WHILE</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">TABLE_NAME</span><span class="p">,</span><span class="n">PARTITION_NAME</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">partitions</span> <span class="k">where</span> <span class="n">table_schema</span><span class="o">=</span><span class="s1">'zhangdb'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------+----------------+</span>
<span class="o">|</span> <span class="k">TABLE_NAME</span> <span class="o">|</span> <span class="n">PARTITION_NAME</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+----------------+</span>
<span class="o">|</span> <span class="n">emp</span>        <span class="o">|</span> <span class="k">NULL</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">emp_2</span>      <span class="o">|</span> <span class="n">p1</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">emp_2</span>      <span class="o">|</span> <span class="n">p2</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">emp_2</span>      <span class="o">|</span> <span class="n">p3</span>             <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+----------------+</span>
<span class="mi">4</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span> <span class="n">partition</span> <span class="p">(</span><span class="n">p1</span><span class="p">);</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>      <span class="mi">999</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span> <span class="n">partition</span> <span class="p">(</span><span class="n">p2</span><span class="p">);</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>     <span class="mi">1000</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span> <span class="n">partition</span> <span class="p">(</span><span class="n">p3</span><span class="p">);</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>     <span class="mi">1000</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<p>从上面可以看出，emp_2分区表已经创建完成，并且有3个子分区，每个分区都有一点数据。
–：在目标数据库中，创建emp_2表的结构，不要数据（要在源库，使用show create table emp_2\G 的方法 查看创建该表的sql）</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`emp_2`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`x`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`y`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">3000</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(id)
(PARTITION p1 VALUES LESS THAN (1000) ENGINE = InnoDB,
 PARTITION p2 VALUES LESS THAN (2000) ENGINE = InnoDB,
 PARTITION p3 VALUES LESS THAN (3000) ENGINE = InnoDB) */</span> <span class="p">;</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@localhost test]# ll
-rw-r----- 1 mysql mysql 98304 May 25 15:58 emp_2#P#p0.ibd
-rw-r----- 1 mysql mysql 98304 May 25 15:58 emp_2#P#p1.ibd
-rw-r----- 1 mysql mysql 98304 May 25 15:58 emp_2#P#p2.ibd
</code></pre></div></div>
<p>注意：
※约束条件、字符集等等也必须一致，建议使用show create table t1; 来获取创建表的SQL，否则在新服务器上导入表空间的时候会提示1808错误。
–：在目标数据库上，丢弃分区表的表空间</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">table</span> <span class="n">emp_2</span> <span class="n">discard</span> <span class="n">tablespace</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@localhost test]# ll    ---这时候在看，刚才的3个分区的idb文件都没有了
-rw-r----- 1 mysql mysql  8604 May 25 04:14 emp_2.frm
</code></pre></div></div>
<p>–：在源数据库上运行FLUSH TABLES … FOR EXPORT 锁定表并生成.cfg元数据文件，最后将cfg和ibd文件传输到目标数据库中</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">tables</span> <span class="n">emp_2</span> <span class="k">for</span> <span class="n">export</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@localhost zhangdb]# scp emp_2* root@192.168.2.100:/mysql/data/test/   --将文件cp到目标数据库
mysql&gt; unlock tables;   ---最后将表的锁是否
</code></pre></div></div>
<p>–：在目标数据库中对文件授权，然后导入表空间查看数据是否完整可用</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">localhost</span> <span class="n">test</span><span class="p">]</span><span class="o">#</span> <span class="n">chown</span> <span class="n">mysql</span><span class="p">.</span><span class="n">mysql</span> <span class="n">emp_2</span><span class="o">#*</span>
<span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">table</span> <span class="n">emp_2</span> <span class="n">import</span> <span class="n">tablespace</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">96</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>     <span class="mi">2999</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">63</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<p>从上面的查看得知，分区表都已经导入到目标数据库中了，
另外，也可以将部分子分区导入到目标数据库中，（往往整个分区表会很大，可用只将需要用到的子分区导入到目标数据库中），
将部分子分区导入到目标数据库的方法是：
1）在创建目标表的时候，只需要创建要导入的分区即可，如： 只创建了p2 p3两个分区</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`emp_2`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`x`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`y`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">3000</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(id)
(
 PARTITION p2 VALUES LESS THAN (2000) ENGINE = InnoDB,
 PARTITION p3 VALUES LESS THAN (3000) ENGINE = InnoDB) */</span>
</code></pre></div></div>
<p>2）从源库cp到目标库的文件，当然也就是这俩的，就不需要其他分区的了，
3）其他的操作方法都一样了。</p>

<h3 id="六如何获取分区的相关信息">六、如何获取分区的相关信息</h3>
<ol>
  <li>通过 SHOW CREATE TABLE 语句来查看分区表的分区子句</li>
</ol>

<p>譬如:mysql&gt; show create table e/G</p>

<ol>
  <li>通过 SHOW TABLE STATUS 语句来查看表是否分区对应Create_options字段</li>
</ol>

<p>譬如:
mysql&gt; show table status/G</p>

<p><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>* 1. row **</strong><strong>**</strong><strong>**</strong><strong>**</strong>*****</p>

<p>Name: e Engine: InnoDB Version: 10 Row_format: Compact Rows: 6 Avg_row_length: 10922 Data_length: 65536Max_data_length: 0 Index_length: 0 Data_free: 0 Auto_increment: NULL Create_time: 2015-12-07 22:26:06 Update_time: NULL Check_time: NULL Collation: latin1_swedish_ci Checksum: NULL Create_options: partitioned Comment:</p>

<ol>
  <li>
    <p>查看 INFORMATION_SCHEMA.PARTITIONS表</p>
  </li>
  <li>
    <p>通过 EXPLAIN PARTITIONS SELECT 语句查看对于具体的SELECT语句,会访问哪个分区。</p>
  </li>
</ol>

<h3 id="七mysql57对于partition表的改进">七、MySQL5.7对于partition表的改进</h3>
<ul>
  <li>HANDLER statements：MySQL 5.7.1分区表开始支持HANDLER语句；</li>
  <li>index condition pushdown：MySQL5.7.3分区表开始支持ICP；</li>
  <li>load data：MySQL5.7开始使用缓存来实现性能提升，每个分区使用130KB缓冲区来实现这一点；</li>
  <li>Per-partition索引缓存：MySQL5.7开始支持使用CACHE INDEX和LOAD INDEX INTO CACHE语句对分区的MyISAM表支持索引缓存；</li>
  <li>FOR EXPORT选项（FLUSH TABLES）:MySQL 5.7.4分区的InnoDB表开始支持FLUSH TABLES语句FOR EXPORT选项；</li>
  <li>从MySQL 5.7.2开始，子分区支持ANALYZE，CHECK，OPTIMIZE，REPAIR和TRUNCATE操作；</li>
</ul>
</div><p><a href="/mysql/partition">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=mysql">mysql</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 20, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-06-20-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-20T00:00:00+08:00">
    <meta itemprop="keywords" content="mysql"></div>
      </article></div>
</div><div class="layout--home"><div class="pagination"><p>260 post articles, 33 pages.</p>
    <div class="pagination__menu">
      <ul class="menu menu--nowrap"><li><div class="button button--secondary button--circle disabled">
            <i class="fas fa-angle-left"></i>
          </div></li><li>
              <div class="button button--primary button--circle focus"><span>1</span></div>
            </li><li>
                  <a class="button button--secondary button--circle" href="/home/page2"><span>2</span></a>
                </li><li>
                  <a class="button button--secondary button--circle" href="/home/page3"><span>3</span></a>
                </li><li>
                  <a class="button button--secondary button--circle" href="/home/page4"><span>4</span></a>
                </li><li><span class="pagination__omit"><i class="fas fa-ellipsis-h"></i></span></li><li>
                  <a class="button button--secondary button--circle" href="/home/page33"><span>33</span></a>
                </li><li><a class="button button--secondary button--circle" href="/home/page2">
            <i class="fas fa-angle-right"></i>
          </a></li></ul>
    </div>
  </div></div>
<script>/*(function () {

})();*/
</script>



</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="java牛牛"><meta itemprop="url" content="/javaniuniu.com"><meta itemprop="description" content="I am an amazing person.
"><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="javaniuniu.com"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:king101125s@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Facebook.">
        <a class="button button--circle facebook-button" itemprop="sameAs" href="https://www.facebook.com/minplemon" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M767.428571 6.857143l0 150.857143-89.714286 0q-49.142857 0-66.285714 20.571429t-17.142857 61.714286l0 108 167.428571 0-22.285714 169.142857-145.142857 0 0 433.714286-174.857143 0 0-433.714286-145.714286 0 0-169.142857 145.714286 0 0-124.571429q0-106.285714 59.428571-164.857143t158.285714-58.571429q84 0 130.285714 6.857143z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/minplemon" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/javaniuniu" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© JAVA 牛牛 2020, <a href="http://www.beian.miit.gov.cn/">浙ICP备20011288号</a>
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js'], function() {
    var $canvas = null, $this = null, _ctx = null, _text = '';
    $('.language-chart').each(function(){
      $this = $(this);
      $canvas = $('<canvas></canvas>');
      _text = $this.text();
      $this.text('').append($canvas);
      _ctx = $canvas.get(0).getContext('2d');
      (_ctx && _text) && (new Chart(_ctx, JSON.parse(_text)) && $this.attr('data-processed', true));
    });
  });
</script>
<script type="text/x-mathjax-config">
	var _config = { tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']]
	}};_config.TeX = { equationNumbers: { autoNumber: "all" } };MathJax.Hub.Config(_config);
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

