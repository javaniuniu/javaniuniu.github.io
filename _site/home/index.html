<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Home - JAVA 牛牛</title>

<meta name="description" content="">
<link rel="canonical" href="http://localhost:4000/home/"><link rel="alternate" type="application/rss+xml" title="JAVA 牛牛" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://use.fontawesome.com/releases/v5.0.13/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3,h4,h5,h6'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="256px" height="256px" viewBox="0 0 256 256" enable-background="new 0 0 256 256" xml:space="preserve">  <image id="image0" width="256" height="256" x="0" y="0"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAABGdBTUEAALGPC/xhBQAAACBjSFJN
AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABklBMVEX///99Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9
Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxd9Fxf///9O0pOeAAAAhHRS
TlMAAAQjKwgXLxOD7/efFFPXuzPDGHf7S4uvN/Mko3MwXN+rQGu/LH+nII8MsyiX6+NMx1hjtzhg
R8+Te1Bn518nb0PbHzuHENPLPDRo2IRXxT+bZEhUGz1ExCL60NwVoU9bHA/JYmyu6fFyaaLUrH2V
gAH1Ei1RQloHgakFtNUDduLohQ2rommNAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAALEwAACxMBAJqc
GAAAAAd0SU1FB+QFDgsyHesd3D4AABK2SURBVHja7V35V9tIEkbOOATbYMfYAQxMbHB8cNgh8YA5
TAgB48AsC4Fs9gZm7/u+71394WtzuD/JLanVXZLIG9UPeS9G6q761Ed1XT00FFJIIYUUUkghfWlJ
k6XIg0+i0i+T08PhR3IvygIQHYnpejwxGrTgNzSW1HU99dhHAKJp/ZqS40HL3qPMDTPZJ/4BMKHf
0mTQwndp6o6ZmMSAlAMgmrvrU58OWnxNm+kzM+sXAJ/2u9SfBi2+puX7zBT8AmCOATAftPiaFu8z
U/QLgGcMgFLQ4msaY6bsFwAV1mc1aPG1BcZMwi8ARlmfi0HLry0xZpb9AkCr9fusBy2/9pwBkPEN
gBXWaSVoADKMlxe+AbDMOn0ZNAANxstnvgGwyjqV2HpIKcKUsuyCbwCMMwCC1gXXGCdNiddlT4NJ
pb2HksqMk3UfAdhg3WaXgpR/nOmB+qaPAIAqpKeCBGCE8RGXMdBIW4RSgMBWcPLjAJA6mksDAOqH
Hh8ODICCrjYD5AHQmtB1K6idYBuYyEf8BQCHgJ58FYj8UzngQUIPVgJAm0QEWo8DkP9VCzmQ0ILU
AKjEEYHsju/yv44hA5KWGQUAtC3dQCuPfRU/OpI1TEKpFUANAFTCbvYh/yCIjO0aus5KnIPUAVhI
mhDQkxtTrr7Emy49dN/x3kjd1PGErAxKAGjjLX2A4s1CYqLkRNXJdJ5N4Vq+WN53fOea9hMzzfhA
pynJCaAKgLbEQSAASralJVAEQFuqq7OvTC2F45gqANr4QdDi67sqx1FlALSFRMDyd5QctOoAaNpq
TF0KeUqoRSlQAKCNz6jLIUl1qSMgNQCa9rYYiPjxCfnlnxYATTssxNUFcke5KkF4BhkAmjZ6VPQR
g3jqKUmIEiEAXYrOlcrNnJgEtYNiOdHVGauJxGQxKfjSjezNQmmOKkCLFoBbWqhUKmOfWwpQn/zK
8TPz6X30cHti0Xo7+epJ5ZaI47I8AaB7WCtl+YLkT1/YOROXVss1/ou5bW849QaABytcIZobIjrb
ZyO73LcLnsTkeQLAMW9Gt/bFLaeHy7zJUJ/6OACIVDnMFzfdHVij7zhnjKwHAUn0ALSLg5xPfirR
0BmnoYT0ud83AF4lacTv0dwgBEVl1c9jAPYGFvEVWWtdj84H1kPq4FxiAPbMy19NMZAykjFrl3Va
H4waAO+HT55sb2+/zHT/2X5y8mbVzG1CfcRWzPOg9bWpk+PtW1o7GZYwqioDEB0+HimvONoDa8+V
xe/RvJOeXF8pjxwPyynH7gEYnj8VtII1qDSXpaZQfweJefduancAvNmaFLb+ZAmDaKPCZrfY5NYb
rwAYHkmKstGl3Ac6+bu0lRXvOjniYiCIAvBmY1ecgy7lqQOHPrg5MOu7JdFxIARAZKzhSvrudKRP
pXHrgymOCWmNAgC0M67dP2k5X70DAu7GYHe/zAhswo4APKy6N3p/3Qv5Ne0b33TLSK7qqCQ4ANCu
Spj5vuWN/Jo2656XeNVhL7YFIJqRcXl8+zseyW8IChSmWMZWQ7IDYM1+0mXzxXI1s7r6Yu67+HPL
y1TCNcNesHG+urqzn3AyqeYvpAB4v2jTZKF0/qy/yBqChXLPPJTfFJuW78+1yvPZso1+uvjePQDz
VqM/uWw2axbxz+eeyq9pJezMGB3d3qx2LJjOWdqSLAAYb/BHfXpn0LB3iU+MeCy/puHAzD42/3X0
XYO/bDcsBgEfgDWubbpzxFtR26glpMlNVoP9YUhGmvPAwtMij/vamjAAkX3O+7H1Qz5D+HDMjwSi
t3gsuOQ+Utnn6W77vK/DAaDNGf6tHau9/QpH3KoP8kPmdpd2Lfa4yCpnC0txNMNBADhWzd131lsp
HlR9yiGMIoeWAaqRzUErAiekeQCAvYHBE5u3mdjTMB5zV/4AoL3FsWmj5jwdiOBq7TkBcGHWKRxi
EHAAyIVryxBGpNjFKEc3zJt5bswegDGz3WHF/lyPCRu7/pUUuYLPZJ8mcGVW57ImBIwAmOXPzTts
a7geqUbruCFUhy7tHzWHcJkQMABglr/jtKtFoXGZpD1pakPHHYdnR1N2CCAAeyb5q45aDWas+DkA
NG0Hej50eNYcrJDFlRAAGDaufzkBiSAMwNcBYBwCzknzH4xbWw6MpgyAceOeURewakIhCd9riYAC
mnNefaeNyk2dHdn7AESNBymh+FOwT9S9PwQYaRyG9YXz46Npo3h9zPoAGF0PYlZN0Db9LyUCGYMi
GZORgkHAfsLzHQDbEvJDMZ3sle8AnLHe4yLsmhC4i7m6BWDJsAAWxKyasBkHkT4Ma5aQE9aIQG4a
AYgYzg1pQZUO9oB3AQAAoUinQi9EGihlMwIAGOxMSUGnLpSSyQZRVQ6ORIKVXBYMZsMSA2AJFQXh
PODzYGeApsHmLuiJNCR53dQ9uAagiD+/Fe0fhqBEETMCgo1LNIz0ED918Q6AYxwY4mfapusPQEwv
OLuaE6EKrR/fABDNw2/iRp0FBmYtEPmxksuB8EuY8t07wA8ZQamJr2aH7C07ReTR5fJKPpZPTm64
CHSNvN5v7NZb+VT1wm5HAkVM2BZhMGLv9ACI4i8uSjFtGdqxoGHMI9ndEWPzYQms8rn1B5YPgmHI
6UTICNbunj1tyDAA3Fg119lrVtEwo+ZkqvqYc7uRHbMFY8QKN2DdRT0r1Id2tKEIKFRxN2b9BnvP
Yt5McbJKl50OTeOpwZeaFoPgA3tkX5xxNOTXI0O4BbhKwWYHzBb/gTGuj6por2aPcwOxWvyoJ1gF
Cy44Ryf78RAcE2OuwjrZJrDC/ftri7iuht0YGLUIRGvx42PZCcbJLobUhiUmPQS91AQXqWu6Yu/N
8P5esYytsKtB2bB66YA7cJhq29KEKbKNU3PI0E1LHAKwBnE9wkXdkvYsG92xfokLG9i8hcU/NjqM
hkz91PbfizUEhWV5u+CltSjWWkvbJiIny0s6AGVYTIGJbptdhkODPRX2RJoCPZTnErWN7rUyYZXs
XuJNNDAMimxgDzcGncZDvPAakThLKKnIUQPeGtqrFzuGFdHi8BgxsJdLFw0DgnfkBsSc0zJOypxt
KTZkMe2K8w5TAQCYG/wrlNzUm72/tw1Fb/jjFWaVntvqrkaRc4SEo+tkbJlAelDK6zzaGdKsUhz1
zoZdzPGWbd+wm93ZF8+h6WNuk2jpvp3xaKvnVE22/wpM+g2L2KFsqXcYesbPcrweIJM7ViCU7PqO
sj8y7fKU/cjX22BN78c0gekzKQXAwtqEZZD7yuGtQWTVrhJKLr3+cvgLU7PDW9+z6xtqHRf6P4IR
mas5wOEOXB3sx6wtAFsc/er9xUTaOsy+9a73yo1NMFpyCgmNHSz2qgNtzZZK64sHxpVzEACYzWBg
YbzwK9GyWbrCfoTz1KCIGeAiXtx/+frN9cr16M3e2Oxy0SIL+fbx0o3ee+cXaDtCYE2iADhVgecC
AFv9IAAlEfa44vdrLzDfYLskWxTp+wOMgZrIRvs0+5FfBR6mAJMVDLmDb0gCEK9yfIOaRb6uAP1g
gDEo+B7r9wVGVP6xs8Ee6Bs5p9hvu4NvnDryxqHYCPo9TSEyc2WJ8HiOXxA23cXbr3kCyxHflQzh
Jq1bCwCWa+MY3srOzJnp4Mh43BmIEhud77htk/M98dOkesJEtnDh5LueYcvTW9fq8h7uYJxw36JL
TuPlgfWKFyk6XXKXnMKZ0WeGBzqJScOKzAtw7VLU8FC9UDZs4Dz/q5s0tm63R0KBkte0lEm7aHjw
/YgthFYBpVW7l3imZxfzNZ3hH5es8wXa58uCAPM8c6s2z+9a2YTG7QTi2H1HdTHKLb67sujSIWdo
dHMiJaAfcASK2Kwk1sFHG9Yv8ZTHT3VnyqXsS+4IpM1dne2sLzYRh1qzUNr8Ifs/zzP2zDKNxcaN
ZQ1bnXeAPGd/T6UG+2s1qu8c81dcpM6OV5bmujRdiZi/FveTnluIsmJnFq5YKGM57nEfWHje5e/D
6sZE4pomSqvPn4lFecjXDwAB+c7hee45pGkffcXPD83xXdagBki7Z+UBgAl4yn9ikzMLGk7fpcIx
puUtzD1swmQDKKoK6q6VUX7a7OWJCZSfju6bR86Mlb+CbRpJ53bJAQB1N275zCYaW2ITYimF0wnY
DrPWNWjgyCV/6x9NcXWbtXY6s9hDKtdZ3hR3u7RXEwddELLJwpENZmCYlk9WUwAAXGwSFxwREBye
5LMVFQCAbSCYG9dghZG/4EEBADBwrAQCANtkcvKNqNQRYsqh1P0uqgT7sMJtVyoAgBlbpVyWLIFn
Qrq2vBoAYJHz/3oJg7lUIVtFBQBIZQ/i9l0wu10FA0AbdBz/5Ye7rvIKzSgVUwO1XbZkoDxBhoPK
dW9KAFSDXARgCVAJ1lcCYJPx0PAdAPBnBna/ACwCvmsCcBJyESBFDAD6rWhrpzkT1BSaUWlHDQAI
aVDQRaQIDgJKZRvUAIBYVXmThBQtgMkgwCs2osCGvzfujbGO1ZJ2FavKNhgf/qbNQNyEizhpegCO
GB9ptZbcUQTciMJJTl4AABHDvqbOQQhKTS1rWbWwMmjDft7BDTqo0iaoDkBA6bOgBioWL1MF4NNA
5gBE4golTnsIAGZu+TcHYAaoWiKUAQDjuG/30GNUtWrlCmUA0Ed/5RMAa3QzgKC8PsyBDZ8AmKGb
AQQAwBzw6TyA5wDl2i3qAGApGfH8TRUCY1hOuYIvwQ0ToAutq7cmQBDApqgF0QAAOScxP+xCEItP
YIYhAAAr+nh0H5aBwClMUL2I4pIVOBP7oArgQZDADEUBwDmMSW/LKvcITCEUlSsoAEDFzPtlME07
3kjuGcJ0L+qboMyEmidFEVsSAHBd9uA+NANBRiLJnkNz0xTYqD3WBttx4ulGAwD4yERq2ylQhnYJ
pAIA63B4uhNixRcadyTRZWv4Ybz0lNMXMSUCYBSmZlm9OUsCZ2SepoYl1XV7kCWV9c5HdAEDgCgi
gQoA3AlVAjbsCQ6eMaKrbMguXJz0YQiAKUzRIeYBAFj9wKvI2SKATHWXDd2Vm5DuE7/yRP4TL6YZ
HQCbXrBnoI4Xs4zw0tWmF/wBXXiCMCEAOAS80AUwmYhO2aK8dheT7+mLbKIhhDAylxIAHAI/ylPT
j73RtkkvXha7HFadKNdYUgDO1GUTIdIllvbq7aIvAJxSskwLwGcuLseVphjphYbEl6//xAcAfkrK
MTEAEreCuqYV0sssaAEYl6/G5IJI/W+0AFTVpROgXcohQArAgqvrseVJoDxzMABAJp9+UJSnA44i
iIUVKHPUSAEogvzU1+7g/RiU6SmUALRBCxC69sQVYY0dwvQUjw5D4vX+xQmquROG5lMCAE5iLwLm
wOp4ej8BAMOwF94hKFRKmKRHCQA7DRvy+SOXi7udqnOlYiNN/eznn//izPAT22QJ/Y+UALBsZkzj
Wbjxnefcbd6/vGnoV/z27z0AyOBdtaO4m/Ch79+19OuPHgAW0lIQb+k3fXf7b3/3sQOQYeqLeEu/
Z+vdHz52ACCmR9yQ8Uf20tbHDgBkuYtf4RICEAIQAhACEAIQAhACEAIQAhACEAIQAhACEAIQAhAC
EAIQAhACEALwsQIAlZbEW3rMXvrTxw4AKznootran1mw1QOH9u89ACzNwU3MxF/uXvor/Oh0X+E9
AgA/9vStm8tVltPf/n7z0j+gPBeUcC3cTwAsrmMfXc7pesdlnuc///VvXf/Pf/8HP0EoNmFWFiUA
kENu8oJdyST5PTQ1AkGIR/cTAG8LTWOC9j1NmHjKOPQgSApypnKEMXiUAEB9TYurlVUI0lEoU7JI
AyWhvkmLurriS0BXsYikdwDgPeYp2lDRVxCGXKOsV0UKQBuj5VOEY2BhG0OFqfKm6QHA0nrdD1Xd
o5H+ctJwE2X8HqfMjJoSJurV14oz4ZFJel3lWi3vAeBcNVqbufxCtrUHs8XBLKw8UeUEbwDAwmp9
yqYzU64HwsKTdf7NtWduW/IXgPE8l2s9NrkzLC7869KKVQIe6QroAQDaknXaTC61f/He6f1PLtc7
NtmHi9SJGOQAaG9ruh3F0uvzT15xdvKFTy5mEx2HrKM07QLgCQDaksjF3a2DYvm0dEMjiZlisibw
kj5D/f09AUAbLYgI455iW+q8+QKApj2vq4trpt0NUgXIWwC0yIdToTEtLP2IVxXKPAKAFIPmBn1B
Dh8A6GHwdl/wAntLiqfmr7xk0VsAejQ934jLSp9f3iTf9nwHoEvROWvFzpJi5SNfbi7yA4AeLZxt
LArn1idnjjyc9cEAcE1LLyYW7TfIbLM8+8HryrzBAXBN7cPz2eVGJ280cuTThYmd50v0mt79A6BP
kUqX5uYOK5Wr4JjQhkIKKaSQQgoppC8t/R/dov80OkxKRAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAy
MC0wNS0xNFQxMTo1MDoyOSswMDowMIfyupMAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMDUtMTRU
MTE6NTA6MjkrMDA6MDD2rwIvAAAAAElFTkSuQmCC" />
</svg>
<a title="主要是想看下自己还能在多做些什么
" href="/">JAVA 牛牛</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item navigation__item--active"><a href="/home/">Home</a></li><li class="navigation__item"><a href="/module.html">模块</a></li><li class="navigation__item"><a href="/leetcode/all">leetcode(力扣)</a></li><li class="navigation__item"><a href="/algo/all">algo(算法)</a></li><li class="navigation__item"><a href="/docker/about">Docker</a></li><li class="navigation__item"><a href="/todo">TODO</a></li><li class="navigation__item"><a href="/pm">PM</a></li><li class="navigation__item"><a href="/archive.html">Archive</a></li><li class="navigation__item"><a href="/about.html">About</a></li><li class="navigation__item"><a href="https://github.com/javaniuniu">GitHub</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/WebPage"><header style="display:none;"><h1>Home</h1></header><meta itemprop="headline" content="Home"><meta itemprop="author" content="java牛牛"/><div class="js-article-content"><div class="layout--articles"><div class="article-list items items--divided"><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/Index"><h2 itemprop="headline" class="item__header">索引简介</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="索引定义">索引定义</h3>
<p>官方定义：索引（Index） 是帮助MySQL高效获取数据的数据结构。
大家一定很好奇，索引为什么是一种数据结构，它又是怎么提高查询的速度？我们拿最常用的二叉树来分析索引的工作原理。看下面的图片：</p>

<p><img src="/assets/images/mysql/0622/806956-20180103215956799-1078068423.png" alt="1" /></p>

<p><strong>创建索引的优势</strong></p>
<ol>
  <li>提高数据的检索速度，降低数据库IO成本：使用索引的意义就是通过缩小表中需要查询的记录的数目从而加快搜索的速度。</li>
  <li>降低数据排序的成本，降低CPU消耗：索引之所以查的快，是因为先将数据排好序，若该字段正好需要排序，则真好降低了排序的成本。</li>
</ol>

<p><strong>创建索引的劣势</strong></p>
<ol>
  <li>占用存储空间：索引实际上也是一张表，记录了主键与索引字段，一般以索引文件的形式存储在磁盘上。</li>
  <li>降低更新表的速度：表的数据发生了变化，对应的索引也需要一起变更，从而减低的更新速度。否则索引指向的物理数据可能不对，这也是索引失效的原因之一。</li>
  <li>优质索引创建难：索引的创建并非一日之功，也并非一直不变。需要频繁根据用户的行为和具体的业务逻辑去创建最佳的索引。</li>
</ol>

<h3 id="索引分类">索引分类</h3>
<p>我们常说的索引一般指的是BTree（多路搜索树）结构组织的索引。其中还有聚合索引，次要索引，复合索引，前缀索引，唯一索引，统称索引，当然除了B+树外，还有哈希索引（hash index）等。</p>

<ul>
  <li><strong>单值索引</strong>：一个索引只包含单个列，一个表可以有多个单列索引</li>
  <li><strong>唯一索引</strong>：索引列的值必须唯一，但允许有空值</li>
  <li><strong>复合索引</strong>：一个索引包含多个列，实际开发中推荐使用</li>
</ul>

<p>实际开发中推荐使用复合索引，并且单表创建的索引个数建议不要超过五个</p>

<h4 id="基本语法">基本语法：</h4>
<p><strong>创建：</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">create</span><span class="w"> </span><span class="p">[</span><span class="kt">unique</span><span class="p">]</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">indexName</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">tableName</span><span class="w"> </span><span class="p">(</span><span class="nf">columnName...</span><span class="p">)</span><span class="w">
</span><span class="nf">alter</span><span class="w"> </span><span class="nx">tableName</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="p">[</span><span class="kt">unique</span><span class="p">]</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">[</span><span class="kt">indexName</span><span class="p">]</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="p">(</span><span class="nf">columnName...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><strong>删除：</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">drop</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">[</span><span class="kt">indexName</span><span class="p">]</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">tableName</span><span class="w">
</span></code></pre></div></div>
<p><strong>查看：</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">show</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">tableName</span><span class="w">
</span></code></pre></div></div>

<h4 id="哪些情况需要建索引">哪些情况需要建索引：</h4>
<ol>
  <li>主键，唯一索引</li>
  <li>经常用作查询条件的字段需要创建索引</li>
  <li>经常需要排序、分组和统计的字段需要建立索引</li>
  <li>查询中与其他表关联的字段，外键关系建立索引</li>
</ol>

<h4 id="哪些情况不要建索引">哪些情况不要建索引：</h4>
<ol>
  <li>表的记录太少，百万级以下的数据不需要创建索引</li>
  <li>经常增删改的表不需要创建索引</li>
  <li>数据重复且分布平均的字段不需要创建索引，如 true,false 之类。</li>
  <li>频发更新的字段不适合创建索引</li>
  <li>where条件里用不到的字段不需要创建索引</li>
</ol>

<h3 id="性能分析">性能分析</h3>
<h4 id="mysql-自身瓶颈">MySQL 自身瓶颈</h4>

<p>MySQL自身参见的性能问题有磁盘空间不足，磁盘I/O太大，服务器硬件性能低。</p>
<ol>
  <li>CPU：CPU 在饱和的时候一般发生在数据装入内存或从磁盘上读取数据时候</li>
  <li>IO：磁盘I/O 瓶颈发生在装入数据远大于内存容量的时候</li>
  <li>服务器硬件的性能瓶颈：top,free,iostat 和 vmstat来查看系统的性能状态</li>
</ol>

<h4 id="explain-分析sql语句">explain 分析sql语句</h4>

<p>使用explain关键字可以模拟优化器执行sql查询语句，从而得知MySQL 是如何处理sql语句。</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">-----</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">-----</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p><strong>id</strong></p>

<p>select 查询的序列号，包含一组可以重复的数字，表示查询中执行sql语句的顺序。一般有三种情况：  <br />
第一种：id全部相同，sql的执行顺序是由上至下； <br />
第二种：id全部不同，sql的执行顺序是根据id大的优先执行； <br />
第三种：id既存在相同，又存在不同的。先根据id大的优先执行，再根据相同id从上至下的执行。</p>

<p><strong>select_type</strong></p>

<p>select 查询的类型，主要是用于区别普通查询，联合查询，嵌套的复杂查询</p>
<ul>
  <li><strong>simple</strong>：简单的select 查询，查询中不包含子查询或者union</li>
  <li><strong>primary</strong>：查询中若包含任何复杂的子查询，最外层查询则被标记为primary</li>
  <li><strong>subquery</strong>：在select或where 列表中包含了子查询</li>
  <li><strong>derived</strong>：在from列表中包含的子查询被标记为derived（衍生）MySQL会递归执行这些子查询，把结果放在临时表里。</li>
  <li><strong>union</strong>：若第二个select出现在union之后，则被标记为union，若union包含在from子句的子查询中，外层select将被标记为：derived</li>
  <li><strong>union result</strong>：从union表获取结果的select</li>
</ul>

<p><strong>partitions</strong></p>

<p>表所使用的分区，如果要统计十年公司订单的金额，可以把数据分为十个区，每一年代表一个区。这样可以大大的提高查询效率。</p>

<p><strong>type</strong></p>

<p>这是一个非常重要的参数，连接类型，常见的有：all , index , range , ref , eq_ref , const , system , null 八个级别。
性能从最优到最差的排序：<strong>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all</strong>
对java程序员来说，若保证查询至少达到range级别或者最好能达到ref则算是一个优秀而又负责的程序员。</p>
<ul>
  <li><strong>all</strong>：（full table scan）全表扫描无疑是最差，若是百万千万级数据量，全表扫描会非常慢。</li>
  <li><strong>index</strong>：（full index scan）全索引文件扫描比all好很多，毕竟从索引树中找数据，比从全表中找数据要快。</li>
  <li><strong>range</strong>：只检索给定范围的行，使用索引来匹配行。范围缩小了，当然比全表扫描和全索引文件扫描要快。sql语句中一般会有between，in，&gt;，&lt; 等查询。</li>
  <li><strong>ref</strong>：非唯一性索引扫描，本质上也是一种索引访问，返回所有匹配某个单独值的行。比如查询公司所有属于研发团队的同事，匹配的结果是多个并非唯一值。</li>
  <li><strong>eq_ref</strong>：唯一性索引扫描，对于每个索引键，表中有一条记录与之匹配。比如查询公司的CEO，匹配的结果只可能是一条记录，</li>
  <li><strong>const</strong>：表示通过索引一次就可以找到，const用于比较primary key 或者unique索引。因为只匹配一行数据，所以很快，若将主键至于where列表中，MySQL就能将该查询转换为一个常量。</li>
  <li><strong>system</strong>：表只有一条记录（等于系统表），这是const类型的特列，平时不会出现，了解即可</li>
</ul>

<p><strong>possible_keys</strong></p>

<p>显示查询语句可能用到的索引(一个或多个或为null)，不一定被查询实际使用。仅供参考使用。</p>

<p><strong>key</strong></p>

<p>显示查询语句实际使用的索引。若为null，则表示没有使用索引。</p>

<p><strong>key_len</strong></p>

<p>显示索引中使用的字节数，可通过key_len计算查询中使用的索引长度。在不损失精确性的情况下索引长度越短越好。key_len 显示的值为索引字段的最可能长度，并非实际使用长度，即key_len是根据表定义计算而得，并不是通过表内检索出的。</p>

<p><strong>ref</strong></p>

<p>显示索引的哪一列或常量被用于查找索引列上的值。</p>

<p><strong>rows</strong></p>

<p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数，值越大越不好。</p>

<p><strong>extra</strong></p>

<ul>
  <li><strong>Using filesort</strong>： 说明MySQL会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL中无法利用索引完成的排序操作称为“文件排序” 。出现这个就要立刻优化sql。</li>
  <li><strong>Using temporary</strong>： 使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于排序 order by 和 分组查询 group by。 出现这个更要立刻优化sql。</li>
  <li><strong>Using index</strong>： 表示相应的select 操作中使用了覆盖索引（Covering index），避免访问了表的数据行，效果不错！如果同时出现Using where，表明索引被用来执行索引键值的查找。如果没有同时出现Using where，表示索引用来读取数据而非执行查找动作。</li>
  <li><strong>覆盖索引（Covering Index）</strong> ：也叫索引覆盖，就是select 的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select 列表中的字段，而不必根据索引再次读取数据文件。</li>
  <li><strong>Using index condition</strong>： 在5.6版本后加入的新特性，优化器会在索引存在的情况下，通过符合RANGE范围的条数 和 总数的比例来选择是使用索引还是进行全表遍历。</li>
  <li><strong>Using where</strong>： 表明使用了where 过滤</li>
  <li><strong>Using join buffer</strong>： 表明使用了连接缓存</li>
  <li><strong>impossible where</strong>： where 语句的值总是false，不可用，不能用来获取任何元素</li>
  <li><strong>distinct</strong>： 优化distinct操作，在找到第一匹配的元组后即停止找同样值的动作。</li>
</ul>

<p><strong>filtered</strong></p>

<p>一个百分比的值，和rows 列的值一起使用，可以估计出查询执行计划(QEP)中的前一个表的结果集，从而确定join操作的循环次数。小表驱动大表，减轻连接的次数。</p>

<p>通过explain的参数介绍，我们可以得知:</p>
<ol>
  <li>表的读取顺序(id)</li>
  <li>数据读取操作的操作类型(type)</li>
  <li>哪些索引被实际使用(key)</li>
  <li>表之间的引用(ref)</li>
  <li>每张表有多少行被优化器查询(rows)</li>
</ol>

<h3 id="性能下降的原因">性能下降的原因</h3>
<p><strong>从程序员的角度</strong></p>
<ol>
  <li>查询语句写的不好</li>
  <li>没建索引，索引建的不合理或索引失效</li>
  <li>关联查询有太多的join
<strong>从服务器的角度</strong></li>
  <li>服务器磁盘空间不足</li>
  <li>服务器调优配置参数设置不合理</li>
</ol>

<h3 id="总结">总结</h3>
<ol>
  <li>索引是排好序且快速查找的数据结构。其目的是为了提高查询的效率。</li>
  <li>创建索引后，查询数据变快，但更新数据变慢。</li>
  <li>性能下降的原因很可能是索引失效导致。</li>
  <li>索引创建的原则，经常查询的字段适合创建索引，频繁需要更新的数据不适合创建索引。</li>
  <li>索引字段频繁更新，或者表数据物理删除容易造成索引失效。</li>
  <li>擅用 explain 分析sql语句</li>
  <li>除了优化sql语句外，还可以优化表的设计。如尽量做成单表查询，减少表之间的关联。设计归档表等。</li>
</ol>

<p>到这里，MySQL的索引优化分析就结束了，有什么不对的地方，大家可以提出来。如果觉得不错可以点一下推荐。</p>
</div><p><a href="/mysql/Index">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=mysql">mysql</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E7%B4%A2%E5%BC%95">索引</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 22, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-06-22-02">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-22T00:00:00+08:00">
    <meta itemprop="keywords" content="mysql,索引"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/possible-keys"><h2 itemprop="headline" class="item__header">Mysql 索引优化分析</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="为什么你写的sql查询慢">为什么你写的sql查询慢？</h3>
<p>为什么你写的sql查询慢？为什么你建的索引常失效？通过本章内容，你将学会MySQL性能下降的原因，索引的简介，索引创建的原则，explain命令的使用，以及explain输出字段的意义。助你了解索引，分析索引，使用索引，从而写出更高性能的sql语句。还在等啥子？撸起袖子就是干！</p>

<h3 id="案例分析">案例分析</h3>
<p>我们先简单了解一下非 <strong>关系型数据库</strong> 和 <strong>关系型数据库</strong> 的区别。</p>
<ul>
  <li>
    <p>MongoDB是NoSQL中的一种。NoSQL的全称是Not only SQL，非关系型数据库。它的特点是 <strong>性能高，扩张性强，模式灵活</strong>，在高并发场景表现得尤为突出。<strong>但目前它还只是关系型数据库的补充，它在数据的一致性，数据的安全性，查询的复杂性问题上和关系型数据库还存在一定差距</strong> 。</p>
  </li>
  <li>
    <p>MySQL是关系性数据库中的一种，<strong>查询功能强，数据一致性高，数据安全性高，支持二级索引</strong>。但性能方面稍逊与MongoDB，特别是百万级别以上的数据，很容易出现查询慢的现象。这时候需要分析查询慢的原因，一般情况下是程序员sql写的烂，或者是没有键索引，或者是索引失效等原因导致的。</p>
  </li>
  <li>
    <p>公司ERP系统数据库主要是MongoDB（最接近关系型数据的NoSQL），其次是Redis，MySQL只占很少的部分。现在又重新使用MySQL，归功于阿里巴巴的奇门系统和聚石塔系统。考虑到订单数量已经是百万级以上，对MySQL的性能分析也就显得格外重要。</p>
  </li>
</ul>

<p>我们先通过两个简单的例子来入门。后面会详细介绍各个参数的作用和意义。
说明：需要用到的sql已经放在了github上了，喜欢的同学可以点一下star，哈哈。https://github.com/ITDragonBlog/daydayup/tree/master/MySQL/</p>

<h4 id="场景一订单导入通过交易号避免重复导单">场景一：订单导入，通过交易号避免重复导单</h4>

<p>业务逻辑：订单导入时，为了避免重复导单，一般会通过交易号去数据库中查询，判断该订单是否已经存在。</p>

<p><strong>最基础的sql语句</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">--------------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">------------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">gross</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">net</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">stock_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">order_status</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">descript</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">finance_descript</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">create_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">order_level</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">input_user</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">input_date</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">--------------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">------------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">10000</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">81X97310V32236260E</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="nx">6.6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">6.13</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="nx">10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ok</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ok</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">auto</span><span class="w">        </span><span class="o">|</span><span class="w">           </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">itdragon</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">2017</span><span class="nt">-08-18</span><span class="w"> </span><span class="mi">17</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">49</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">--------------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">------------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="w">

</span><span class="nx">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">33.33</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Using</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>查询的本身没有任何问题，在线下的测试环境也没有任何问题。可是，功能一旦上线，查询慢的问题就迎面而来。几百上千万的订单，用全表扫描？啊？哼!</p>

<p>怎么知道该sql是全表扫描呢？通过explain命令可以清楚MySQL是如何处理sql语句的。打印的内容分别表示：</p>

<ul>
  <li><strong>id</strong> : 查询序列号为1。</li>
  <li><strong>select_type</strong> : 查询类型是简单查询，简单的select语句没有union和子查询。</li>
  <li><strong>table</strong> : 表是 itdragon_order_list。</li>
  <li><strong>partitions</strong> : 没有分区。</li>
  <li><strong>type</strong> : 连接类型，all表示采用全表扫描的方式。</li>
  <li><strong>possible_keys</strong> : 可能用到索引为null。</li>
  <li><strong>key</strong> : 实际用到索引是null。</li>
  <li><strong>key_len</strong> : 索引长度当然也是null。</li>
  <li><strong>ref</strong> : 没有哪个列或者参数和key一起被使用。</li>
  <li><strong>Extra</strong> : 使用了where查询。 <br />
因为数据库中只有三条数据，所以rows和filtered的信息作用不大。这里需要重点了解的是type为ALL，全表扫描的性能是最差的，假设数据库中有几百万条数据，在没有索引的帮助下会异常卡顿。</li>
</ul>

<p><strong>初步优化：为transaction_id创建索引</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="p">(</span><span class="nf">transaction_id</span><span class="p">);</span><span class="w">
</span><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">453</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p>这里创建的索引是唯一索引，而非普通索引。  <br />
唯一索引打印的type值是const。表示通过索引一次就可以找到。即找到值就结束扫描返回查询结果。 <br />
普通索引打印的type值是ref。表示非唯一性索引扫描。找到值还要继续扫描，直到将索引文件扫描完为止。(这里没有贴出代码) <br />
显而易见，const的性能要远高于ref。并且根据业务逻辑来判断，创建唯一索引是合情合理的。</p>

<p><strong>再次优化：覆盖索引</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">transaction_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"81X97310V32236260E"</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_transaID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">453</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">--------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>这里将 <code class="language-plaintext highlighter-rouge">select * from</code> 改为了 <code class="language-plaintext highlighter-rouge">select transaction_id from</code> 后</p>

<p>Extra 显示 Using index，表示该查询使用了覆盖索引，这是一个非常好的消息，说明该sql语句的性能很好。若提示的是Using filesort(使用内部排序)和Using temporary(使用临时表)则表明该sql需要立即优化了。</p>

<p>根据业务逻辑来的，查询结构返回transaction_id 是可以满足业务逻辑要求的。</p>

<h4 id="场景二订单管理页面通过订单级别和订单录入时间排序">场景二，订单管理页面，通过订单级别和订单录入时间排序</h4>

<p>业务逻辑：优先处理订单级别高，录入时间长的订单。
既然是排序，首先想到的应该是order by， 还有一个可怕的 Using filesort 等着你。</p>

<p><strong>最基础的sql语句</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">filesort</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>首先，采用全表扫描就不合理，还使用了文件排序Using filesort，更加拖慢了性能。 <br />
MySQL在4.1版本之前文件排序是采用双路排序的算法，由于两次扫描磁盘，I/O耗时太长。后优化成单路排序算法。其本质就是用空间换时间，但如果数据量太大，buffer的空间不足，会导致多次I/O的情况。其效果反而更差。与其找运维同事修改MySQL配置，还不如自己乖乖地建索引。</p>

<p><strong>初步优化：为order_level,input_date 创建复合索引</strong></p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="p">(</span><span class="nf">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">);</span><span class="w">
</span><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">filesort</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">----------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>创建复合索引后你会惊奇的发现，和没创建索引一样？？？都是全表扫描，都用到了文件排序。是索引失效？还是索引创建失败？我们试着看看下面打印情况</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">68</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p>将 <code class="language-plaintext highlighter-rouge">select * from</code> 换成了 <code class="language-plaintext highlighter-rouge">select order_level,input_date from</code> 后。type从all升级为index，表示（full index scan）全索引文件扫描，Extra也显示使用了覆盖索引。可是不对啊！！！！检索虽然快了，但返回的内容只有order_level和input_date 两个字段，让业务同事怎么用？难道把每个字段都建一个复合索引？
MySQL没有这么笨，可以使用force index 强制指定索引。在原来的sql语句上修改 <code class="language-plaintext highlighter-rouge">force index(idx_order_levelDate)</code> 即可。</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">force</span><span class="w"> </span><span class="nx">index</span><span class="p">(</span><span class="nf">idx_order_levelDate</span><span class="p">)</span><span class="w"> </span><span class="nf">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">order_level</span><span class="p">,</span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">68</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">3</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">---------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>
<p><strong>再次优化：订单级别真的要排序么？</strong></p>

<p>其实给订单级别排序意义并不大，给订单级别添加索引意义也不大。因为order_level的值可能只有，低，中，高，加急，这四种。对于这种重复且分布平均的字段，排序和加索引的作用不大。</p>

<p>我们能否先固定 order_level 的值，然后再给 input_date 排序？如果查询效果明显，是可以推荐业务同事使用该查询方式。</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">mysql</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">explain</span><span class="w"> </span><span class="nx">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="nx">where</span><span class="w"> </span><span class="nx">order_level</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="nf">order</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">input_date</span><span class="p">;</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-----------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">table</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="nx">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">possible_keys</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">key</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="nx">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Extra</span><span class="w">                 </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-----------------------</span><span class="o">+</span><span class="w">
</span><span class="o">|</span><span class="w">  </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">itdragon_order_list</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">idx_order_levelDate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">5</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kr">Using</span><span class="w"> </span><span class="nf">index</span><span class="w"> </span><span class="nx">condition</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="o">+</span><span class="nf">----</span><span class="o">+</span><span class="nf">-------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">------------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------------------</span><span class="o">+</span><span class="nf">---------</span><span class="o">+</span><span class="nf">-------</span><span class="o">+</span><span class="nf">------</span><span class="o">+</span><span class="nf">----------</span><span class="o">+</span><span class="nf">-----------------------</span><span class="o">+</span><span class="w">
</span></code></pre></div></div>

<p>和之前的sql比起来，type从index 升级为 ref(非唯一性索引扫描)。索引的长度从68变成了5，说明只用了一个索引。ref也是一个常量。Extra 为Using index condition 表示自动根据临界值，选择索引扫描还是全表扫描。总的来说性能远胜于之前的sql。</p>

<p>上面两个案例只是快速入门，我们需严记一点：优化是基于业务逻辑来的。绝对不能为了优化而擅自修改业务逻辑。如果能修改当然是最好的。</p>
</div><p><a href="/mysql/possible-keys">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=mysql">mysql</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%E7%B4%A2%E5%BC%95">索引</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 22, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-06-22-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-22T00:00:00+08:00">
    <meta itemprop="keywords" content="mysql,索引"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/spring/thread/security"><h2 itemprop="headline" class="item__header">Spring 中的bean 是线程安全的吗</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="结论-不是线程安全的"><strong>结论： 不是线程安全的</strong></h3>
<h3 id="概要">概要</h3>
<p>Spring容器中的Bean是否线程安全，容器本身并没有提供Bean的线程安全策略，因此可以说 <strong>Spring容器中的Bean本身不具备线程安全的特性，但是具体还是要结合具体scope的Bean去研究</strong>。</p>

<h4 id="spring-的-bean-作用域scope类型">Spring 的 bean 作用域（scope）类型</h4>
<ol>
  <li>singleton:单例，默认作用域。</li>
  <li>prototype:原型，每次创建一个新对象。</li>
  <li>request:请求，每次Http请求创建一个新对象，适用于WebApplicationContext环境下。</li>
  <li>session:会话，同一个会话共享一个实例，不同会话使用不用的实例。</li>
  <li>global-session:全局会话，所有会话共享一个实例。</li>
</ol>

<p><strong>线程安全这个问题，要从单例与原型Bean分别进行说明。</strong></p>

<h4 id="原型bean">原型Bean</h4>
<p>对于原型Bean,每次创建一个新对象，也就是线程之间并不存在Bean共享，自然是不会有线程安全的问题。</p>

<h4 id="单例bean">单例Bean</h4>
<p>对于单例Bean,所有线程都共享一个单例实例Bean,因此是存在资源的竞争。</p>

<p>如果单例Bean,是一个 <strong>无状态Bean</strong>，也就是线程中的操作不会对Bean的成员执行 <strong>查询</strong> 以外的操作，那么这个单例Bean是线程安全的。比如Spring mvc 的 Controller、Service、Dao等，这些Bean大多是无状态的，只关注于方法本身。</p>

<h3 id="spring单例为什么controllerservice和dao确能保证线程安全">spring单例，为什么controller、service和dao确能保证线程安全？</h3>
<ul>
  <li>Spring中的Bean默认是单例模式的，框架并没有对bean进行多线程的封装处理。</li>
  <li>实际上大部分时间Bean是无状态的（比如Dao） 所以说在某种程度上来说Bean其实是安全的。</li>
  <li>但是 <em>如果Bean是有状态的 那就需要开发人员自己来进行线程安全的保证</em> ，最简单的办法就是改变bean的作用域 把 “singleton”改为’‘protopyte’ 这样每次请求Bean就相当于是 new Bean() 这样就可以保证线程的安全了。</li>
</ul>

<p><strong>有状态就是有数据存储功能</strong><br />
<strong>无状态就是不会保存数据</strong></p>

<ul>
  <li>controller、service和dao层本身并不是线程安全的，只是如果只是调用里面的方法，而且多线程调用一个实例的方法，会在内存中复制变量，这是自己的线程的工作内存，是安全的。</li>
</ul>

<p>想理解原理可以看看《深入理解JVM虚拟机》，2.2.2节：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Java虚拟机栈是线程私有的，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。
</code></pre></div></div>

<p>《Java并发编程实战》第3.2.2节：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>局部变量的固有属性之一就是封闭在执行线程中。
它们位于执行线程的栈中，其他线程无法访问这个栈。
</code></pre></div></div>

<p><strong>所以其实任何无状态单例都是线程安全的。</strong> <br />
Spring的根本就是通过大量这种单例构建起系统，以事务脚本的方式提供服务</p>

<h3 id="关于spring的controller-service等的线程安全问题">关于Spring的@Controller @Service等的线程安全问题</h3>

<p>首先问@Controller @Service是不是线程安全的？</p>

<p>答：默认配置下不是的。为啥呢？因为默认情况下@Controller没有加上@Scope，没有加@Scope就是默认值singleton，单例的。意思就是系统只会初始化一次Controller容器，所以每次请求的都是同一个Controller容器，当然是非线程安全的。举个栗子：</p>

<h4 id="默认单例模式-线程不安全">默认单例模式 (线程不安全)</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">));</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>在postman里面发三次请求，结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>普通变量var:1
普通变量var:2
普通变量var:3
</code></pre></div></div>
<p>说明他不是线程安全的。怎么办呢？可以给他加上上面说的@Scope注解，如下：　　</p>

<h4 id="使用scope注解-使用多例模式线程安全">使用@Scope注解 使用多例模式，(线程安全)</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"prototype"</span><span class="o">)</span> <span class="c1">// 加上@Scope注解，他有2个取值：单例-singleton 多实例-prototype</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">));</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>这样一来，每个请求都单独创建一个Controller容器，所以各个请求之间是线程安全的，三次请求结果：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>普通变量var:1
普通变量var:1
普通变量var:1
</code></pre></div></div>

<p>加了@Scope注解多的实例prototype是不是一定就是线程安全的呢？　　</p>

<h4 id="scope注解也不一定能保证controller-100的线程安全有static静态变量">Scope注解也不一定能保证Controller 100%的线程安全(有static静态变量)</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"prototype"</span><span class="o">)</span> <span class="c1">// 加上@Scope注解，他有2个取值：单例-singleton 多实例-prototype</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticVar</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">)+</span> <span class="s">"---静态变量staticVar:"</span> <span class="o">+</span> <span class="o">(++</span><span class="n">staticVar</span><span class="o">));</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">+</span> <span class="s">"静态变量staticVar:"</span> <span class="o">+</span> <span class="n">staticVar</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>看三次请求结果：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>普通变量var:1---静态变量staticVar:1
普通变量var:1---静态变量staticVar:2
普通变量var:1---静态变量staticVar:3
</code></pre></div></div>

<p>虽然每次都是单独创建一个Controller但是扛不住他变量本身是static的呀，所以说呢，即便是加上@Scope注解也不一定能保证Controller 100%的线程安全。<strong>所以是否线程安全在于怎样去定义变量以及Controller的配置</strong>。所以来个全乎一点的实验，代码如下：　　</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"singleton"</span><span class="o">)</span> <span class="c1">// prototype singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// 定义一个普通变量</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">staticVar</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// 定义一个静态变量</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${test-int}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">testInt</span><span class="o">;</span> <span class="c1">// 从配置文件中读取变量</span>

    <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">tl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span> <span class="c1">// 用ThreadLocal来封装变量</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span> <span class="c1">// 注入一个对象来封装变量</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/test_var"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">tl</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"先取一下user对象中的值："</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">()+</span><span class="s">"===再取一下hashCode:"</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="o">(++</span><span class="kt">var</span><span class="o">)</span> <span class="o">+</span> <span class="s">"===静态变量staticVar:"</span> <span class="o">+</span> <span class="o">(++</span><span class="n">staticVar</span><span class="o">)</span> <span class="o">+</span> <span class="s">"===配置变量testInt:"</span> <span class="o">+</span> <span class="o">(++</span><span class="n">testInt</span><span class="o">)</span>
                <span class="o">+</span> <span class="s">"===ThreadLocal变量tl:"</span> <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="na">get</span><span class="o">()+</span><span class="s">"===注入变量user:"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"普通变量var:"</span> <span class="o">+</span> <span class="kt">var</span> <span class="o">+</span> <span class="s">",静态变量staticVar:"</span> <span class="o">+</span> <span class="n">staticVar</span> <span class="o">+</span> <span class="s">",配置读取变量testInt:"</span> <span class="o">+</span> <span class="n">testInt</span> <span class="o">+</span> <span class="s">",ThreadLocal变量tl:"</span>
                <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">"注入变量user:"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getAge</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>补充Controller以外的代码：
config里面自己定义的Bean:User</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">user</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>我暂时能想到的定义变量的方法就这么多了，三次http请求结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>先取一下user对象中的值：0===再取一下hashCode:241165852
普通变量var:1===静态变量staticVar:1===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:241165852
普通变量var:2===静态变量staticVar:2===配置变量testInt:2===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:241165852
普通变量var:3===静态变量staticVar:3===配置变量testInt:3===ThreadLocal变量tl:1===注入变量user:1
</code></pre></div></div>

<p>可以看到，在单例模式下Controller中只有用ThreadLocal封装的变量是线程安全的。为什么这样说呢？我们可以看到3次请求结果里面只有ThreadLocal变量值每次都是从0+1=1的，其他的几个都是累加的，而user对象呢，默认值是0，第二交取值的时候就已经是1了，关键他的hashCode是一样的，说明每次请求调用的都是同一个user对象。
下面将TestController 上的@Scope注解的属性改一下改成多实例的：@Scope(value = “prototype”)，其他都不变，再次请求，结果如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>先取一下user对象中的值：0===再取一下hashCode:853315860
普通变量var:1===静态变量staticVar:1===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:853315860
普通变量var:1===静态变量staticVar:2===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：1===再取一下hashCode:853315860
普通变量var:1===静态变量staticVar:3===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
</code></pre></div></div>

<p>分析这个结果发现，多实例模式下普通变量，取配置的变量还有ThreadLocal变量都是线程安全的，而静态变量和user（看他的hashCode都是一样的）对象中的变量都是非线程安全的。也就是说尽管TestController 是每次请求的时候都初始化了一个对象，但是静态变量始终是只有一份的，而且这个注入的user对象也是只有一份的。静态变量只有一份这是当然的咯，那么有没有办法让user对象可以每次都new一个新的呢？当然可以：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Scope</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"prototype"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">user</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">();</span>
    <span class="o">}</span>    
<span class="o">}</span>
</code></pre></div></div>

<p>在config里面给这个注入的Bean加上一个相同的注解@Scope(value = “prototype”)就可以了，再来请求一下看看：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>先取一下user对象中的值：0===再取一下hashCode:1612967699
普通变量var:1===静态变量staticVar:1===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：0===再取一下hashCode:985418837
普通变量var:1===静态变量staticVar:2===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
先取一下user对象中的值：0===再取一下hashCode:1958952789
普通变量var:1===静态变量staticVar:3===配置变量testInt:1===ThreadLocal变量tl:1===注入变量user:1
</code></pre></div></div>

<p>可以看到每次请求的user对象的hashCode都不是一样的，每次赋值前取user中的变量值也都是默认值0。</p>
<h3 id="总结">总结</h3>

<ol>
  <li>在@Controller/@Service等容器中，默认情况下，scope值是单例-singleton的，也是线程不安全的。</li>
  <li>尽量不要在@Controller/@Service等容器中定义静态变量，不论是单例(singleton)还是多实例(prototype)他都是线程不安全的。</li>
  <li>默认注入的Bean对象，在不设置scope的时候他也是线程不安全的。</li>
  <li>一定要定义变量的话，用ThreadLocal来封装，这个是线程安全的</li>
</ol>
</div><p><a href="/spring/thread/security">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=spring">spring</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=%F0%9F%8C%9F%F0%9F%8C%9F%F0%9F%8C%9F%F0%9F%8C%9F%F0%9F%8C%9F">🌟🌟🌟🌟🌟</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 21, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="spring-2020-06-21-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-21T00:00:00+08:00">
    <meta itemprop="keywords" content="spring,🌟🌟🌟🌟🌟"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/mysql/partition"><h2 itemprop="headline" class="item__header">Mysql 分区表-分区操作</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="视频参考链接">视频参考链接</h3>
<p><a href="https://www.bilibili.com/video/BV1E7411q7Nx?p=1">MySQL分区</a></p>

<h3 id="一查看mysql是否支持分区">一、查看MySQL是否支持分区</h3>
<h4 id="1mysql56以及之前版本">1、MySQL5.6以及之前版本</h4>

<p>show variables like ‘%partition%’;</p>

<p><img src="/assets/images/mysql/0620/1530782-20181221101618516-1766491003.png" alt="1" /></p>

<h4 id="2mysql57">2、MySQL5.7</h4>

<p>show plugins;</p>

<p><img src="/assets/images/mysql/0620/1530782-20181221101735004-398510033.png" alt="2" /></p>

<h3 id="二分区表的分类与限制">二、分区表的分类与限制</h3>
<h4 id="1分区表分类">1、分区表分类</h4>

<p><strong>RANGE分区</strong>：基于属于一个给定连续区间的列值，把多行分配给分区。</p>

<p><strong>LIST分区</strong>：类似于按RANGE分区，区别在于LIST分区是基于列值匹配一个离散值集合中的某个值来进行选择。</p>

<p><strong>HASH分区</strong>：基于用户定义的表达式的返回值来进行选择的分区，该表达式使用将要插入到表中的这些行的列值进行计算。这个函数可以包含MySQL 中有效的、产生非负整数值的任何表达式。</p>

<p><strong>KEY分区</strong>：类似于按HASH分区，区别在于KEY分区只支持计算一列或多列，且MySQL服务器提供其自身的哈希函数。必须有一列或多列包含整数值。</p>

<p><strong>复合分区</strong>：在MySQL 5.6版本中，只支持RANGE和LIST的子分区，且子分区的类型只能为HASH和KEY。</p>

<h4 id="2分区表限制">2、分区表限制</h4>

<p>1）分区键必须包含在表的所有主键、唯一键中。</p>

<p>2）MYSQL只能在使用分区函数的列本身进行比较时才能过滤分区，而不能根据表达式的值去过滤分区，即使这个表达式就是分区函数也不行。</p>

<p>3）最大分区数： 不使用NDB存储引擎的给定表的最大可能分区数为8192（包括子分区）。如果当分区数很大，但是未达到8192时提示 Got error … from storage engine: Out of resources when opening file,可以通过增加open_files_limit系统变量的值来解决问题，当然同时打开文件的数量也可能由操作系统限制。</p>

<p>4）不支持查询缓存： 分区表不支持查询缓存，对于涉及分区表的查询，它自动禁用。 查询缓存无法启用此类查询。</p>

<p>5）分区的innodb表不支持外键。</p>

<p>6）服务器SQL_mode影响分区表的同步复制。 主机和从机上的不同SQL_mode可能会导致sql语句; 这可能导致分区之间的数据分配给定主从位置不同，甚至可能导致插入主机上成功的分区表在从库上失败。 为了获得最佳效果，您应该始终在主机和从机上使用相同的服务器SQL模式。</p>

<p>7）ALTER TABLE … ORDER BY： 对分区表运行的ALTER TABLE … ORDER BY列语句只会导致每个分区中的行排序。</p>

<p>8）全文索引。 分区表不支持全文索引，即使是使用InnoDB或MyISAM存储引擎的分区表。  <br />
9）分区表无法使用外键约束。  <br />
10）Spatial columns： 具有空间数据类型（如POINT或GEOMETRY）的列不能在分区表中使用。 <br />
11）临时表： 临时表不能分区。  <br />
12）subpartition问题： subpartition必须使用HASH或KEY分区。 只有RANGE和LIST分区可能被分区; HASH和KEY分区不能被子分区。 <br />
13）分区表不支持mysqlcheck，myisamchk和myisampack。</p>

<h3 id="三创建分区表">三、创建分区表</h3>
<h4 id="1range分区">1、range分区</h4>

<p>1）行数据基于一个给定的连续区间的列值放入分区。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`test_11`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`t`</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">,</span><span class="nv">`t`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>
 <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">to_days</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="p">(</span><span class="n">PARTITION</span> <span class="n">p20170801</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">736907</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">,</span>
 <span class="n">PARTITION</span> <span class="n">p20170901</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">736938</span><span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">,</span>
 <span class="n">PARTITION</span> <span class="n">pmax</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="k">maxvalue</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span><span class="p">);</span><span class="mi">123456789</span>
</code></pre></div></div>

<p>2）然后插入4条数据：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">test_11</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">"20170722"</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="nv">"20170822"</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="nv">"20170823"</span><span class="p">),(</span><span class="mi">4</span><span class="p">,</span><span class="nv">"20170824"</span><span class="p">);</span><span class="mi">1</span>
</code></pre></div></div>
<p>3）然后查看information下partitions对分区别信息的统计：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">PARTITION_NAME</span> <span class="k">as</span> <span class="nv">"分区"</span><span class="p">,</span><span class="n">TABLE_ROWS</span> <span class="k">as</span> <span class="nv">"行数"</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">partitions</span> <span class="k">where</span> <span class="n">table_schema</span><span class="o">=</span><span class="nv">"mysql_test"</span> <span class="k">and</span> <span class="k">table_name</span><span class="o">=</span><span class="nv">"test_11"</span><span class="p">;</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-----------+--------+
| 分区      | 行数   |
+-----------+--------+
| p20170801 |      1 |
| p20170901 |      3 |
+-----------+--------+
2 rows in set (0.00 sec)12345678
</code></pre></div></div>
<p>可以看出分区p20170801插入1行数据，p20170901插入的3行数据。
可以是用year、to_days、unix_timestamp等函数对相应的时间字段进行转换，然后分区。</p>
<h3 id="2list分区">2、list分区</h3>

<p>和range分区一样，只是list分区面向的是离散的值</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">h2</span> <span class="p">(</span>
    <span class="o">-&gt;</span>   <span class="n">c1</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="o">-&gt;</span>   <span class="n">c2</span> <span class="nb">INT</span>
    <span class="o">-&gt;</span> <span class="p">)</span>
    <span class="o">-&gt;</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">LIST</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="p">(</span>
    <span class="o">-&gt;</span>   <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="o">-&gt;</span>   <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span> <span class="n">sec</span><span class="p">)</span><span class="mi">123456789</span>
</code></pre></div></div>
<p>与RANGE分区的情况不同，没有“catch-all”，如MAXVALUE; 分区表达式的所有预期值应在PARTITION … VALUES IN（…）子句中涵盖。 包含不匹配的分区列值的INSERT语句失败并显示错误，如此示例所示：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">h2</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="n">ERROR</span> <span class="mi">1525</span> <span class="p">(</span><span class="n">HY000</span><span class="p">):</span> <span class="k">Table</span> <span class="n">has</span> <span class="k">no</span> <span class="n">partition</span> <span class="k">for</span> <span class="n">value</span> <span class="mi">312</span>
</code></pre></div></div>
<h4 id="3hash分区">3、hash分区</h4>

<p>根据用户自定义表达式的返回值来进行分区，返回值不能为负数</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="p">(</span><span class="n">col1</span> <span class="nb">INT</span><span class="p">,</span> <span class="n">col2</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">col3</span> <span class="nb">DATE</span><span class="p">)</span>
    <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span> <span class="nb">YEAR</span><span class="p">(</span><span class="n">col3</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">PARTITIONS</span> <span class="mi">4</span><span class="p">;</span><span class="mi">123</span>
</code></pre></div></div>
<p>如果你插入col3的数值为’2005-09-15’，那么根据以下计算来选择插入的分区：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">MOD</span><span class="p">(</span><span class="nb">YEAR</span><span class="p">(</span><span class="s1">'2005-09-01'</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">=</span>  <span class="k">MOD</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">=</span>  <span class="mi">1123</span>
</code></pre></div></div>
<h4 id="4key分区">4、key分区</h4>

<p>根据MySQL数据库提供的散列函数进行分区</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">k1</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">KEY</span><span class="p">()</span>
<span class="n">PARTITIONS</span> <span class="mi">2</span><span class="p">;</span><span class="mi">1234567</span>
</code></pre></div></div>
<p>KEY仅列出零个或多个列名称。 用作分区键的任何列必须包含表的主键的一部分或全部，如果该表具有一个。 如果没有列名称作为分区键，则使用表的主键（如果有）。如果没有主键，但是有一个唯一的键，那么唯一键用于分区键。但是，如果唯一键列未定义为NOT NULL，则上一条语句将失败。
与其他分区类型不同，KEY使用的分区不限于整数或空值。 例如，以下CREATE TABLE语句是有效的：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tm1</span> <span class="p">(</span>
    <span class="n">s1</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="n">PARTITIONS</span> <span class="mi">10</span><span class="p">;</span><span class="mi">12345</span>
</code></pre></div></div>
<p>注意：对于key分区表，不能执行ALTER TABLE DROP PRIMARY KEY，因为这样做会生成错误 ERROR 1466 (HY000): Field in list of fields for partition function not found in table.</p>
<h4 id="5column分区">5、Column分区</h4>

<p>COLUMN分区是5.5开始引入的分区功能，只有RANGE COLUMN和LIST COLUMN这两种分区；支持整形、日期、字符串；RANGE和LIST的分区方式非常的相似。
COLUMNS和RANGE和LIST分区的区别
1）针对日期字段的分区就不需要再使用函数进行转换了，例如针对date字段进行分区不需要再使用YEAR()表达式进行转换。  <br />
2）COLUMN分区支持多个字段作为分区键但是不支持表达式作为分区键。</p>

<h5 id="column支持的数据类型">column支持的数据类型：</h5>

<p>1）所有的整型，float和decimal不支持  <br />
2）日期类型：date和datetime，其他不支持  <br />
3）字符类型：CHAR, VARCHAR, BINARY和VARBINARY，blob和text不支持 <br />
单列的column range分区mysql&gt; show create table list_c;</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`list_c`</span> <span class="p">(</span>
  <span class="nv">`c1`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c2`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(c1)
(PARTITION p0 VALUES LESS THAN (5) ENGINE = InnoDB,
 PARTITION p1 VALUES LESS THAN (10) ENGINE = InnoDB) */</span>
</code></pre></div></div>
<p>多列的column range分区mysql&gt; show create table list_c;</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`list_c`</span> <span class="p">(</span>
  <span class="nv">`c1`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c2`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c3`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(c1,c3)
(PARTITION p0 VALUES LESS THAN (5,'aaa') ENGINE = InnoDB,
 PARTITION p1 VALUES LESS THAN (10,'bbb') ENGINE = InnoDB) */</span>
<span class="err">单列的</span><span class="k">column</span> <span class="n">list</span><span class="err">分区</span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="k">create</span> <span class="k">table</span> <span class="n">list_c</span><span class="p">;</span>
 <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`list_c`</span> <span class="p">(</span>
  <span class="nv">`c1`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c2`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`c3`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
<span class="cm">/*!50500 PARTITION BY LIST  COLUMNS(c3)
(PARTITION p0 VALUES IN ('aaa') ENGINE = InnoDB,
 PARTITION p1 VALUES IN ('bbb') ENGINE = InnoDB) */</span>
</code></pre></div></div>
<h4 id="6子分区组合分区">6、子分区（组合分区）</h4>

<p>在分区的基础上再进一步分区，有时成为复合分区;
MySQL数据库允许在range和list的分区上进行HASH和KEY的子分区。例如：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">ts</span> <span class="p">(</span><span class="n">id</span> <span class="nb">INT</span><span class="p">,</span> <span class="n">purchased</span> <span class="nb">DATE</span><span class="p">)</span>
    <span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span><span class="p">(</span> <span class="nb">YEAR</span><span class="p">(</span><span class="n">purchased</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">SUBPARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span> <span class="n">TO_DAYS</span><span class="p">(</span><span class="n">purchased</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">SUBPARTITIONS</span> <span class="mi">2</span> <span class="p">(</span>
        <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1990</span><span class="p">),</span>
        <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2000</span><span class="p">),</span>
        <span class="n">PARTITION</span> <span class="n">p2</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="k">MAXVALUE</span>
    <span class="p">);</span>
</code></pre></div></div>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@mycat-3 ~]# ll /data/mysql_data_3306/mysql_test/ts*
-rw-r----- 1 mysql mysql  8596 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts.frm
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p0#SP#p0sp0.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p0#SP#p0sp1.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p1#SP#p1sp0.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p1#SP#p1sp1.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p2#SP#p2sp0.ibd
-rw-r----- 1 mysql mysql 98304 Aug  8 13:54 /data/mysql_data_3306/mysql_test/ts#P#p2#SP#p2sp1.ibd
1234567891011121314151617
</code></pre></div></div>
<p>ts表根据purchased进行range分区，然后又进行了一次hash分区，最后形成了3*2个分区，可以从物理文件证实此分区方式。可以通过subpartition语法来显示指定子分区名称。
注意：每个子分区的数量必须相同；如果一个分区表的任何子分区已经使用subpartition，那么必须表明所有的子分区名称；每个subpartition子句必须包括子分区的一个名字；子分区的名字必须是一致的
另外，对于MyISAM表可以使用index directory和data direactory来指定各个分区的数据和索引目录，但是对于innodb表来说，因为该存储引擎使用表空间自动的进行数据和索引的管理，因此会忽略指定index和data的语法。</p>

<h3 id="四普通表转换为分区表">四、普通表转换为分区表</h3>
<p>1、用alter table table_name partition by命令重建分区表</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">alter</span> <span class="k">table</span> <span class="n">jxfp_data_bak</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">SH</span><span class="p">)</span> <span class="n">PARTITIONS</span> <span class="mi">8</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="五分区表操作">五、分区表操作</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="n">year_col</span> <span class="nb">INT</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="p">(</span><span class="n">year_col</span><span class="p">)</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1991</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1995</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">p2</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1999</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>
<h4 id="1add-partition-新增分区">1、ADD PARTITION （新增分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ADD</span> <span class="n">PARTITION</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">p3</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2002</span><span class="p">));</span>
</code></pre></div></div>
<h4 id="2drop-partition-删除分区">2、DROP PARTITION （删除分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">DROP</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="3truncate-partition截取分区">3、TRUNCATE PARTITION（截取分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">TRUNCATE</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">TRUNCATE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p3</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="4coalesce-partition合并分区">4、COALESCE PARTITION（合并分区）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t2</span> <span class="p">(</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span> <span class="p">(</span><span class="mi">30</span><span class="p">),</span>
    <span class="n">started</span> <span class="nb">DATE</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">HASH</span><span class="p">(</span> <span class="nb">YEAR</span><span class="p">(</span><span class="n">started</span><span class="p">)</span> <span class="p">)</span>
<span class="n">PARTITIONS</span> <span class="mi">6</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t2</span> <span class="n">COALESCE</span> <span class="n">PARTITION</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="5reorganize-partition拆分重组分区">5、REORGANIZE PARTITION（拆分/重组分区）</h4>

<h5 id="1拆分分区">1）拆分分区</h5>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">table</span> <span class="n">ALGORITHM</span><span class="o">=</span><span class="n">INPLACE</span><span class="p">,</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">employees</span> <span class="k">ADD</span> <span class="n">PARTITION</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p5</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2010</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">p6</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="k">MAXVALUE</span>
<span class="p">);</span>
</code></pre></div></div>
<h5 id="2重组分区">2）重组分区</h5>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">members</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">s0</span><span class="p">,</span><span class="n">s1</span> <span class="k">INTO</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1970</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tbl_name</span>
    <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">partition_list</span>
    <span class="k">INTO</span> <span class="p">(</span><span class="n">partition_definitions</span><span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">members</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">p3</span> <span class="k">INTO</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">m0</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1980</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">m1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2000</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tt</span> <span class="k">ADD</span> <span class="n">PARTITION</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="n">np</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tt</span> <span class="n">REORGANIZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span><span class="n">np</span> <span class="k">INTO</span> <span class="p">(</span>
    <span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">IN</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
    <span class="n">PARTITION</span> <span class="n">np</span> <span class="k">VALUES</span> <span class="k">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>
<h4 id="6analyze-check-partition分析与检查分区">6、ANALYZE 、CHECK PARTITION（分析与检查分区）</h4>

<p>1）ANALYZE 读取和存储分区中值的分布情况</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
</code></pre></div></div>
<p>2）CHECK 检查分区是否存在错误</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="k">ANALYZE</span> <span class="n">PARTITION</span> <span class="n">p1</span><span class="p">,</span> <span class="k">CHECK</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="7repair分区">7、REPAIR分区</h4>

<p>修复被破坏的分区</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">REPAIR</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="8optimize">8、OPTIMIZE</h4>

<p>该命令主要是用于回收空闲空间和分区的碎片整理。对分区执行该命令,相当于依次对分区执行 CHECK PARTITION, ANALYZE PARTITION,REPAIR PARTITION命令。</p>

<p>譬如:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">OPTIMIZE</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="9rebuild分区">9、REBUILD分区</h4>

<p>重建分区,它相当于先删除分区中的数据,然后重新插入。这个主要是用于分区的碎片整理。</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">REBUILD</span> <span class="n">PARTITION</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
</code></pre></div></div>
<h4 id="10exchange-partition分区交换">10、EXCHANGE PARTITION（分区交换）</h4>

<p>分区交换的语法如下:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">pt</span> <span class="n">EXCHANGE</span> <span class="n">PARTITION</span> <span class="n">p</span> <span class="k">WITH</span> <span class="k">TABLE</span> <span class="n">nt</span>
</code></pre></div></div>
<p>其中,pt是分区表,p是pt的分区(注:也可以是子分区),nt是目标表。</p>

<p>其实,分区交换的限制还是蛮多的:</p>

<p>1） nt不能为分区表</p>

<p>2）nt不能为临时表</p>

<p>3）nt和pt的结构必须一致</p>

<p>4）nt不存在任何外键约束,即既不能是主键,也不能是外键。</p>

<p>5）nt中的数据不能位于p分区的范围之外。</p>

<p>具体可参考MySQL的官方文档</p>

<h4 id="11迁移分区discard-import-">11、迁移分区（DISCARD 、IMPORT ）</h4>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">DISCARD</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="n">TABLESPACE</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">t1</span> <span class="n">IMPORT</span> <span class="n">PARTITION</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="n">TABLESPACE</span><span class="p">;</span>
</code></pre></div></div>
<p>实验环境：（都是mysql5.7）
源库：192.168.2.200      mysql5.7.16    zhangdb下的emp_2分区表的
目标库：192.168.2.100    mysql5.7.18    test下  （将zhangdb的emp表，导入到目标库的test schema下）
–：在源数据库中创建测试分区表emp_2，然后导入数据</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MySQL</span> <span class="p">[</span><span class="n">zhangdb</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">emp_2</span><span class="p">(</span>
<span class="n">id</span> <span class="nb">BIGINT</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">x</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">y</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">RANGE</span> <span class="n">COLUMNS</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">(</span>
<span class="n">PARTITION</span> <span class="n">p1</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">1000</span><span class="p">),</span>  
<span class="n">PARTITION</span> <span class="n">p2</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">2000</span><span class="p">),</span>  
<span class="n">PARTITION</span> <span class="n">p3</span> <span class="k">VALUES</span> <span class="k">LESS</span> <span class="k">THAN</span> <span class="p">(</span><span class="mi">3000</span><span class="p">)</span>     
<span class="p">);</span>  
</code></pre></div></div>
<p>（接着创建存储过程，导入测试数据）</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELIMITER</span> <span class="o">//</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="n">insert_batch</span><span class="p">()</span>
<span class="k">begin</span>
<span class="k">DECLARE</span> <span class="n">num</span> <span class="nb">INT</span><span class="p">;</span>
<span class="k">SET</span> <span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">WHILE</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">3000</span> <span class="k">DO</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">num</span><span class="o">%</span><span class="mi">10000</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">COMMIT</span><span class="p">;</span>
<span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">emp_2</span> <span class="k">VALUES</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="n">REPEAT</span><span class="p">(</span><span class="s1">'X'</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">REPEAT</span><span class="p">(</span><span class="s1">'Y'</span><span class="p">,</span> <span class="mi">500</span><span class="p">));</span>
<span class="k">SET</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="k">END</span> <span class="n">WHILE</span><span class="p">;</span>
<span class="k">COMMIT</span><span class="p">;</span>
<span class="k">END</span> <span class="o">//</span>
<span class="k">DELIMITER</span> <span class="p">;</span>
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">TABLE_NAME</span><span class="p">,</span><span class="n">PARTITION_NAME</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">partitions</span> <span class="k">where</span> <span class="n">table_schema</span><span class="o">=</span><span class="s1">'zhangdb'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------+----------------+</span>
<span class="o">|</span> <span class="k">TABLE_NAME</span> <span class="o">|</span> <span class="n">PARTITION_NAME</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+----------------+</span>
<span class="o">|</span> <span class="n">emp</span>        <span class="o">|</span> <span class="k">NULL</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">emp_2</span>      <span class="o">|</span> <span class="n">p1</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">emp_2</span>      <span class="o">|</span> <span class="n">p2</span>             <span class="o">|</span>
<span class="o">|</span> <span class="n">emp_2</span>      <span class="o">|</span> <span class="n">p3</span>             <span class="o">|</span>
<span class="o">+</span><span class="c1">------------+----------------+</span>
<span class="mi">4</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span> <span class="n">partition</span> <span class="p">(</span><span class="n">p1</span><span class="p">);</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>      <span class="mi">999</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span> <span class="n">partition</span> <span class="p">(</span><span class="n">p2</span><span class="p">);</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>     <span class="mi">1000</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span> <span class="n">partition</span> <span class="p">(</span><span class="n">p3</span><span class="p">);</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>     <span class="mi">1000</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<p>从上面可以看出，emp_2分区表已经创建完成，并且有3个子分区，每个分区都有一点数据。
–：在目标数据库中，创建emp_2表的结构，不要数据（要在源库，使用show create table emp_2\G 的方法 查看创建该表的sql）</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`emp_2`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`x`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`y`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">3000</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(id)
(PARTITION p1 VALUES LESS THAN (1000) ENGINE = InnoDB,
 PARTITION p2 VALUES LESS THAN (2000) ENGINE = InnoDB,
 PARTITION p3 VALUES LESS THAN (3000) ENGINE = InnoDB) */</span> <span class="p">;</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@localhost test]# ll
-rw-r----- 1 mysql mysql 98304 May 25 15:58 emp_2#P#p0.ibd
-rw-r----- 1 mysql mysql 98304 May 25 15:58 emp_2#P#p1.ibd
-rw-r----- 1 mysql mysql 98304 May 25 15:58 emp_2#P#p2.ibd
</code></pre></div></div>
<p>注意：
※约束条件、字符集等等也必须一致，建议使用show create table t1; 来获取创建表的SQL，否则在新服务器上导入表空间的时候会提示1808错误。
–：在目标数据库上，丢弃分区表的表空间</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">table</span> <span class="n">emp_2</span> <span class="n">discard</span> <span class="n">tablespace</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">12</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@localhost test]# ll    ---这时候在看，刚才的3个分区的idb文件都没有了
-rw-r----- 1 mysql mysql  8604 May 25 04:14 emp_2.frm
</code></pre></div></div>
<p>–：在源数据库上运行FLUSH TABLES … FOR EXPORT 锁定表并生成.cfg元数据文件，最后将cfg和ibd文件传输到目标数据库中</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="n">tables</span> <span class="n">emp_2</span> <span class="k">for</span> <span class="n">export</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@localhost zhangdb]# scp emp_2* root@192.168.2.100:/mysql/data/test/   --将文件cp到目标数据库
mysql&gt; unlock tables;   ---最后将表的锁是否
</code></pre></div></div>
<p>–：在目标数据库中对文件授权，然后导入表空间查看数据是否完整可用</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">root</span><span class="o">@</span><span class="n">localhost</span> <span class="n">test</span><span class="p">]</span><span class="o">#</span> <span class="n">chown</span> <span class="n">mysql</span><span class="p">.</span><span class="n">mysql</span> <span class="n">emp_2</span><span class="o">#*</span>
<span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">table</span> <span class="n">emp_2</span> <span class="n">import</span> <span class="n">tablespace</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">96</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">MySQL</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">emp_2</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="o">|</span>     <span class="mi">2999</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">63</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<p>从上面的查看得知，分区表都已经导入到目标数据库中了，
另外，也可以将部分子分区导入到目标数据库中，（往往整个分区表会很大，可用只将需要用到的子分区导入到目标数据库中），
将部分子分区导入到目标数据库的方法是：
1）在创建目标表的时候，只需要创建要导入的分区即可，如： 只创建了p2 p3两个分区</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`emp_2`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="nb">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`x`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`y`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">3000</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span>
<span class="cm">/*!50500 PARTITION BY RANGE  COLUMNS(id)
(
 PARTITION p2 VALUES LESS THAN (2000) ENGINE = InnoDB,
 PARTITION p3 VALUES LESS THAN (3000) ENGINE = InnoDB) */</span>
</code></pre></div></div>
<p>2）从源库cp到目标库的文件，当然也就是这俩的，就不需要其他分区的了，
3）其他的操作方法都一样了。</p>

<h3 id="六如何获取分区的相关信息">六、如何获取分区的相关信息</h3>
<ol>
  <li>通过 SHOW CREATE TABLE 语句来查看分区表的分区子句</li>
</ol>

<p>譬如:mysql&gt; show create table e/G</p>

<ol>
  <li>通过 SHOW TABLE STATUS 语句来查看表是否分区对应Create_options字段</li>
</ol>

<p>譬如:
mysql&gt; show table status/G</p>

<p><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>* 1. row **</strong><strong>**</strong><strong>**</strong><strong>**</strong>*****</p>

<p>Name: e Engine: InnoDB Version: 10 Row_format: Compact Rows: 6 Avg_row_length: 10922 Data_length: 65536Max_data_length: 0 Index_length: 0 Data_free: 0 Auto_increment: NULL Create_time: 2015-12-07 22:26:06 Update_time: NULL Check_time: NULL Collation: latin1_swedish_ci Checksum: NULL Create_options: partitioned Comment:</p>

<ol>
  <li>
    <p>查看 INFORMATION_SCHEMA.PARTITIONS表</p>
  </li>
  <li>
    <p>通过 EXPLAIN PARTITIONS SELECT 语句查看对于具体的SELECT语句,会访问哪个分区。</p>
  </li>
</ol>

<h3 id="七mysql57对于partition表的改进">七、MySQL5.7对于partition表的改进</h3>
<ul>
  <li>HANDLER statements：MySQL 5.7.1分区表开始支持HANDLER语句；</li>
  <li>index condition pushdown：MySQL5.7.3分区表开始支持ICP；</li>
  <li>load data：MySQL5.7开始使用缓存来实现性能提升，每个分区使用130KB缓冲区来实现这一点；</li>
  <li>Per-partition索引缓存：MySQL5.7开始支持使用CACHE INDEX和LOAD INDEX INTO CACHE语句对分区的MyISAM表支持索引缓存；</li>
  <li>FOR EXPORT选项（FLUSH TABLES）:MySQL 5.7.4分区的InnoDB表开始支持FLUSH TABLES语句FOR EXPORT选项；</li>
  <li>从MySQL 5.7.2开始，子分区支持ANALYZE，CHECK，OPTIMIZE，REPAIR和TRUNCATE操作；</li>
</ul>
</div><p><a href="/mysql/partition">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=mysql">mysql</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 20, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="mysql-2020-06-20-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-20T00:00:00+08:00">
    <meta itemprop="keywords" content="mysql"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/leetcode/2020/0620/001"><h2 itemprop="headline" class="item__header">35. 搜索插入位置</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><ul>
  <li><strong>难度</strong>：<code class="language-plaintext success highlighter-rouge">简单</code></li>
  <li><strong>本题涉及算法</strong>：<code class="language-plaintext success highlighter-rouge">二分查找</code></li>
  <li><strong>思路</strong>：   <code class="language-plaintext info highlighter-rouge">二分查找</code> <code class="language-plaintext info highlighter-rouge">暴力</code>   <code class="language-plaintext info highlighter-rouge">目标值插入数组</code></li>
  <li><strong>类似题型</strong>:</li>
</ul>

<hr />

<h3 id="题目-35-搜索插入位置">题目 <a href="https://leetcode-cn.com/problems/search-insert-position/">35. 搜索插入位置</a></h3>
<p>给定一个排序数组和一个目标值，在数组中找到目标值，并返回其索引。如果目标值不存在于数组中，返回它将会被按顺序插入的位置。</p>

<p>你可以假设数组中无重复元素。</p>

<h4 id="示例-1">示例 1:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>输入: [1,3,5,6], 5
输出: 2
示例 2:

输入: [1,3,5,6], 2
输出: 1
示例 3:

输入: [1,3,5,6], 7
输出: 4
示例 4:

输入: [1,3,5,6], 0
输出: 0
</code></pre></div></div>

<h3 id="方法一-二分查找">方法一 二分查找</h3>
<ul>
  <li><strong>复杂度分析</strong>：
    <ul>
      <li>时间复杂度 $O(logN)))$ ，这里 $N$   是数组的长度，每一次都将问题的规模缩减为原来的一半，因此时间复杂度是对数级别的</li>
      <li>空间复杂度 $O(1)$
        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">searchInsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
  <span class="s">"""
  :type nums: List[int]
  :type target: int
  :rtype: int
  """</span>
  <span class="n">left</span> <span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
  <span class="k">while</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">:</span>
      <span class="n">mid</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
      <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
          <span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">right</span> <span class="o">=</span> <span class="n">mid</span>
  <span class="k">return</span> <span class="n">left</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="方法二-暴力遍历">方法二 暴力遍历</h3>
<ul>
  <li><strong>复杂度分析</strong>：
    <ul>
      <li>时间复杂度 $O(logN)))$ ，这里 $N$   是数组的长度，最差情况下遍历 目标值&gt;数组最后一个值</li>
      <li>空间复杂度 $O(1)$
        <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">searchInsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">nums</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">nums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">i</span>
</code></pre></div>        </div>
        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Solution</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">searchInsert</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">,</span> <span class="kt">int</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
  <span class="kt">int</span> <span class="n">ans</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
      <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">len</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">ans</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">ans</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>
        <h3 id="方法三-目标值插入数组后在查找对于位置提供了一个新思路">方法三 目标值插入数组后在查找对于位置（提供了一个新思路）</h3>
      </li>
    </ul>
  </li>
  <li><strong>解题思路</strong>：
    <ul>
      <li>目标值插入数组中</li>
      <li>排序后在查询对于目标值的位置</li>
    </ul>
  </li>
  <li><strong>复杂度分析</strong>：
    <ul>
      <li>时间复杂度 $O(logN)))$ ，这里 $N$   是数组的长度，最差情况下遍历 目标值&gt;数组最后一个值</li>
      <li>空间复杂度 $O(1)$</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Solution</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">searchInsert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nums</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">target</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># 不管这个数在不在里面，直接append
</span>        <span class="n">nums</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="c1"># 然后再排序
</span>        <span class="n">nums</span><span class="p">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="c1"># 最后返回查找的index
</span>        <span class="k">return</span> <span class="n">nums</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

</code></pre></div></div>

<ul>
  <li><strong>如果你也发现了，请为自己点赞，顺便为小牛点赞👍支持</strong></li>
  <li><strong>如果发现在别处也有类似的例题，请在下面👇评论区告诉小牛</strong></li>
</ul>
</div><p><a href="/leetcode/2020/0620/001">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=leetcode">leetcode</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 20, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="leetcode-2020-0620-001">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-20T00:00:00+08:00">
    <meta itemprop="keywords" content="leetcode"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/jvm/Thread"><h2 itemprop="headline" class="item__header">多线程编程中的三个核心概念</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="多线程编程中的三个核心概念">多线程编程中的三个核心概念</h3>
<h4 id="原子性">原子性</h4>
<p>这一点，跟数据库事务的原子性概念差不多，即一个操作（有可能包含有多个子操作）要么全部执行（生效），要么全部都不执行（都不生效）。</p>

<p>关于原子性，一个非常经典的例子就是银行转账问题：比如A和B同时向C转账10万元。如果转账操作不具有原子性，A在向C转账时，读取了C的余额为20万，然后加上转账的10万，计算出此时应该有30万，但还未来及将30万写回C的账户，此时B的转账请求过来了，B发现C的余额为20万，然后将其加10万并写回。然后A的转账操作继续——将30万写回C的余额。这种情况下C的最终余额为30万，而非预期的40万。</p>

<h4 id="可见性终点这里能说明为什么线程不安全数据会被串改">可见性(终点，这里能说明为什么线程不安全，数据会被串改)</h4>
<p><strong>可见性是指，当多个线程并发访问共享变量时，一个线程对共享变量的修改，其它线程能够立即看到。可见性问题是好多人忽略或者理解错误的一点。</strong></p>

<p>CPU从主内存中读数据的效率相对来说不高，现在主流的计算机中，都有几级缓存。每个线程读取共享变量时，都会将该变量加载进其对应CPU的高速缓存里，修改该变量后，CPU会立即更新该缓存，但并不一定会立即将其写回主内存（实际上写回主内存的时间不可预期）。此时其它线程（尤其是不在同一个CPU上执行的线程）访问该变量时，从主内存中读到的就是旧的数据，而非第一个线程更新后的数据。
这一点是操作系统或者说是硬件层面的机制，所以很多应用开发人员经常会忽略。</p>

<h4 id="顺序性">顺序性</h4>
<p>顺序性指的是，程序执行的顺序按照代码的先后顺序执行。
以下面这段代码为例</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">started</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// 语句1</span>
<span class="kt">long</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span> <span class="c1">// 语句2</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// 语句3</span>
<span class="n">started</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// 语句4</span>
</code></pre></div></div>
<p>从代码顺序上看，上面四条语句应该依次执行，但实际上JVM真正在执行这段代码时，并不保证它们一定完全按照此顺序执行。</p>

<p>处理器为了提高程序整体的执行效率，可能会对代码进行优化，其中的一项优化方式就是调整代码顺序，按照更高效的顺序执行代码。</p>

<p>讲到这里，有人要着急了——什么，CPU不按照我的代码顺序执行代码，那怎么保证得到我们想要的效果呢？实际上，大家大可放心，CPU虽然并不保证完全按照代码顺序执行，但它会保证程序最终的执行结果和代码顺序执行时的结果一致。</p>
<h3 id="java如何解决多线程并发问题">Java如何解决多线程并发问题</h3>
<h4 id="java如何保证原子性">Java如何保证原子性</h4>
<h5 id="锁和同步">锁和同步</h5>

<p>常用的保证Java操作原子性的工具是锁和同步方法（或者同步代码块）。使用锁，可以保证同一时间只有一个线程能拿到锁，也就保证了同一时间只有一个线程能执行申请锁和释放锁之间的代码。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLock</span> <span class="o">()</span> <span class="o">{</span>
  <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
  <span class="k">try</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>与锁类似的是同步方法或者同步代码块。使用非静态同步方法时，锁住的是当前实例；使用静态同步方法时，锁住的是该类的Class对象；使用静态代码块时，锁住的是synchronized关键字后面括号内的对象。下面是同步代码块示例</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLock</span> <span class="o">()</span> <span class="o">{</span>
  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">anyObject</span><span class="o">){</span>
    <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>无论使用锁还是synchronized，本质都是一样，通过锁来实现资源的排它性，从而实际目标代码段同一时间只会被一个线程执行，进而保证了目标代码段的原子性。这是一种以牺牲性能为代价的方法。</p>
<h5 id="cascompare-and-swap">CAS（compare and swap）</h5>

<p>基础类型变量自增（i++）是一种常被新手误以为是原子操作而实际不是的操作。Java中提供了对应的原子操作类来实现该操作，并保证原子性，其本质是利用了CPU级别的CAS指令。由于是CPU级别的指令，其开销比需要操作系统参与的锁的开销小。AtomicInteger使用方法如下。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">numThreads</span><span class="o">;</span> <span class="n">b</span><span class="o">++)</span> <span class="o">{</span>
  <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">iteration</span><span class="o">;</span> <span class="n">a</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">atomicInteger</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<h4 id="java如何保证可见性">Java如何保证可见性</h4>

<p><strong>Java提供了volatile关键字来保证可见性。当使用volatile修饰某个变量时，它会保证对该变量的修改会立即被更新到内存中，并且将其它缓存中对该变量的缓存设置成无效，因此其它线程需要读取该值时必须从主内存中读取，从而得到最新的值。</strong></p>

<h4 id="java如何保证顺序性">Java如何保证顺序性</h4>
<p>上文讲过编译器和处理器对指令进行重新排序时，会保证重新排序后的执行结果和代码顺序执行的结果一致，所以重新排序过程并不会影响单线程程序的执行，却可能影响多线程程序并发执行的正确性。</p>

<p>Java中可通过volatile在一定程序上保证顺序性，另外还可以通过synchronized和锁来保证顺序性。</p>

<p>synchronized和锁保证顺序性的原理和保证原子性一样，都是通过保证同一时间只会有一个线程执行目标代码段来实现的。</p>

<p>除了从应用层面保证目标代码段执行的顺序性外，JVM还通过被称为happens-before原则隐式地保证顺序性。两个操作的执行顺序只要可以通过happens-before推导出来，则JVM会保证其顺序性，反之JVM对其顺序性不作任何保证，可对其进行任意必要的重新排序以获取高效率。</p>

<h4 id="happens-before原则先行发生原则">happens-before原则（先行发生原则）</h4>
<ul>
  <li>传递规则：如果操作1在操作2前面，而操作2在操作3前面，则操作1肯定会在操作3前发生。该规则说明了happens-before原则具有传递性</li>
  <li>锁定规则：一个unlock操作肯定会在后面对同一个锁的lock操作前发生。这个很好理解，锁只有被释放了才会被再次获取</li>
  <li>volatile变量规则：对一个被volatile修饰的写操作先发生于后面对该变量的读操作</li>
  <li>程序次序规则：一个线程内，按照代码顺序执行</li>
  <li>线程启动规则：Thread对象的start()方法先发生于此线程的其它动作</li>
  <li>线程终结原则：线程的终止检测后发生于线程中其它的所有操作</li>
  <li>线程中断规则： 对线程interrupt()方法的调用先发生于对该中断异常的获取</li>
  <li>对象终结规则：一个对象构造先于它的finalize发生</li>
</ul>

<h4 id="volatile适用场景">volatile适用场景</h4>

<p>volatile适用于不需要保证原子性，但却需要保证可见性的场景。一种典型的使用场景是用它修饰用于停止线程的状态标记。如下所示</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span> <span class="o">()</span> <span class="o">{</span>
  <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">while</span><span class="o">(</span><span class="n">isRunning</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">someOperation</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span> <span class="o">()</span> <span class="o">{</span>
  <span class="n">isRunning</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p>在这种实现方式下，即使其它线程通过调用stop()方法将isRunning设置为false，循环也不一定会立即结束。可以通过volatile关键字，保证while循环及时得到isRunning最新的状态从而及时停止循环，结束线程。</p>
<h3 id="面试题">面试题</h3>
<h4 id="线程安全十万个为什么">线程安全十万个为什么</h4>
<p>问：平时项目中使用锁和synchronized比较多，而很少使用volatile，难道就没有保证可见性？  <br />
答：锁和synchronized即可以保证原子性，也可以保证可见性。都是通过保证同一时间只有一个线程执行目标代码段来实现的。</p>

<p>问：锁和synchronized为何能保证可见性？   <br />
答：根据JDK 7的Java doc中对concurrent包的说明，一个线程的写结果保证对另外线程的读操作可见，只要该写操作可以由happen-before原则推断出在读操作之前发生。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The results of a write by one thread are guaranteed to be visible to a read by another thread only if the write operation happens-before the read operation. The synchronized and volatile constructs, as well as the Thread.start() and Thread.join() methods, can form happens-before relationships.
</code></pre></div></div>
<p>问：既然锁和synchronized即可保证原子性也可保证可见性，为何还需要volatile？</p>

<p>答：synchronized和锁需要通过操作系统来仲裁谁获得锁，开销比较高，而volatile开销小很多。因此在只需要保证可见性的条件下，使用volatile的性能要比使用锁和synchronized高得多。</p>

<p>问：既然锁和synchronized可以保证原子性，为什么还需要AtomicInteger这种的类来保证原子操作？</p>

<p>答：锁和synchronized需要通过操作系统来仲裁谁获得锁，开销比较高，而AtomicInteger是通过CPU级的CAS操作来保证原子性，开销比较小。所以使用AtomicInteger的目的还是为了提高性能。</p>

<p>问：还有没有别的办法保证线程安全</p>

<p>答：有。尽可能避免引起非线程安全的条件——共享变量。如果能从设计上避免共享变量的使用，即可避免非线程安全的发生，也就无须通过锁或者synchronized以及volatile解决原子性、可见性和顺序性的问题。</p>

<p>问：synchronized即可修饰非静态方式，也可修饰静态方法，还可修饰代码块，有何区别</p>

<p>答：synchronized修饰非静态同步方法时，锁住的是当前实例；synchronized修饰静态同步方法时，锁住的是该类的Class对象；synchronized修饰静态代码块时，锁住的是synchronized关键字后面括号内的对象。</p>
</div><p><a href="/jvm/Thread">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=jvm">jvm</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 20, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="jvm-2020-06-20-02">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-20T00:00:00+08:00">
    <meta itemprop="keywords" content="jvm"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/spring/bean"><h2 itemprop="headline" class="item__header">Spring中Bean的作用域、生命周期</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="bean的作用域">Bean的作用域</h3>
<p>　　Spring 3中为Bean定义了5中作用域，分别为singleton（单例）、prototype（原型）、request、session和global session，5种作用域说明如下：</p>
<ol>
  <li><strong>singleton</strong>：单例模式，Spring IoC容器中只会存在一个共享的Bean实例，无论有多少个Bean引用它，始终指向同一对象。Singleton作用域是Spring中的缺省作用域，也可以显示的将Bean定义为singleton模式，配置为：
<code class="language-plaintext highlighter-rouge">&lt;bean id="userDao" class="com.ioc.UserDaoImpl" scope="singleton"/&gt;</code></li>
  <li><strong>prototype</strong>:原型模式，每次通过Spring容器获取prototype定义的bean时，容器都将创建一个新的Bean实例，每个Bean实例都有自己的属性和状态，而singleton全局只有一个对象。根据经验，对有状态的bean使用prototype作用域，而对无状态的bean使用singleton作用域。</li>
  <li><strong>request</strong>：在一次Http请求中，容器会返回该Bean的同一实例。而对不同的Http请求则会产生新的Bean，而且该bean仅在当前Http Request内有效。
<code class="language-plaintext highlighter-rouge">&lt;bean id="loginAction" class="com.cnblogs.Login" scope="request"/&gt;</code> ，针对每一次Http请求，Spring容器根据该bean的定义创建一个全新的实例，且该实例仅在当前Http请求内有效，而其它请求无法看到当前请求中状态的变化，当当前Http请求结束，该bean实例也将会被销毁。</li>
  <li><strong>session</strong>：在一次Http Session中，容器会返回该Bean的同一实例。而对不同的Session请求则会创建新的实例，该bean实例仅在当前Session内有效。
<code class="language-plaintext highlighter-rouge">&lt;bean id="userPreference" class="com.ioc.UserPreference" scope="session"/&gt;</code>，同Http请求相同，每一次session请求创建新的实例，而不同的实例之间不共享属性，且实例仅在自己的session请求内有效，请求结束，则实例将被销毁。</li>
  <li><strong>global Session</strong>：在一个全局的Http Session中，容器会返回该Bean的同一个实例，仅在使用portlet context时有效。</li>
</ol>

<h3 id="bean的生命周期">Bean的生命周期</h3>
<p>　　经过如上对Bean作用域的介绍，接下来将在Bean作用域的基础上讲解Bean的生命周期。  <br />
　　Spring容器可以管理singleton作用域下Bean的生命周期，在此作用域下，Spring能够精确地知道Bean何时被创建，何时初始化完成，以及何时被销毁。而对于prototype作用域的Bean，Spring只负责创建，当容器创建了Bean的实例后，Bean的实例就交给了客户端的代码管理，Spring容器将不再跟踪其生命周期，并且不会管理那些被配置成prototype作用域的Bean的生命周期。Spring中Bean的生命周期的执行是一个很复杂的过程，读者可以利用Spring提供的方法来定制Bean的创建过程。Spring容器在保证一个bean实例能够使用之前会做很多工作：</p>

<p><img src="/assets/images/spring/0618/2018110145039276.png" alt="1" />
<img src="/assets/images/spring/0618/2018110145059598.png" alt="2" /></p>
</div><p><a href="/spring/bean">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=spring">spring</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jun 18, 2020</span>
            </li><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="spring-bean">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-18T00:00:00+08:00">
    <meta itemprop="keywords" content="spring"></div>
      </article><article class="item" itemscope itemtype="http://schema.org/BlogPosting"><div class="item__content">
          <header><a href="/java/io"><h2 itemprop="headline" class="item__header">在什么时候使用字节流、字符流</h2></a></header>
          <div class="item__description"><div class="article__content" itemprop="description articleBody"><h3 id="总结性陈述">总结性陈述</h3>
<h4 id="字节流fileinputstream和fileoutputstream">字节流（FileInputStream和FileOutputStream）</h4>
<ol>
  <li>InputStream 和OutputStream,两个是为字节流设计的,主要用来处理字节或二进制对象</li>
  <li>字节流处理单元为 <code class="language-plaintext highlighter-rouge">1个字节</code>，操作字节和字节数组。</li>
  <li><strong>如果是音频文件、图片、歌曲，就用字节流好点，所以它对多国语言支持性比较好！</strong>
    <h4 id="字符流filereader和filewriter">字符流（FileReader和FileWriter）</h4>
  </li>
  <li>Reader和 Writer.两个是为字符流（一个字符占两个字节）设计的,主要用来处理字符或字符串.</li>
  <li>字符流处理的单元为 <code class="language-plaintext highlighter-rouge">2个字节</code> 的Unicode字符，操作字符、字符数组或字符串</li>
  <li>所以字符流是由Java虚拟机将字节转化为2个字节的Unicode字符为单位的字符而成的。</li>
  <li><strong>如果是关系到中文（文本）的，用字符流好点</strong></li>
</ol>

<h4 id="缓冲区的使用">缓冲区的使用</h4>
<ol>
  <li>
    <p>字节流在操作时不会用到缓冲区（内存），是直接对文件本身进行操作的。</p>
  </li>
  <li>
    <p>而字符流在操作时使用了缓冲区，通过缓冲区再操作文件。</p>
  </li>
  <li>
    <p>在硬盘上的所有文件都是以字节形式存在的（图片，声音，视频），而字符值在内存中才会形成。（重点）</p>
  </li>
</ol>

<h4 id="增添知识点">增添知识点</h4>
<p>文章重点：字节流在操作的时候本身是不会用到缓冲区（内存）的，是与文件本身直接操作的，而字符流在操作的时候是使用到缓冲区的。</p>

<p>字节流在操作文件时，即使不关闭资源（close方法），文件也能输出，但是如果字符流不使用close方法的话，则不会输出任何内容，说明字符流用的是缓冲区，并且可以使用flush方法强制进行刷新缓冲区，这时才能在不close的情况下输出内容。</p>

<p>但是节流是最基本的，一个字符占两个字节就可以看出，甚至源码使用字符流的时候，也是先转成字节在变成字符，所以使用字节流的操作是最多的。</p>

<h4 id="上面两点能说明什么呢">上面两点能说明什么呢？</h4>

<ol>
  <li>
    <p>第一点，所有文件的储存是都是字节（byte）的储存，在磁盘上保留的并不是文件的字符而是先把字符编码成字节，再储存这些字节到磁盘。
在读取文件（特别是文本文件）时，也是一个字节一个字节地读取以形成字节序列</p>
  </li>
  <li>
    <p>第二点，我们知道，如果一个程序频繁对一个资源进行IO操作，效率会非常低。此时，通过缓冲区，先把需要操作的数据暂时放入内存中，以后直接从内存中读取数据，则可以避免多次的IO操作，提高效率</p>
  </li>
  <li>
    <p>第三点，真正存储和传输数据时都是以字节为单位的，字符只是存在与内存当中的，所以，<strong>字节流适用范围更为宽广</strong></p>
  </li>
</ol>

<h3 id="概念">概念</h3>

<p>在程序中所有的数据都是以流的方式进行传输或保存的，程序需要数据的时候要使用输入流读取数据，而当程序需要将一些数据保存起来的时候，就要使用输出流完成。</p>

<p><strong>程序中的输入输出都是以流的形式保存的，流中保存的实际上全都是字节文件。</strong></p>

<h4 id="字节流与字符流">字节流与字符流</h4>

<p>在java.io包中操作文件内容的主要有两大类：字节流、字符流，两类都分为输入和输出操作。在字节流中输出数据主要是使用OutputStream完成，输入使的是InputStream，在字符流中输出主要是使用Writer类完成，输入流主要使用Reader类完成。（这四个都是抽象类）</p>

<h4 id="操作流程">操作流程</h4>

<p>在Java中IO操作也是有相应步骤的，以文件操作为例，主要的操作流程如下：</p>

<ol>
  <li>使用File类打开一个文件</li>
  <li>通过字节流或字符流的子类，指定输出的位置</li>
  <li>进行读/写操作</li>
  <li>关闭输入/输出</li>
  <li>IO操作属于资源操作，一定要记得关闭</li>
</ol>

<h4 id="字节流">字节流</h4>
<p>字节流主要是操作byte类型数据，以byte数组为准，主要操作类就是OutputStream、InputStream</p>

<h5 id="字节输出流outputstream">字节输出流：OutputStream</h5>

<p>OutputStream是整个IO包中字节输出流的最大父类，此类的定义如下：</p>

<p>public abstract class OutputStream extends Object implements Closeable,Flushable</p>

<p>从以上的定义可以发现，此类是一个抽象类，如果想要使用此类的话，则首先必须通过子类实例化对象，那么如果现在要操作的是一个文件，则可以使用：FileOutputStream类。通过向上转型之后，可以为OutputStream实例化</p>

<p>Closeable表示可以关闭的操作，因为程序运行到最后肯定要关闭</p>

<p>Flushable：表示刷新，清空内存中的数据</p>

<p>FileOutputStream类的构造方法如下：</p>

<p>public FileOutputStream(File file)throws FileNotFoundException</p>

<p>写数据：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">OutputStream</span> <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span><span class="c1">//如果文件不存在会自动创建</span>
        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="s">"Hello World"</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span><span class="c1">//因为是字节流，所以要转化成字节数组进行输出</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>也可以一个字节一个字节进行输出，如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">OutputStream</span> <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span><span class="c1">//如果文件不存在会自动创建</span>
        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="s">"Hello World"</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>以上输出只会进行覆盖，如果要追加的话，请看FileOutputStream类的另一个构造方法：</p>

<p>public FileOutputStream(File file,boolean append)throws FileNotFoundException</p>

<p>在构造方法中，如果将append的值设置为true，则表示在文件的末尾追加内容。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">OutputStream</span> <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">f</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span><span class="c1">//追加内容</span>
        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="s">"\r\nHello World"</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>文件中换行为：\r\n</p>

<h5 id="字节输入流inputstream">字节输入流：InputStream</h5>

<p>既然程序可以向文件中写入内容，则就可以通过InputStream从文件中把内容读取进来，首先来看InputStream类的定义：</p>

<p>public abstract class InputStream extends Object implements Closeable</p>

<p>与OutputStream类一样，InputStream本身也是一个抽象类，必须依靠其子类，如果现在是从文件中读取，就用FileInputStream来实现。</p>

<p>观察FileInputStream类的构造方法：</p>

<p>public FileInputStream(File file)throws FileNotFoundException</p>

<p>读文件：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">InputStream</span> <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">len</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>但以上方法是有问题的，用不用开辟这么大的一个字节数组，明显是浪费嘛，我们可以根据文件的大小来定义字节数组的大小，File类中的方法：public long length()</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">InputStream</span> <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">f</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
        <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">b</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>我们换种方式，一个字节一个字节读入~</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">InputStream</span> <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[(</span><span class="kt">int</span><span class="o">)</span> <span class="n">f</span><span class="o">.</span><span class="na">length</span><span class="o">()];</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">b</span><span class="o">[</span><span class="n">i</span><span class="o">]=(</span><span class="kt">byte</span><span class="o">)</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">b</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>但以上情况只适合知道输入文件的大小，不知道的话用如下方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">InputStream</span> <span class="n">in</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">=</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">((</span><span class="n">temp</span><span class="o">=</span><span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">())!=-</span><span class="mi">1</span><span class="o">){</span><span class="c1">//-1为文件读完的标志</span>
            <span class="n">b</span><span class="o">[</span><span class="n">len</span><span class="o">]=(</span><span class="kt">byte</span><span class="o">)</span> <span class="n">temp</span><span class="o">;</span>
            <span class="n">len</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">len</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="字符流">字符流</h4>
<p>在程序中一个字符等于两个字节，那么java提供了Reader、Writer两个专门操作字符流的类。</p>

<h5 id="字符输出流writer">字符输出流：Writer</h5>

<p>Writer本身是一个字符流的输出类，此类的定义如下：</p>

<p>public abstract class Writer extends Object implements Appendable，Closeable，Flushable</p>

<p>此类本身也是一个抽象类，如果要使用此类，则肯定要使用其子类，此时如果是向文件中写入内容，所以应该使用FileWriter的子类。</p>

<p>FileWriter类的构造方法定义如下：</p>

<p>public FileWriter(File file)throws IOException</p>

<p>字符流的操作比字节流操作好在一点，就是可以直接输出字符串了，不用再像之前那样进行转换操作了。</p>

<p>写文件：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">Writer</span> <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="s">"Hello World"</span><span class="o">;</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>在默认情况下再次输出会覆盖，追加的方法也是在构造函数上加上追加标记</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Writer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">Writer</span> <span class="n">out</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">f</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span><span class="c1">//追加</span>
        <span class="nc">String</span> <span class="n">str</span><span class="o">=</span><span class="s">"\r\nHello World"</span><span class="o">;</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="字符输入流reader">字符输入流：Reader</h5>

<p>Reader是使用字符的方式从文件中取出数据，Reader类的定义如下：</p>

<p>public abstract class Reader extends Objects implements Readable，Closeable</p>

<p>Reader本身也是抽象类，如果现在要从文件中读取内容，则可以直接使用FileReader子类。</p>

<p>FileReader的构造方法定义如下：</p>

<p>public FileReader(File file)throws FileNotFoundException</p>

<p>以字符数组的形式读取出数据：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Reader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">Reader</span> <span class="n">input</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">c</span><span class="o">=</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="n">input</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">len</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>也可以用循环方式，判断是否读到底：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.Reader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"d:"</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">+</span><span class="s">"test.txt"</span><span class="o">);</span>
        <span class="nc">Reader</span> <span class="n">input</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
        <span class="kt">char</span><span class="o">[]</span> <span class="n">c</span><span class="o">=</span><span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span><span class="o">((</span><span class="n">temp</span><span class="o">=</span><span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">())!=-</span><span class="mi">1</span><span class="o">){</span>
            <span class="n">c</span><span class="o">[</span><span class="n">len</span><span class="o">]=(</span><span class="kt">char</span><span class="o">)</span> <span class="n">temp</span><span class="o">;</span>
            <span class="n">len</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="n">input</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">c</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">len</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
</div><p><a href="/java/io">Read more</a></p></div><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive.html?tag=io%E6%B5%81">io流</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-eye"></i> <span class="js-pageview" data-page-key="java-io-2020-06-18-01">0</span> views</li></ul></div><meta itemprop="author" content="java牛牛"/><meta itemprop="datePublished" content="2020-06-18T00:00:00+08:00">
    <meta itemprop="keywords" content="io流"></div>
      </article></div>
</div><div class="layout--home"><div class="pagination"><p>256 post articles, 32 pages.</p>
    <div class="pagination__menu">
      <ul class="menu menu--nowrap"><li><div class="button button--secondary button--circle disabled">
            <i class="fas fa-angle-left"></i>
          </div></li><li>
              <div class="button button--primary button--circle focus"><span>1</span></div>
            </li><li>
                  <a class="button button--secondary button--circle" href="/home/page2"><span>2</span></a>
                </li><li>
                  <a class="button button--secondary button--circle" href="/home/page3"><span>3</span></a>
                </li><li>
                  <a class="button button--secondary button--circle" href="/home/page4"><span>4</span></a>
                </li><li><span class="pagination__omit"><i class="fas fa-ellipsis-h"></i></span></li><li>
                  <a class="button button--secondary button--circle" href="/home/page32"><span>32</span></a>
                </li><li><a class="button button--secondary button--circle" href="/home/page2">
            <i class="fas fa-angle-right"></i>
          </a></li></ul>
    </div>
  </div></div>
<script>/*(function () {

})();*/
</script>



</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="java牛牛"><meta itemprop="url" content="/javaniuniu.com"><meta itemprop="description" content="I am an amazing person.
"><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><link itemprop="url" href="javaniuniu.com"><li title="Send me an Email.">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:king101125s@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a><li title="Follow me on Facebook.">
        <a class="button button--circle facebook-button" itemprop="sameAs" href="https://www.facebook.com/minplemon" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M767.428571 6.857143l0 150.857143-89.714286 0q-49.142857 0-66.285714 20.571429t-17.142857 61.714286l0 108 167.428571 0-22.285714 169.142857-145.142857 0 0 433.714286-174.857143 0 0-433.714286-145.714286 0 0-169.142857 145.714286 0 0-124.571429q0-106.285714 59.428571-164.857143t158.285714-58.571429q84 0 130.285714 6.857143z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Twitter.">
        <a class="button button--circle twitter-button" itemprop="sameAs" href="https://twitter.com/minplemon" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M1024.032 194.432c-37.664 16.704-78.176 28-120.672 33.088 43.36-26.016 76.672-67.168 92.384-116.224-40.608 24.064-85.568 41.568-133.408 50.976-38.336-40.832-92.928-66.336-153.344-66.336-116.032 0-210.08 94.048-210.08 210.08 0 16.48 1.856 32.512 5.44 47.872-174.592-8.768-329.408-92.416-433.024-219.52-18.08 31.04-28.448 67.104-28.448 105.632 0 72.896 37.088 137.184 93.472 174.88-34.432-1.088-66.816-10.528-95.168-26.272-0.032 0.864-0.032 1.76-0.032 2.656 0 101.792 72.416 186.688 168.512 205.984-17.632 4.8-36.192 7.36-55.36 7.36-13.536 0-26.688-1.312-39.52-3.776 26.72 83.456 104.32 144.192 196.256 145.888-71.904 56.352-162.496 89.92-260.928 89.92-16.96 0-33.664-0.992-50.112-2.944 92.96 59.616 203.392 94.4 322.048 94.4 386.432 0 597.728-320.128 597.728-597.76 0-9.12-0.192-18.176-0.608-27.168 41.056-29.632 76.672-66.624 104.832-108.736z" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/javaniuniu" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© JAVA 牛牛 2020, <a href="http://www.beian.miit.gov.cn/">浙ICP备20011288号</a>
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js'], function() {
    var $canvas = null, $this = null, _ctx = null, _text = '';
    $('.language-chart').each(function(){
      $this = $(this);
      $canvas = $('<canvas></canvas>');
      _text = $this.text();
      $this.text('').append($canvas);
      _ctx = $canvas.get(0).getContext('2d');
      (_ctx && _text) && (new Chart(_ctx, JSON.parse(_text)) && $this.attr('data-processed', true));
    });
  });
</script>
<script type="text/x-mathjax-config">
	var _config = { tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']]
	}};_config.TeX = { equationNumbers: { autoNumber: "all" } };MathJax.Hub.Config(_config);
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

